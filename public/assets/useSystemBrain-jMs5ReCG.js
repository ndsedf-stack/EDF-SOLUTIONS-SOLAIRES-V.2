import{r as f,s as _}from"./index-BsH0mrrn.js";function ae(e){const t=new Date(e),i=new Date().getTime()-t.getTime();return Math.floor(i/(1e3*60*60*24))}function Q(e){const t=e.views||0,r=e.clicks||0,i=e.send_count||0;return t===0&&r===0&&i>=4?"fatigue":t===0&&r===0?"muet":t>10?"cas_limite":t>=3&&r===0?"agite":r>=1?"interesse":"stable"}function Ye(e){let l=0;if(e.signed_at){const j=ae(e.signed_at);l=Math.min(j/14*100,100)}const D=e.total_price||0,R=Math.min(D/3e4*100,100),E=Q(e);let k=0;E==="stable"&&(k=0),E==="interesse"&&(k=20),E==="agite"&&(k=60),E==="muet"&&(k=80),E==="fatigue"&&(k=100),(e.send_count||0)>5&&(k=Math.min(k+20,100));const P=l*.5+R*.3+k*.2;return Math.min(100,Math.round(P))}const Fe=[];function Ke(){return Fe.filter(e=>e.outcome==="FAILURE")}function ze(){return Fe.filter(e=>e.outcome==="SUCCESS")}function $e(e){const t=Ke(),r=ze();if(t.length+r.length<5)return Math.min(100,Math.round(e.dangerScore));let i=0;i+=e.dangerScore*.5,i+=e.tensionLevel*.3,e.behavior==="muet"&&(i+=15),e.behavior==="agite"&&(i+=8);const l=t.length/(t.length+r.length);return i=i*(1+l),Math.min(100,Math.round(i))}const Ze=14,Qe=2e4,Je=1e4,Xe=5,et=2;function tt(e){return e.status!=="signed"||e.has_deposit!==!0||e.deposit_paid===!0||!e.signed_at?!1:ae(e.signed_at)<=Ze}function nt(e){return e.status!=="signed"?!1:e.has_deposit===!0&&e.deposit_paid===!1}function at(e){return e.status!=="signed"||e.has_deposit!==!0||e.deposit_paid===!0||!e.signed_at?!1:ae(e.signed_at)>10}function je(e){const t=Q(e);return t==="fatigue"?"STOP_AUTO_CALL":t==="muet"?"CALL":t==="agite"?"RELANCE":t==="interesse"?"ACCELERER":(e.dangerScore||0)>70?"CALL":"SURVEILLER"}function it(e){if(e.length===0)return null;const t=e[0],r=Q(t),i=je(t);let l="Dossier prioritaire";return r==="muet"?l="Client muet apr√®s signature, risque de d√©crochage":r==="fatigue"?l="Lead br√ªl√© : 0 interaction apr√®s relances multiples":r==="agite"?l="Client agit√©, consulte sans avancer":r==="interesse"&&(l="Client int√©ress√©, moment cl√© pour conclure"),t.dangerScore>70&&(l="Risque critique (temps + argent + comportement)"),{id:t.id,name:t.name,email:t.email,phone:t.phone,dangerScore:t.dangerScore,behavior:r,action:i,reason:l,daysSinceSigned:t.signed_at?ae(t.signed_at):null,total_price:t.total_price||0,requiresDeposit:t.requiresDeposit||!1,status:t.status,signed_at:t.signed_at,created_at:t.created_at,last_view:t.last_view}}function st(e){return e.slice(0,3).map((t,r)=>{const i=Q(t),l=je(t);let D="Suivi standard";return i==="muet"?D="Client muet, risque de d√©crochage":i==="agite"?D="Client agit√©, bloque mentalement":i==="interesse"&&(D="Client int√©ress√©, moment cl√©"),t.dangerScore>70&&(D="Risque critique (temps + argent + comportement)"),{rank:r+1,id:t.id,name:t.name,email:t.email,phone:t.phone,dangerScore:t.dangerScore,behavior:i,action:l,reason:D,total_price:t.total_price||0,requiresDeposit:t.requiresDeposit||!1,status:t.status,signed_at:t.signed_at,created_at:t.created_at,last_view:t.last_view}})}function ot(e,t){if(e.length===0&&t===0)return 0;let i=e.length>0?e.reduce((l,D)=>l+D.dangerScore,0)/e.length:0;return i+=e.length*5,i+=Math.min(t/5e3,30),Math.min(100,Math.round(i))}function rt(e){if(e.lateDepositCount>0)return"critical";const{actionNowCount:t,cashAtRisk:r,sentCount:i,signedCount:l}=e;return t>=Xe||r>Qe?"critical":t>=et||r>Je?"warning":i>=5||l>=3?"active":"stable"}function ct(e){const{tensionLevel:t,systemState:r,priorityActions:i}=e;return r==="critical"?{active:!0,level:"critical",message:"üö® SYST√àME SOUS PRESSION CRITIQUE",focus:i[0]||null}:t>70?{active:!0,level:"high",message:"‚ö†Ô∏è Forte tension d√©tect√©e",focus:i[0]||null}:t>40?{active:!0,level:"medium",message:"‚ö° Syst√®me sous tension",focus:i[0]||null}:{active:!1,level:"normal",message:"Syst√®me stable",focus:null}}function lt(e,t){if(!t||!t.warRoom||!t.finance)return{cashSecured:0,cashAtRisk:0,warRoomCA:0,securedCount:0,riskCount:0,warRoomCount:0,lateCount:0,lateNames:"‚Äî",nextDeadlineDate:"‚Äî",nextDeadlineClient:"‚Äî",caTotal:0,tauxConversion:0,cashWaitingDeposit:0,waitingDepositCount:0,cashCancellable:0,cancellableCount:0,cashAtFatigue:0,securedPotential:0};const r=new Date,i=e.filter(s=>s.status==="signed"),l=i.reduce((s,C)=>s+(C.total_price||0),0),D=i.filter(s=>s.contract_secured),R=D.reduce((s,C)=>s+(C.total_price||0),0),E=i.filter(s=>!s.contract_secured&&!s.deposit_paid&&s.has_deposit),k=E.reduce((s,C)=>s+(C.total_price||0),0),U=i.filter(s=>!s.contract_secured&&!(!s.deposit_paid&&s.has_deposit)),P=U.reduce((s,C)=>s+(C.total_price||0),0),j=t.behavioral.fatigues.reduce((s,C)=>s+(C.total_price||0),0),N=l,b=t.warRoom.studies,q=t.finance.cashAtRisk,B=t.warRoom.ca,L=b.filter(s=>{if(!s.signed_at)return!1;const C=new Date(s.signed_at);return Math.floor((r.getTime()-C.getTime())/864e5)>10&&!s.deposit_paid}),H=L.map(s=>s.name).join(", ")||"Aucun retard",A=U.filter(s=>s.signed_at).map(s=>({name:s.name,signedDate:new Date(s.signed_at),deadlineDate:new Date(new Date(s.signed_at).getTime()+336*60*60*1e3)})).sort((s,C)=>s.deadlineDate.getTime()-C.deadlineDate.getTime())[0],z=A?A.deadlineDate.toLocaleDateString("fr-FR"):"‚Äî",M=A?A.name:"Aucune √©ch√©ance proche",x=e.length>0?i.length/e.length*100:0;return{cashSecured:R,cashAtRisk:q,warRoomCA:B,securedCount:D.length,riskCount:b.length,warRoomCount:t.warRoom.studies.length,lateCount:L.length,lateNames:H,nextDeadlineDate:z,nextDeadlineClient:M,caTotal:l,tauxConversion:x,cashWaitingDeposit:k,waitingDepositCount:E.length,cashCancellable:P,cancellableCount:U.length,cashAtFatigue:j,securedPotential:N}}function dt(e){const t=e.filter(o=>o.status==="signed"),r=e.filter(o=>o.status==="sent"),i=t.filter(tt).map(o=>{const v=Ye(o),J=Q(o),X=o.signed_at?ae(o.signed_at):0;return{...o,dangerScore:v,behavior:J,daysLate:X,cancellationRisk:0}}).sort((o,v)=>v.dangerScore-o.dangerScore),l=i.map(o=>o.id),D=i.reduce((o,v)=>o+(v.total_price||0),0),R=t.filter(nt),E=t.filter(at),k=R.reduce((o,v)=>o+(v.total_price||0),0),U=ot(i,k),P=i.map(o=>({...o,cancellationRisk:$e({dangerScore:o.dangerScore,tensionLevel:U,behavior:o.behavior})})),j=it(P),N=st(P),b=[...P,...R.filter(o=>!l.includes(o.id)),...E.filter(o=>!l.includes(o.id)&&!R.find(v=>v.id===o.id))],q=e.map(o=>{const v=Q(o);return{...o,risk:v}}),B=q.filter(o=>o.risk==="muet"),L=q.filter(o=>o.risk==="agite"),H=q.filter(o=>o.risk==="interesse"),A=q.filter(o=>o.risk==="fatigue"),z=e.filter(o=>!l.includes(o.id)&&!R.find(v=>v.id===o.id)),M=rt({actionNowCount:b.length,cashAtRisk:k,sentCount:r.length,signedCount:t.length,lateDepositCount:E.length}),x=ct({tensionLevel:U,systemState:M,priorityActions:N}),s={signed:t,sent:r,healthy:z,lateDeposits:E,warRoom:{studies:P,count:P.length,ca:D},finance:{riskyDeposits:R,cashAtRisk:k},actionNow:b,behavioral:{muets:B,agites:L,interesses:H,fatigues:A},systemState:M,priorityCase:j,tensionLevel:U,priorityActions:N,urgencyMode:x},C=lt(e,s);return{...s,financialStats:C}}function ut(e){const t=e.views||0,r=e.clicks||0,i=e.send_count||0;if(t===0&&r===0&&i>=4)return{state:"FATIGUE",icon:"üò¥",label:"FATIGUE"};const l=Q(e);return l==="muet"?{state:"MUET",icon:"üßä",label:"SILENCE"}:l==="cas_limite"?{state:"CAS_LIMITE",icon:"‚ö†Ô∏è",label:"CAS LIMITE"}:l==="agite"?{state:"AGIT√â",icon:"üî•",label:"AGIT√â"}:l==="interesse"?{state:"INT√âRESS√â",icon:"üü¢",label:"INT√âRESS√â"}:{state:"STABLE",icon:"‚ö™",label:"STABLE"}}function _t(e,t,r={},i={}){var C,o,v,J,X,ce,ie,S,W,le,de,ue,_e,fe,me,pe,ge,ye;const l=e.id,D=((C=e.clients)==null?void 0:C.id)||"",R=r[String(l)]||r[String(D)],E=i[String(l)]||i[String(D)],k=(((o=R==null?void 0:R.sent)==null?void 0:o.length)||0)+(((v=E==null?void 0:E.sent)==null?void 0:v.length)||0);t||console.warn("‚ö†Ô∏è Pas de stats trouv√© pour study:",e.id,(J=e.clients)==null?void 0:J.email);const U=ae(e.created_at),P=new Date;let j=(t==null?void 0:t.email_opens)??(t==null?void 0:t.views)??(t==null?void 0:t.total_opens)??0,N=(t==null?void 0:t.interactions)??(t==null?void 0:t.clicks)??(t==null?void 0:t.total_clicks)??0;(ce=(X=e.clients)==null?void 0:X.last_name)!=null&&ce.toUpperCase().includes("GUYOT")&&console.log(`üìä Study ${(ie=e.clients)==null?void 0:ie.first_name} ${(S=e.clients)==null?void 0:S.last_name}:`,{id:e.id,views:j,clicks:N,stat_found:!!t,stat_data:t});const b=e.total_price||e.install_cost||((W=e.study_data)==null?void 0:W.installCost)||0,q=e.cash_apport??((le=e.study_data)==null?void 0:le.cashApport)??0;let B,L;q>=b&&b>0?(B="cash",L="cash_payment"):q>0&&q<b?(B="financing",L="partial_financing"):(B="financing",L="full_financing"),e.payment_mode&&(B=e.payment_mode),e.financing_mode&&(L=e.financing_mode);const H=L==="cash_payment"||L==="partial_financing";(ue=(de=e.clients)==null?void 0:de.last_name)!=null&&ue.toUpperCase().includes("DUCHENE")&&console.log("üîç MAPPERS DEBUG DUCHENE:",{name:`${(_e=e.clients)==null?void 0:_e.first_name} ${(fe=e.clients)==null?void 0:fe.last_name}`,apport:q,totalCost:b,mode:B,financingMode:L,requiresDepositCalc:H,db_has_deposit:e.has_deposit,db_deposit_amount:e.deposit_amount});const A=e.signed_at?Math.floor((P.getTime()-new Date(e.signed_at).getTime())/864e5):null,z=!e.signed_at||e.status!=="signed"||e.deposit_paid||!H?!1:A!==null&&A>0,M={id:e.id,client_id:((me=e.clients)==null?void 0:me.id)||"",name:e.clients?`${e.clients.first_name||""} ${e.clients.last_name||""}`.trim():"Inconnu",email:((pe=e.clients)==null?void 0:pe.email)||"Pas d'email",phone:(ge=e.clients)==null?void 0:ge.phone,status:e.status,created_at:e.created_at,signed_at:e.signed_at,study_data:e.study_data,deposit_amount:e.deposit_amount||0,deposit_paid:e.deposit_paid||!1,deposit_paid_at:e.deposit_paid_at,payment_mode:B,payment_type:e.payment_type||null,financing_mode:L,has_deposit:H||e.has_deposit,cash_apport:q,total_price:b,install_cost:e.install_cost||0,contract_secured:e.status==="signed"&&(A!==null&&A>=14||e.deposit_paid||!1),cancellation_deadline:e.cancellation_deadline||null,revenue_secured:e.status==="signed"?b:0,revenue_projected:b,revenue_gap:e.status!=="signed"?b:0,views:j,clicks:N,diffDays:Math.floor(U),hasLog:!1,rib_sent:e.rib_sent||!1,rib_sent_at:e.rib_sent_at,email_optout:((ye=e.clients)==null?void 0:ye.email_optout)||!1,last_open:(t==null?void 0:t.last_open)||(t==null?void 0:t.last_open_at)||(t==null?void 0:t.last_email_open)||null,last_click:(t==null?void 0:t.last_click)||(t==null?void 0:t.last_click_at)||null,last_view:(t==null?void 0:t.last_view)||null,requiresDeposit:H,daysLate:A||0,daysSinceSigned:A,isDepositLate:z,behavioralState:void 0,behavioralIcon:void 0,behavioralLabel:void 0,send_count:k},x=ut(M);M.behavioralState=x.state;let s=M.dangerScore||0;if(s===0){const se=j||0,Se=N||0,a=Math.max(A||0,U||0);x.state==="MUET"?s=65+Math.min(a,20):x.state==="FATIGUE"?s=85+Math.min(a,15):x.state==="AGIT√â"?s=45+Math.min(se*2,20):x.state==="CAS_LIMITE"?s=30+Math.min(a,10):x.state==="INT√âRESS√â"?s=18+Math.min(a,12)-Math.min(Se*2,10)+Math.min(se,5):s=5+Math.min(se,7);const c=parseInt(M.id.slice(0,2),16)%5-2;s+=c}return M.cancellationRisk=$e({dangerScore:Math.max(5,Math.min(98,s)),tensionLevel:M.status==="signed"?50:30,behavior:x.state}),M.dangerScore=s,M}function Dt(e){return e.status==="signed"?"signed":e.clicks>0?"hot":e.views>=2?"warm":"cold"}const I=[];for(let e=0;e<256;++e)I.push((e+256).toString(16).slice(1));function ft(e,t=0){return(I[e[t+0]]+I[e[t+1]]+I[e[t+2]]+I[e[t+3]]+"-"+I[e[t+4]]+I[e[t+5]]+"-"+I[e[t+6]]+I[e[t+7]]+"-"+I[e[t+8]]+I[e[t+9]]+"-"+I[e[t+10]]+I[e[t+11]]+I[e[t+12]]+I[e[t+13]]+I[e[t+14]]+I[e[t+15]]).toLowerCase()}let Ee;const mt=new Uint8Array(16);function pt(){if(!Ee){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Ee=crypto.getRandomValues.bind(crypto)}return Ee(mt)}const gt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ne={randomUUID:gt};function yt(e,t,r){var l;e=e||{};const i=e.random??((l=e.rng)==null?void 0:l.call(e))??pt();if(i.length<16)throw new Error("Random bytes length must be >= 16");return i[6]=i[6]&15|64,i[8]=i[8]&63|128,ft(i)}function St(e,t,r){return Ne.randomUUID&&!e?Ne.randomUUID():yt(e)}const ht=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():St(),wt=e=>new Promise((t,r)=>setTimeout(()=>r(new Error(`Timeout Supabase after ${e}ms`)),e));async function ke(e,t=15e3){return Promise.race([e,wt(t)])}function Et(){const[e,t]=f.useState([]),[r,i]=f.useState([]),[l,D]=f.useState([]),[R,E]=f.useState(null),[k,U]=f.useState(!0),[P,j]=f.useState(null),[N,b]=f.useState(!1),[q,B]=f.useState(null),[L,H]=f.useState({}),[A,z]=f.useState({}),[M,x]=f.useState({}),[s,C]=f.useState([]),[o,v]=f.useState(0),[J,X]=f.useState(""),ce=f.useCallback(async()=>{if(N)return;const a=[{progress:15,text:"Connexion Supabase...",duration:800},{progress:35,text:"Chargement dossiers...",duration:1e3},{progress:60,text:"Analyse m√©triques...",duration:900},{progress:85,text:"Calcul risques...",duration:800},{progress:100,text:"Syst√®me pr√™t !",duration:700}];for(let c=0;c<a.length;c++){const u=a[c];await new Promise(g=>setTimeout(g,u.duration)),v(u.progress),X(u.text)}await new Promise(c=>setTimeout(c,500)),b(!0)},[N]),ie=async(a,c,u,g="*",h)=>{const F=[];for(let O=0;O<u.length;O+=800){const V=u.slice(O,O+800);let Y=_.from(a).select(g).in(c,V);h&&(Y=Y.order(h.col,{ascending:h.ascending}));const{data:y,error:ee}=await ke(Y);if(ee)throw ee;y&&F.push(...y)}return{data:F,error:null}},S=f.useCallback(async(a=!1)=>{try{a||U(!0),B(null);const c=_.from("decision_logs").select("*").order("created_at",{ascending:!1}).limit(50),u=ke(_.from("studies").select(`
            id, client_id, status, created_at, signed_at, study_data,
            deposit_amount, deposit_paid, deposit_paid_at, has_deposit,
            payment_type, payment_mode, cash_apport,
            total_price: install_cost, financing_mode, contract_secured, cancellation_deadline,
            clients (id, first_name, last_name, email, phone, email_optout)
        `)),[g,h]=await Promise.all([c,u]),{data:T,error:F}=h,O=g.data||[];if(g.error&&console.error("Logs fetch failed",g.error),D(O),F)throw F;const V=(T||[]).map(n=>n.id),Y=(T||[]).map(n=>n.client_id).filter(Boolean),y=V.length>0?ie("tracking_events","study_id",V,"study_id, event_type, created_at"):Promise.resolve({data:[]}),ee=Y.length>0?ie("email_queue","client_id",Y,"study_id, client_id, email_type, status, sent_at, scheduled_for, created_at",{col:"created_at",ascending:!1}):Promise.resolve({data:[]}),[$,he]=await Promise.allSettled([y,ee]),ve=$.status==="fulfilled"?$.value.data||[]:[];$.status==="rejected"&&console.error("Tracking fetch failed",$.reason);const Ie=he.status==="fulfilled"?he.value.data||[]:[];he.status==="rejected"&&console.error("Queue fetch failed",he.reason);const we=new Map,oe={},be=new Map;ve.forEach(n=>{if(!n.study_id)return;we.has(n.study_id)||(we.set(n.study_id,{id:n.study_id,email_opens:0,interactions:0,last_open_at:null,last_click_at:null}),oe[n.study_id]={total_opens:0},be.set(n.study_id,new Set));const d=we.get(n.study_id),w=oe[n.study_id],p=be.get(n.study_id),m=new Date(n.created_at).toISOString().substring(0,16);if(n.event_type==="email_open"||n.event_type==="view")p.has(m)||(d.email_opens++,w.total_opens++,p.add(m)),(!d.last_open_at||n.created_at>d.last_open_at)&&(d.last_open_at=n.created_at,w.last_open=n.created_at);else if(n.event_type==="email_click"||n.event_type==="click"){const G=`click-${m}`;p.has(G)||(d.interactions++,p.add(G)),(!d.last_click_at||n.created_at>d.last_click_at)&&(d.last_click_at=n.created_at,w.last_click=n.created_at)}});const Ge=Array.from(we.values()),Ae={};(T||[]).forEach(n=>{n.client_id&&(Ae[n.client_id]=n.id)});const Ce={},De={};Ie.forEach(n=>{var ne,Me,Ue,qe,Pe,Be,xe;const d=n.study_id||(n.client_id?Ae[n.client_id]:null);if(!d)return;const w={...n,opened_at:((ne=oe[d])==null?void 0:ne.last_open)||null,clicked_at:((Me=oe[d])==null?void 0:Me.last_click)||null},m=((Ue=n.email_type)==null?void 0:Ue.startsWith("post_refus"))||((qe=n.email_type)==null?void 0:qe.includes("relance"))||((Pe=n.email_type)==null?void 0:Pe.includes("prospecting"))?De:Ce;m[d]||(m[d]={sent:[],next:null,total_opens:((Be=oe[d])==null?void 0:Be.total_opens)||0});const G=["sent","SUCCESS","success","delivered","processed"].includes(((xe=n.status)==null?void 0:xe.toLowerCase())||""),te=["pending","scheduled","PENDING"].includes(n.status||"");if(G)m[d].sent.push(w);else if(te){const Oe=m[d].next;(!Oe||new Date(n.scheduled_for)<new Date(Oe.scheduled_for))&&(m[d].next=w)}n.client_id&&(m[String(n.client_id)]=m[d])}),[Ce,De].forEach(n=>{Object.keys(n).forEach(d=>{n[d].sent.sort((w,p)=>new Date(w.sent_at).getTime()-new Date(p.sent_at).getTime())})}),z(Ce),x(De);const Te=(T||[]).map(n=>{var te;const w=(te=(Array.isArray(n.clients)?n.clients:n.clients?[n.clients]:[])[0])==null?void 0:te.id,p=w?r.find(ne=>ne.client_id===w):null,m=Ge.find(ne=>ne.id===n.id)||{id:n.id,email_opens:0,interactions:0},G={...m,email_opens:m.email_opens>0?m.email_opens:(p==null?void 0:p.total_opens)||0,interactions:m.interactions>0?m.interactions:(p==null?void 0:p.total_clicks)||0,last_open:m.last_open_at||(p==null?void 0:p.last_opened_at),last_click:m.last_click_at||(p==null?void 0:p.last_clicked_at)};return _t(n,G,Ce,De)});t(Te);const K=dt(Te);if(E(K),j(K.financialStats),K.priorityCase){const n=ht();try{await _.from("decision_logs").insert({id:n,study_id:K.priorityCase.id,created_at:new Date().toISOString(),action_performed:`PRIORITY_FLAG_${K.priorityCase.action.toUpperCase().replace(/\s+/g,"_")}`,justification:JSON.stringify({danger:K.priorityCase.dangerScore,behavior:K.priorityCase.behavior,state:K.systemState})})}catch(d){console.warn("Log failed:",d)}}const He=14,Z=new Map,We=new Date;for(let n=He-1;n>=0;n--){const d=new Date;d.setDate(We.getDate()-n);const w=d.toISOString().split("T")[0];Z.set(w,{date:w,count:0,opened:0,clicked:0})}const re=new Map;Ie.forEach(n=>{var w;if(["sent","SUCCESS","success","delivered","processed"].includes(((w=n.status)==null?void 0:w.toLowerCase())||"")&&n.sent_at&&n.study_id){const p=new Date(n.sent_at).getTime();re.has(n.study_id)||re.set(n.study_id,[]),re.get(n.study_id).push(p);const m=new Date(n.sent_at).toISOString().split("T")[0];Z.has(m)&&Z.get(m).count++}}),re.forEach(n=>n.sort((d,w)=>d-w));const Re=new Set,Le=new Set;ve.forEach(n=>{if(!n.study_id||!n.created_at)return;const d=new Date(n.created_at).getTime(),w=re.get(n.study_id);if(!w)return;const p=[...w].reverse().find(te=>te<=d);if(!p)return;const m=new Date(p).toISOString().split("T")[0];if(!Z.has(m))return;const G=`${n.study_id}-${m}`;(n.event_type==="email_open"||n.event_type==="view")&&(Re.has(G)||(Re.add(G),Z.get(m).opened++)),(n.event_type==="email_click"||n.event_type==="click")&&(Le.has(G)||(Le.add(G),Z.get(m).clicked++))});const Ve=Array.from(Z.values()).sort((n,d)=>n.date.localeCompare(d.date));C(Ve)}catch(c){console.error("‚ùå System Brain Error:",c),B(c.message)}finally{U(!1)}},[r]),W=f.useCallback(async()=>{try{const{data:a,error:c}=await ke(_.from("email_leads").select(`
          id, client_id, created_at, last_email_sent_at, next_email_scheduled_at,
          email_step, total_opens, total_clicks, last_opened_at, last_clicked_at,
          clients!inner(id, first_name, last_name, email, email_optout)
        `).order("next_email_scheduled_at",{ascending:!0}));if(c)throw c;const u=a.map(y=>y.client_id).filter(Boolean),{data:g}=await _.from("studies").select("id, client_id").in("client_id",u),h={};(g||[]).forEach(y=>{y.client_id&&(h[y.client_id]=y.id)});const T=Object.values(h).filter(Boolean);let F={},O={};if(T.length>0){const{data:y}=await _.from("tracking_events").select("study_id, created_at").in("study_id",T).in("event_type",["email_open","view"]);(y||[]).forEach($=>{F[$.study_id]||(F[$.study_id]=$.created_at)});const{data:ee}=await _.from("tracking_events").select("study_id, created_at").in("study_id",T).in("event_type",["email_click","click"]);(ee||[]).forEach($=>{O[$.study_id]||(O[$.study_id]=$.created_at)})}const V=(a||[]).map(y=>le(y,h,F,O));i(V);const Y={};V.forEach(y=>{Y[y.client_id]={step:y.email_sequence_step,last:y.last_email_sent,next:y.next_email_date,opens:y.total_opens,clicks:y.total_clicks,opted_out:y.opted_out,last_opened:y.last_opened_at,last_clicked:y.last_clicked_at}}),H(Y)}catch(a){console.error(a)}},[]);function le(a,c,u,g){var T,F,O,V;const h=c[a.client_id]||null;return{id:a.id,client_id:a.client_id,study_id:h,client_name:`${((T=a.clients)==null?void 0:T.first_name)||""} ${((F=a.clients)==null?void 0:F.last_name)||""}`.trim(),client_email:((O=a.clients)==null?void 0:O.email)||"",opted_out:((V=a.clients)==null?void 0:V.email_optout)||!1,email_sequence_step:a.email_step||0,last_email_sent:a.last_email_sent_at,next_email_date:a.next_email_scheduled_at,total_opens:a.total_opens||0,total_clicks:a.total_clicks||0,last_opened_at:h?u[h]:a.last_opened_at,last_clicked_at:h?g[h]:a.last_clicked_at,created_at:a.created_at}}const de=f.useCallback(async(a,c,u,g="Manuel")=>{const{error:h}=await _.from("studies").update({status:c,signed_at:c==="signed"?new Date().toISOString():null}).eq("id",a);h||(await _.from("decision_logs").insert({study_id:a,client_name:u,action_performed:`STATUS_CHANGE_${c.toUpperCase()}`,justification:g}),S())},[S]),ue=f.useCallback(async(a,c)=>{const{error:u}=await _.from("studies").update({status:"signed",signed_at:new Date().toISOString()}).eq("id",a);return u?(console.error("Erreur signature",u),!1):(await S(!0),!0)},[S]),_e=f.useCallback(async(a,c,u="Annulation Manuelle")=>{const{data:g}=await _.from("studies").select("study_data").eq("id",a).single(),h={...g==null?void 0:g.study_data,cancellation_reason:u},{error:T}=await _.from("studies").update({status:"cancelled",study_data:h}).eq("id",a);return T?(console.error("Erreur annulation",T),!1):(await _.from("decision_logs").insert({study_id:a,client_name:c,action_performed:"CANCEL_STUDY",justification:u}),await S(!0),!0)},[S]),fe=f.useCallback(async(a,c,u="virement")=>{let g;try{g=(await _.from("studies").update({deposit_paid:!0,deposit_paid_at:new Date().toISOString(),deposit_payment_mode:u.toLowerCase().trim()}).eq("id",a)).error}catch{g=(await _.from("studies").update({deposit_paid:!0,deposit_paid_at:new Date().toISOString()}).eq("id",a)).error}if(g)return console.error("Erreur paiement",g),!1;try{await _.from("decision_logs").insert({study_id:a,client_name:c,action_performed:"DEPOSIT_PAID_CONFIRMED",justification:`Mode: ${u}`})}catch(h){console.warn("Log failed",h)}return await S(!0),!0},[S]),me=f.useCallback(async(a,c)=>{const{error:u}=await _.from("studies").update({rib_sent:!0,rib_sent_at:new Date().toISOString()}).eq("id",a);u?alert("‚ùå Erreur : "+u.message):(await _.from("decision_logs").insert({study_id:a,client_name:c,action_performed:"RIB_SENT_CONFIRMED",justification:"RIB marqu√© comme envoy√©"}),alert("‚úÖ RIB marqu√© comme envoy√© !"),S())},[S]),pe=f.useCallback(async a=>{const{data:c}=await _.from("clients").update({email_optout:!0}).eq("email",a).select();if(!c||c.length===0){alert("‚ùå ERREUR : Aucun client trouv√© avec cet email");return}await _.from("email_queue").update({status:"cancelled"}).eq("client_id",c[0].id).in("status",["pending","scheduled"]),await _.from("decision_logs").insert({client_name:`${c[0].first_name} ${c[0].last_name}`,action_performed:"EMAIL_OPTOUT",justification:"D√©sabonnement depuis dashboard"}),alert("‚úÖ Client d√©sabonn√© avec succ√®s !"),W(),S()},[S,W]),ge=f.useCallback(async(a,c,u)=>{await _.from("studies").delete().eq("client_id",a),await _.from("email_queue").delete().eq("client_id",a),await _.from("email_leads").delete().eq("client_id",a),await _.from("clients").delete().eq("id",a),await _.from("decision_logs").insert({action_performed:"LEAD_DELETED_PERMANENTLY",client_name:u,justification:`Suppression d√©finitive ${c}`}),alert("‚úÖ Lead supprim√© d√©finitivement"),S(),W()},[S,W]),ye=f.useCallback(async(a,c)=>{await _.from("studies").delete().eq("id",a),await _.from("decision_logs").insert({client_name:c,action_performed:"DELETE_STUDY",justification:"Suppression d√©finitive"}),S()},[S]),se=f.useCallback(async(a,c,u,g)=>{await _.from("decision_logs").insert({study_id:a,client_name:c,action_performed:u,justification:g})},[]),Se=f.useCallback((a=!1)=>{S(a),W()},[S,W]);return f.useEffect(()=>{ce(),S(),W();const a=setInterval(()=>{Se(!0)},6e4);return()=>clearInterval(a)},[]),f.useEffect(()=>{r.length>0&&S(!0)},[r]),{studies:e,emailLeads:r,logs:l,metrics:R,financialStats:P,loading:k,systemInitialized:N,loadingProgress:o,loadingStep:J,error:q,emailFlowByClient:L,antiAnnulationByStudy:A,postRefusByStudy:M,trafficData:s,actions:{updateStudyStatus:de,signStudy:ue,cancelStudy:_e,markDepositPaid:fe,markRibSent:me,setOptOut:pe,deleteLeadPermanently:ge,deleteStudy:ye,logForceAction:se,refresh:Se}}}export{Dt as a,dt as b,ut as g,Et as u};
