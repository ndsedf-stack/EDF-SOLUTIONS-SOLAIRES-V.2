<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>AUTOPILOTE SOLAIRE - Nicolas Di Stefano</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
        background-color: #05050f;
        color: white;
        font-family: sans-serif;
        transition: all 0.4s ease;
      }
      .glass {
        background: rgba(15, 17, 26, 0.7);
        backdrop-filter: blur(10px);
      }
      .anomaly-card {
        background: rgba(239, 68, 68, 0.05);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }
      .stable-glow {
        text-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
      }

      /* MODE CALME CSS */
      body.mode-zen .anomaly-card {
        border-color: rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.02);
      }
      body.mode-zen .text-red-500,
      body.mode-zen .text-orange-400,
      body.mode-zen .text-orange-500 {
        color: #94a3b8 !important;
      }
      body.mode-zen .bg-red-500,
      body.mode-zen .bg-orange-500,
      body.mode-zen .bg-emerald-500 {
        background-color: #475569 !important;
        color: white !important;
      }
      body.mode-zen .border-emerald-500,
      body.mode-zen .border-red-500 {
        border-color: #334155 !important;
      }

      select {
        background: transparent;
        border: none;
        color: inherit;
        cursor: pointer;
        appearance: none;
        text-align: center;
        outline: none;
      }

      .tooltip {
        position: relative;
        display: inline-block;
      }
      .tooltip .tooltiptext {
        visibility: hidden;
        width: 120px;
        background-color: black;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 10;
        bottom: 125%;
        left: 50%;
        margin-left: -60px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 10px;
        font-weight: bold;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      dialog::backdrop {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
      }
      dialog[open] {
        display: flex;
        flex-direction: column;
      }

      /* STYLE AJOUT√â POUR LE CONFORT EXPLICATIF */
      .rule-box {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 8px;
        padding: 10px;
        margin-top: 8px;
        font-family: monospace;
        font-size: 10px;
        color: #94a3b8;
        border: 1px solid rgba(255, 255, 255, 0.05);
        text-align: left;
      }
    </style>
  </head>
  <body class="p-6">
    <div class="max-w-7xl mx-auto">
      <div class="mb-10 flex justify-between items-start">
        <div>
          <h1
            class="text-4xl font-[900] tracking-tighter uppercase text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-500"
          >
            Autopilote Solaire
          </h1>
          <div
            id="system-status"
            class="mt-2 text-[11px] font-medium text-slate-400 uppercase tracking-widest flex items-center gap-2"
          ></div>
        </div>
        <div class="flex gap-3">
          <button
            onclick="toggleZen()"
            id="btn-zen"
            class="px-4 py-2 rounded-xl border border-slate-700 text-slate-400 font-bold uppercase text-[10px] tracking-widest hover:bg-white/5 transition-all"
          >
            üïäÔ∏è Mode Calme
          </button>
          <button
            onclick="togglePriority()"
            id="btn-priority"
            class="px-6 py-2 rounded-xl border border-orange-500/30 text-orange-500 font-black hover:bg-orange-500/10 transition-all uppercase text-[10px] tracking-widest"
          >
            ‚ö†Ô∏è Mode Priorit√©
          </button>
          <div
            class="px-4 py-1 bg-emerald-500/10 border border-emerald-500/20 rounded-full flex items-center"
          >
            <span class="text-[10px] font-black uppercase text-emerald-400"
              ><span id="row-count">0</span> Dossiers</span
            >
          </div>
        </div>
      </div>

      <div id="anomaly-zone" class="mb-12 hidden">
        <h2
          class="text-red-500 text-[10px] font-black uppercase tracking-[0.3em] mb-4 italic"
        >
          üö® √âtudes √† surveiller (Risques d√©tect√©s)
        </h2>
        <div
          id="anomaly-list"
          class="grid grid-cols-1 md:grid-cols-3 gap-4"
        ></div>
      </div>

      <div
        id="calm-zone"
        class="mb-12 py-10 text-center glass border border-emerald-500/20 rounded-3xl hidden"
      >
        <div class="text-emerald-400 text-5xl font-black stable-glow mb-2">
          üü¢ SYST√àME STABLE
        </div>
        <p
          id="system-info-calm"
          class="text-slate-500 text-xs uppercase tracking-widest"
        >
          Aucune anomalie d√©tect√©e sur les r√©glages actuels
        </p>
      </div>

      <div
        class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-10 opacity-50 hover:opacity-100 transition-opacity"
      >
        <div class="glass border border-slate-800/50 rounded-2xl p-6">
          <div
            class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest italic"
          >
            Dossiers Totaux
          </div>
          <div class="text-5xl font-black" id="stat-total">0</div>
        </div>
        <div class="glass border border-slate-800/50 rounded-2xl p-6">
          <div
            class="text-[10px] font-black text-blue-400 uppercase mb-4 tracking-widest italic"
          >
            En cours (SENT)
          </div>
          <div class="text-5xl font-black text-blue-400" id="stat-sent">0</div>
        </div>
        <div
          class="glass border border-emerald-500/20 rounded-2xl p-6 border-emerald-500/30"
        >
          <div
            class="text-[10px] font-black text-emerald-400 uppercase mb-4 tracking-widest italic"
          >
            Sign√©s (NET)
          </div>
          <div class="text-5xl font-black text-emerald-400" id="stat-signed">
            0
          </div>
        </div>
        <div class="glass border border-orange-500/20 rounded-2xl p-6">
          <div
            class="text-[10px] font-black text-orange-400 uppercase mb-4 tracking-widest italic"
          >
            File Attente
          </div>
          <div class="text-5xl font-black text-orange-400" id="stat-queue">
            0
          </div>
        </div>
      </div>

      <div
        class="glass border border-slate-800/50 rounded-3xl overflow-hidden shadow-2xl"
      >
        <table class="w-full text-left border-collapse">
          <thead
            class="bg-black/40 text-slate-500 text-[9px] font-black uppercase tracking-[0.2em]"
          >
            <tr>
              <th class="p-6">Dossier Client</th>
              <th class="p-6 text-center">Engagement (Vues/Clics)</th>
              <th class="p-6 text-center">Statut Actuel</th>
              <th class="p-6 text-right">Actions Rapides</th>
            </tr>
          </thead>
          <tbody id="table-body" class="divide-y divide-slate-800/30"></tbody>
        </table>
      </div>

      <div class="mt-16">
        <h2
          class="text-slate-500 text-[10px] font-black uppercase tracking-[0.3em] mb-6"
        >
          üìß Suivi Autopilote Leads Email
        </h2>
        <div
          id="email-today-indicator"
          class="mb-4 text-[10px] font-black uppercase tracking-widest text-orange-400 hidden"
        >
          üîî <span id="email-today-count">0</span> relance(s) automatique(s)
          pr√©vue(s) aujourd‚Äôhui
        </div>
        <div
          class="glass border border-slate-800/50 rounded-3xl overflow-hidden"
        >
          <table class="w-full text-left border-collapse">
            <thead
              class="bg-black/40 text-slate-500 text-[9px] font-black uppercase tracking-[0.2em]"
            >
              <tr>
                <th class="p-4">Lead</th>
                <th class="p-4 text-center">Dernier email</th>
                <th class="p-4 text-center">Prochaine relance</th>
                <th class="p-4 text-center">Opt-out</th>
              </tr>
            </thead>
            <tbody
              id="leads-email-body"
              class="divide-y divide-slate-800/30"
            ></tbody>
          </table>
        </div>
      </div>

      <div class="mt-12 mb-10">
        <h2
          class="text-slate-500 text-[10px] font-black uppercase tracking-[0.3em] mb-6 flex items-center gap-2"
        >
          <span class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></span>
          Journal des For√ßages (Bo√Æte Noire)
        </h2>
        <div
          class="glass border border-slate-800/50 rounded-3xl overflow-hidden"
        >
          <div
            id="logs-container"
            class="max-h-[300px] overflow-y-auto divide-y divide-slate-800/30"
          >
            <div
              class="p-6 text-center text-slate-600 text-xs uppercase tracking-widest italic"
            >
              Chargement des archives...
            </div>
          </div>
        </div>
      </div>
    </div>

    <dialog
      id="override-modal"
      class="glass border border-slate-700 p-8 rounded-3xl text-white outline-none"
    >
      <div class="max-w-md">
        <h3 class="text-xl font-black text-orange-400 uppercase italic mb-2">
          ‚ö†Ô∏è For√ßage Manuel
        </h3>
        <p class="text-[10px] text-slate-400 mb-4 uppercase tracking-widest">
          Une anomalie bloque cette action. Justifiez le d√©verrouillage :
        </p>
        <div class="flex flex-wrap gap-2 mb-4">
          <button
            onclick="setTemplate('Contact t√©l√©phonique confirm√©')"
            class="text-[8px] px-2 py-1 bg-slate-800 rounded border border-slate-600 hover:bg-slate-700 uppercase"
          >
            üìû Tel OK
          </button>
          <button
            onclick="setTemplate('Accord oral en attente')"
            class="text-[8px] px-2 py-1 bg-slate-800 rounded border border-slate-600 hover:bg-slate-700 uppercase"
          >
            ü§ù Accord Oral
          </button>
          <button
            onclick="setTemplate('Erreur de tracking connue')"
            class="text-[8px] px-2 py-1 bg-slate-800 rounded border border-slate-600 hover:bg-slate-700 uppercase"
          >
            ‚öôÔ∏è Bug Track
          </button>
        </div>
        <textarea
          id="justification-text"
          class="w-full bg-black/50 border border-slate-700 rounded-xl p-4 text-sm text-white focus:border-orange-500 outline-none mb-6"
          placeholder="Ex: Client eu au t√©l√©phone..."
          rows="3"
        ></textarea>
        <div class="flex gap-3">
          <button
            onclick="document.getElementById('override-modal').close()"
            class="flex-1 px-4 py-3 rounded-xl bg-slate-800 font-bold text-[9px] uppercase tracking-widest hover:bg-slate-700 transition-all"
          >
            Annuler
          </button>
          <button
            id="confirm-override-btn"
            class="flex-1 px-4 py-3 rounded-xl bg-orange-500 text-black font-black text-[9px] uppercase tracking-widest hover:scale-105 transition-all"
          >
            Confirmer & Loguer
          </button>
        </div>
      </div>
    </dialog>

    <script>
      const SUPABASE_URL = "https://ugwqfvwclwctzgtxcakp.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnd3FmdndjbHdjdHpndHhjYWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNDg4OTgsImV4cCI6MjA4MTgyNDg5OH0.sx9z3p3svG5V6djfzUXtzdOwbUU3wjIVaAyIjRoFzaE";
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      let fullData = [];
      let logsData = [];
      let isPriorityMode = false;
      let isZenMode = false;
      let anomaliesDetected = [];
      let settings = { view_threshold: 5, day_threshold: 3 };

      function getTimeSince(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        let interval = seconds / 3600;
        if (interval > 24) return `ACTIF IL Y A ${Math.floor(interval / 24)}J`;
        if (interval >= 1) return `ACTIF IL Y A ${Math.floor(interval)}H`;
        return `ACTIF IL Y A ${Math.floor(seconds / 60)}MIN`;
      }

      function toggleZen() {
        isZenMode = !isZenMode;
        document.body.classList.toggle("mode-zen", isZenMode);
        document.getElementById("btn-zen").innerText = isZenMode
          ? "üëÅÔ∏è Mode Normal"
          : "üïäÔ∏è Mode Calme";
      }

      function setTemplate(t) {
        document.getElementById("justification-text").value = t;
      }

      function toggleRule(id) {
        const el = document.getElementById(`rule-${id}`);
        el.classList.toggle("hidden");
      }

      async function loadSettings() {
        try {
          const { data } = await supabaseClient
            .from("system_settings")
            .select("key, value_int");
          if (data) data.forEach((s) => (settings[s.key] = s.value_int));
        } catch (e) {
          console.warn("Settings error");
        }
      }

      async function loadData() {
        await loadSettings();
        try {
          const [
            { data: studies },
            { data: stats },
            { count: queueCount },
            { data: logs },
          ] = await Promise.all([
            supabaseClient
              .from("studies")
              .select(
                "id, status, created_at, clients(first_name, last_name, email)"
              )
              .order("created_at", { ascending: false })
              .limit(1000),
            supabaseClient
              .from("studies_activity_summary")
              .select("*")
              .limit(1000),
            supabaseClient
              .from("email_queue")
              .select("*", { count: "exact", head: true })
              .eq("status", "pending"),
            supabaseClient
              .from("decision_logs")
              .select("*")
              .order("created_at", { ascending: false })
              .limit(20),
          ]);

          logsData = logs || [];
          fullData = (studies || []).map((s) => {
            const st = (stats || []).find((item) => item.id === s.id) || {};
            const diffDays =
              (new Date() - new Date(s.created_at)) / (1000 * 60 * 60 * 24);
            return {
              id: s.id,
              name: s.clients
                ? `${s.clients.first_name || ""} ${
                    s.clients.last_name || ""
                  }`.trim()
                : "Inconnu",
              email: s.clients?.email || "Pas d'email",
              status: s.status,
              created_at: s.created_at,
              views: st.email_opens || 0,
              clicks: st.interactions || 0,
              diffDays: Math.floor(diffDays),
              hasLog: logsData.some((l) => l.study_id === s.id),
            };
          });

          updateKPIs(queueCount || 0);
          detectAnomalies();
          render();
          renderLogs();
        } catch (err) {
          console.error(err);
        }
      }

      function renderLogs() {
        const container = document.getElementById("logs-container");
        if (logsData.length === 0) {
          container.innerHTML = `<div class="p-10 text-center text-slate-600 text-[10px] uppercase tracking-widest italic">Aucune archive de for√ßage...</div>`;
          return;
        }
        container.innerHTML = logsData
          .map(
            (l) => `
                        <div class="p-4 flex justify-between items-center hover:bg-white/[0.01] transition-colors">
                            <div class="flex flex-col">
                                <span class="text-[8px] text-orange-500 font-black uppercase tracking-tighter">${
                                  l.action_performed
                                }</span>
                                <span class="text-sm font-bold text-slate-200">${
                                  l.client_name
                                }</span>
                            </div>
                            <div class="max-w-[50%] text-right">
                                <div class="text-[10px] text-slate-400 italic">"${
                                  l.justification
                                }"</div>
                                <div class="text-[8px] text-slate-600 uppercase font-bold mt-1">${new Date(
                                  l.created_at
                                ).toLocaleString()}</div>
                            </div>
                        </div>`
          )
          .join("");
      }

      function detectAnomalies() {
        const anomalies = [];
        fullData.forEach((s) => {
          if (
            s.status === "sent" &&
            s.views > settings.view_threshold &&
            s.clicks === 0
          ) {
            anomalies.push({
              id: s.id,
              name: s.name,
              type: "INT√âR√äT STAGNANT",
              desc: `Vue ${s.views} fois sans clic.`,
              rule: `R√®gle : SI statut=SENT ET vues>${settings.view_threshold} ET clics=0`,
              obs: `Donn√©es observ√©es : Vues=${s.views}, Clics=0`,
            });
          }
          if (
            s.status === "signed" &&
            s.diffDays > settings.day_threshold &&
            s.views < 2
          ) {
            anomalies.push({
              id: s.id,
              name: s.name,
              type: "SILENCE POST-SIGNATURE",
              desc: `Aucune lecture depuis ${s.diffDays}j.`,
              rule: `R√®gle : SI statut=SIGNED ET jours>${settings.day_threshold} ET vues<2`,
              obs: `Donn√©es observ√©es : Jours=${s.diffDays}, Vues=${s.views}`,
            });
          }
        });

        anomaliesDetected = anomalies.map((a) => a.id);
        const anomalyZone = document.getElementById("anomaly-zone");
        const calmZone = document.getElementById("calm-zone");
        const calmMessage = document.getElementById("system-info-calm");

        if (anomalies.length > 0) {
          anomalyZone.classList.remove("hidden");
          calmZone.classList.add("hidden");
          document.getElementById("anomaly-list").innerHTML = anomalies
            .map(
              (a) => `
                        <div class="anomaly-card p-5 rounded-2xl border-l-4 border-l-red-500">
                            <div class="text-[9px] font-black text-red-500 mb-1 tracking-widest">${a.type}</div>
                            <div class="text-lg font-bold mb-1">${a.name}</div>
                            <div class="text-[10px] text-slate-500 italic mb-2">${a.desc}</div>
                            <button onclick="toggleRule('${a.id}')" class="text-[9px] text-blue-400 hover:underline uppercase tracking-tighter">Pourquoi ce dossier est signal√© ?</button>
                            <div id="rule-${a.id}" class="hidden rule-box">
                                <div>${a.rule}</div>
                                <div class="mt-1">${a.obs}</div>
                            </div>
                        </div>`
            )
            .join("");
        } else {
          anomalyZone.classList.add("hidden");
          calmZone.classList.remove("hidden");
          calmMessage.innerHTML = `AUJOURD'HUI : 0 ANOMALIE, 0 URGENCE. <br><span class="opacity-50 text-[10px]">AUCUNE ANOMALIE D√âTECT√âE SUR LES R√âGLAGES ACTUELS</span>`;
        }
      }

      function updateKPIs(queue) {
        document.getElementById("stat-total").innerText = fullData.length;
        document.getElementById("stat-sent").innerText = fullData.filter(
          (s) => s.status === "sent"
        ).length;
        document.getElementById("stat-signed").innerText = fullData.filter(
          (s) => s.status === "signed"
        ).length;
        document.getElementById("stat-queue").innerText = queue;
        document.getElementById("row-count").innerText = fullData.length;
      }

      async function updateStatus(id, newStatus) {
        const { error } = await supabaseClient
          .from("studies")
          .update({ status: newStatus })
          .eq("id", id);
        if (!error) loadData();
      }

      async function forceAction(id, name, newStatus) {
        const modal = document.getElementById("override-modal");
        const text = document.getElementById("justification-text");
        modal.showModal();
        document.getElementById("confirm-override-btn").onclick = async () => {
          const justification = text.value.trim();
          if (!justification) return alert("Justification obligatoire.");
          const { error: logError } = await supabaseClient
            .from("decision_logs")
            .insert({
              study_id: id,
              client_name: name,
              action_performed: `FORCED_TO_${newStatus.toUpperCase()}`,
              justification: justification,
            });
          if (logError) return alert("Erreur log.");
          await updateStatus(id, newStatus);
          text.value = "";
          modal.close();
        };
      }

      function togglePriority() {
        isPriorityMode = !isPriorityMode;
        document
          .getElementById("btn-priority")
          .classList.toggle("bg-orange-600", isPriorityMode);
        render();
      }

      function render() {
        const tbody = document.getElementById("table-body");
        let list = isPriorityMode
          ? fullData.filter(
              (s) =>
                anomaliesDetected.includes(s.id) || s.views >= 3 || s.clicks > 0
            )
          : fullData;

        tbody.innerHTML = list
          .map((s) => {
            const hasAlert = anomaliesDetected.includes(s.id);
            return `
                        <tr class="transition-colors group ${
                          hasAlert ? "bg-red-500/5" : "hover:bg-white/[0.02]"
                        }">
                            <td class="p-6">
                                <div class="flex items-center gap-2">
                                    <div class="text-xl font-bold text-slate-100 group-hover:text-blue-400 transition-colors">${
                                      s.name
                                    }</div>
                                    ${
                                      s.hasLog
                                        ? `<span class="tooltip"><span class="text-orange-500 text-xs cursor-help">üìù</span><span class="tooltiptext">Ce dossier a √©t√© forc√© manuellement (voir logs bas de page)</span></span>`
                                        : ""
                                    }
                                </div>
                                <div class="text-xs text-slate-500 font-medium">${
                                  s.email
                                }</div>
                                <div class="text-[9px] text-slate-600 font-bold mt-2 uppercase tracking-widest italic">${getTimeSince(
                                  s.created_at
                                )}</div>
                            </td>
                            <td class="p-6 text-center">
                                <div class="flex justify-center gap-10 font-black">
                                    <div><div class="text-2xl ${
                                      s.views >= 3
                                        ? "text-orange-400"
                                        : "text-slate-300"
                                    }">${
              s.views
            }</div><div class="text-[8px] text-slate-500 uppercase italic">Vues</div></div>
                                    <div class="border-l border-slate-800/50 pl-10"><div class="text-2xl ${
                                      s.clicks > 0
                                        ? "text-purple-400"
                                        : "text-slate-300"
                                    }">${
              s.clicks
            }</div><div class="text-[8px] text-slate-500 uppercase italic">Clics</div></div>
                                </div>
                            </td>
                            <td class="p-6 text-center">
                                <div class="inline-block px-4 py-1.5 rounded-lg border font-black uppercase text-[9px] tracking-[0.15em] ${
                                  s.status === "signed"
                                    ? "border-emerald-500/50 text-emerald-400 bg-emerald-500/10"
                                    : s.status === "sent"
                                    ? "border-blue-500/50 text-blue-400 bg-blue-500/10"
                                    : "border-slate-600/50 text-slate-400"
                                }">
                                    <select onchange="${
                                      hasAlert
                                        ? `forceAction('${
                                            s.id
                                          }', '${s.name.replace(
                                            /'/g,
                                            "\\'"
                                          )}', this.value)`
                                        : `updateStatus('${s.id}', this.value)`
                                    }">
                                        <option value="sent" ${
                                          s.status === "sent" ? "selected" : ""
                                        }>SENT</option>
                                        <option value="draft" ${
                                          s.status === "draft" ? "selected" : ""
                                        }>DRAFT</option>
                                        <option value="signed" ${
                                          s.status === "signed"
                                            ? "selected"
                                            : ""
                                        }>SIGNED</option>
                                        <option value="cancelled" ${
                                          s.status === "cancelled"
                                            ? "selected"
                                            : ""
                                        }>CANCELLED</option>
                                    </select>
                                </div>
                            </td>
                            <td class="p-6 text-right">
                                <div class="flex justify-end gap-2">
                                    <div class="tooltip">
                                        <button onclick="${
                                          hasAlert
                                            ? `forceAction('${
                                                s.id
                                              }', '${s.name.replace(
                                                /'/g,
                                                "\\'"
                                              )}', 'signed')`
                                            : `updateStatus('${s.id}', 'signed')`
                                        }"
                                                class="px-4 py-2 ${
                                                  hasAlert
                                                    ? "bg-orange-500 text-black"
                                                    : "bg-emerald-500 text-black"
                                                } rounded-xl font-black text-[9px] uppercase tracking-widest hover:scale-105 transition-all">
                                            ${
                                              hasAlert
                                                ? "Forcer Sign√©"
                                                : "Sign√©"
                                            }
                                        </button>
                                        <span class="tooltiptext">${
                                          hasAlert
                                            ? "D√âVERROUILLAGE REQUIS"
                                            : "MARQUER SIGN√â"
                                        }</span>
                                    </div>
                                    <div class="tooltip">
                                        <button onclick="updateStatus('${
                                          s.id
                                        }', 'draft')" class="px-3 py-2 bg-slate-900 text-blue-400 border border-blue-500/20 rounded-xl hover:bg-blue-500 hover:text-white transition-all text-[9px] font-bold tracking-widest">DRAFT</button>
                                        <span class="tooltiptext">REMETTRE EN BROUILLON</span>
                                    </div>
                                    <div class="tooltip">
                                        <button onclick="updateStatus('${
                                          s.id
                                        }', 'cancelled')" class="px-3 py-2 bg-slate-900 text-red-500 border border-red-500/20 rounded-xl hover:bg-red-500 hover:text-white transition-all text-xs">√ó</button>
                                        <span class="tooltiptext">ANNULER</span>
                                    </div>
                                </div>
                            </td>
                        </tr>`;
          })
          .join("");
      }

      function daysAgo(date) {
        const d = Math.floor(
          (new Date() - new Date(date)) / (1000 * 60 * 60 * 24)
        );
        return d <= 0 ? "Aujourd‚Äôhui" : `Il y a ${d}j`;
      }

      function nextFollowUp(lead) {
        const now = new Date();
        const created = new Date(lead.created_at);
        const last = lead.last_email_sent_at
          ? new Date(lead.last_email_sent_at)
          : created;

        const daysSinceCreation = (now - created) / (1000 * 60 * 60 * 24);
        const daysSinceLast = (now - last) / (1000 * 60 * 60 * 24);

        if (daysSinceCreation > 120) return "Termin√©";

        if (daysSinceCreation <= 60) {
          return daysSinceLast >= 7
            ? "Aujourd‚Äôhui"
            : `Dans ${Math.ceil(7 - daysSinceLast)}j`;
        }

        return daysSinceLast >= 14
          ? "Aujourd‚Äôhui"
          : `Dans ${Math.ceil(14 - daysSinceLast)}j`;
      }

      async function loadEmailLeads() {
        const { data: leads } = await supabaseClient
          .from("email_leads")
          .select(
            `
        id,
        created_at,
        last_email_sent_at,
        email_step,
        clients (
          id,
          email,
          first_name,
          last_name,
          email_optout
        )
              `
          )
          .order("created_at", { ascending: false })
          .limit(200);

        const tbody = document.getElementById("leads-email-body");
        if (!tbody || !leads) return;

        // Calcul du compteur
        const todayCount = leads.filter((l) => {
          const c = l.clients;
          if (!c) return false;
          return nextFollowUp(l) === "Aujourd‚Äôhui" && !c.email_optout;
        }).length;

        const indicator = document.getElementById("email-today-indicator");
        const countEl = document.getElementById("email-today-count");

        if (todayCount > 0) {
          countEl.innerText = todayCount;
          indicator.classList.remove("hidden");
        } else {
          indicator.classList.add("hidden");
        }

        // Rendu du tableau EMAIL LEADS
        tbody.innerHTML = leads
          .map((l) => {
            const c = l.clients;
            if (!c) return "";

            return `
                  <tr class="hover:bg-white/[0.02] transition-colors">
                    <td class="p-4">
                      <div class="font-bold text-slate-200">
                        ${c.first_name || ""} ${c.last_name || ""}
                      </div>
                      <div class="text-xs text-slate-500">${c.email}</div>
                    </td>

                    <td class="p-4 text-center text-xs text-slate-400">
                      ${
                        l.last_email_sent_at
                          ? daysAgo(l.last_email_sent_at)
                          : "Jamais"
                      }

                    </td>

                    <td class="p-4 text-center">
                      ${
                        nextFollowUp(l) === "Aujourd‚Äôhui"
                          ? `<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest bg-orange-500/20 text-orange-400 animate-pulse">üîî Aujourd‚Äôhui</span>`
                          : `<span class="text-xs font-bold text-slate-400">${nextFollowUp(
                              l
                            )}</span>`
                      }
                    </td>

                    <td class="p-4 text-center">
                      ${
                        c.email_optout
                          ? `<span class="text-red-500 text-xs font-black uppercase">Oui</span>`
                          : `<button onclick="setOptOut('${c.email}')" class="px-3 py-1 text-[9px] font-black uppercase bg-slate-800 border border-slate-600 rounded hover:bg-red-500 hover:text-white transition-all">Stop emails</button>`
                      }
                    </td>
                  </tr>
                `;
          })
          .join("");
      }

      async function setOptOut(email) {
        if (!confirm("Confirmer l‚Äôexclusion de ce lead ?")) return;
        await supabaseClient
          .from("clients")
          .update({ email_optout: true })
          .eq("email", email);
        loadEmailLeads();
      }

      // Lancement et rafra√Æchissement
      loadData();
      loadEmailLeads();
      setInterval(loadData, 60000);
      setInterval(loadEmailLeads, 60000);
    </script>
  </body>
</html>
