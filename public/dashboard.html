<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>AUTOPILOTE SOLAIRE - Nicolas Di Stefano</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Charger Supabase de mani√®re asynchrone et attendre qu'il soit pr√™t
      (function () {
        const script = document.createElement("script");
        script.src =
          "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js";
        script.onload = function () {
          console.log("‚úÖ Supabase charg√© !");
          window.supabaseReady = true;
        };
        script.onerror = function () {
          console.error("‚ùå Erreur chargement Supabase !");
        };
        document.head.appendChild(script);
      })();
    </script>
    <style>

      body {
        background: linear-gradient(
          135deg,
          #0a0a1a 0%,
          #050510 50%,
          #0a0a1a 100%
        );
        color: white;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        transition: all 0.4s ease;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(59, 130, 246, 0.03) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(16, 185, 129, 0.03) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: 0;
      }

      .content-wrapper {
        position: relative;
        z-index: 1;
      }

      .glass {
        background: rgba(15, 17, 26, 0.85);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      body.mode-zen .anomaly-card {
        border-color: rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.02);
      }
      body.mode-zen .text-red-500,
      body.mode-zen .text-orange-400,
      body.mode-zen .text-orange-500 {
        color: #94a3b8 !important;
      }
      body.mode-zen .bg-red-500,
      body.mode-zen .bg-orange-500,
      body.mode-zen .bg-emerald-500 {
        background-color: #475569 !important;
        color: white !important;
      }
      body.mode-zen .border-emerald-500,
      body.mode-zen .border-red-500 {
        border-color: #334155 !important;
      }

      select {
        background: transparent;
        border: none;
        color: inherit;
        cursor: pointer;
        appearance: none;
        text-align: center;
        outline: none;
      }

      .tooltip {
        position: relative;
        display: inline-block;
      }
      .tooltip .tooltiptext {
        visibility: hidden;
        width: 140px;
        background-color: rgba(0, 0, 0, 0.95);
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 8px;
        position: absolute;
        z-index: 10;
        bottom: 125%;
        left: 50%;
        margin-left: -70px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 10px;
        font-weight: 700;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      dialog::backdrop {
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
      }
      dialog[open] {
        display: flex;
        flex-direction: column;
      }

      .rule-box {
        background: rgba(0, 0, 0, 0.5);
        border-radius: 8px;
        padding: 12px;
        margin-top: 10px;
        font-family: "Courier New", monospace;
        font-size: 11px;
        color: #94a3b8;
        border: 1px solid rgba(255, 255, 255, 0.08);
        text-align: left;
      }

      .stat-card {
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent,
          currentColor,
          transparent
        );
        opacity: 0;
        transition: opacity 0.4s;
      }

      .stat-card:hover::before {
        opacity: 0.5;
      }

      .stat-card:hover {
        transform: translateY(-4px);
      }

      tbody tr {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      tbody tr:hover {
        background: rgba(59, 130, 246, 0.03) !important;
        transform: translateX(4px);
      }

      .action-button {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .action-button:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .nuclear-glow {
        position: relative;
      }

      .nuclear-glow::after {
        content: "";
        position: absolute;
        inset: -10px;
        background: radial-gradient(
          circle,
          rgba(16, 185, 129, 0.1) 0%,
          transparent 70%
        );
        z-index: -1;
        animation: nuclear-pulse 2s ease-in-out infinite;
      }

      @keyframes nuclear-pulse {
        0%,
        100% {
          opacity: 0.3;
        }
        50% {
          opacity: 0.6;
        }
      }

      .search-bar:focus-within {
        border-color: rgba(59, 130, 246, 0.5);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
      }

      .filter-chip {
        transition: all 0.2s ease;
      }

      .filter-chip:hover {
        transform: translateY(-2px);
      }

      .filter-chip.active {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.25),
          rgba(59, 130, 246, 0.08)
        );
        border-color: rgba(59, 130, 246, 0.6);
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.4),
          0 0 20px rgba(59, 130, 246, 0.25);
        transform: translateY(-1px) scale(1.03);
      }

      .temp-cold {
        background: rgba(100, 116, 139, 0.15);
        border: 1px solid rgba(100, 116, 139, 0.4);
        color: #94a3b8;
      }

      .temp-warm {
        background: rgba(59, 130, 246, 0.18);
        border: 1px solid rgba(59, 130, 246, 0.5);
        color: #93c5fd;
        box-shadow: 0 0 12px rgba(59, 130, 246, 0.25);
      }

      .temp-hot {
        background: linear-gradient(
          135deg,
          rgba(168, 85, 247, 0.25),
          rgba(251, 146, 60, 0.25)
        );
        border: 1px solid rgba(251, 146, 60, 0.6);
        color: #fde68a;
        box-shadow: 0 0 18px rgba(251, 146, 60, 0.45);
      }

      .temp-signed {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.35),
          rgba(6, 182, 212, 0.2)
        );
        border: 1px solid rgba(16, 185, 129, 0.8);
        color: #a7f3d0;
        box-shadow: 0 0 22px rgba(16, 185, 129, 0.6);
      }

      @keyframes warpulse {
        0%,
        100% {
          box-shadow: 0 0 25px rgba(239, 68, 68, 0.25),
            inset 0 0 0 1px rgba(239, 68, 68, 0.35);
        }
        50% {
          box-shadow: 0 0 60px rgba(239, 68, 68, 0.55),
            inset 0 0 0 1px rgba(239, 68, 68, 0.6);
        }
      }

      .war-room-critical {
        position: relative;
        border: 1px solid rgba(239, 68, 68, 0.45) !important;
        animation: warpulse 4s ease-in-out infinite;
      }
      /* Animation alerte critique */
@keyframes alert-pulse {
  0%, 100% {
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
  }
  50% {
    box-shadow: 0 0 40px rgba(239, 68, 68, 0.6);
  }
}

#critical-alert {
  animation: alert-pulse 2s ease-in-out infinite;
}

/* Smooth scroll */
html {
  scroll-behavior: smooth;
}

/* Details arrow */
details summary {
  list-style: none;
}

details summary::-webkit-details-marker {
  display: none;
}

details summary::after {
  content: "‚ñº";
  font-size: 10px;
  margin-left: 8px;
  transition: transform 0.3s;
  display: inline-block;
}

details[open] summary::after {
  transform: rotate(180deg);
}
    </style>
  </head>
  <body class="p-2">
  
<!-- PARTIE 2/5 : HEADER + COCKPIT + STATS KPI -->

<!-- EN-T√äTE -->
<!-- HEADER COMPACT -->
<div class="flex justify-between items-center mb-6 px-4">
  <div class="flex items-center gap-4">
    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-emerald-500 rounded-xl flex items-center justify-center shadow-lg">
      <span class="text-xl">‚ö°</span>
    </div>
    <div>
      <h1 class="text-xl font-black tracking-tight uppercase text-slate-100">AUTOPILOTE SOLAIRE</h1>
      <div id="system-status-inline" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-1">
        üü¢ Syst√®me op√©rationnel ‚Ä¢ <span id="row-count-header">0</span> dossiers
      </div>
    </div>
  </div>

  <div class="flex items-center gap-2">
    <button onclick="toggleZen()" id="btn-zen"
      class="px-3 py-2 rounded-lg border border-slate-700 bg-slate-900/50 text-slate-300 font-bold uppercase text-[9px] tracking-wider hover:bg-slate-800 transition-all">
      üïäÔ∏è MODE CALME
    </button>
    <button onclick="togglePriority()" id="btn-priority"
      class="px-3 py-2 rounded-lg border border-slate-700 bg-slate-900/50 text-slate-300 font-bold uppercase text-[9px] tracking-wider hover:bg-slate-800 transition-all">
      ‚ö†Ô∏è PRIORIT√â
    </button>
  </div>
</div>
<!-- üß† √âTAT GLOBAL -->
<div id="system-state"
     class="glass rounded-2xl p-5 mb-4 border border-slate-700/40 flex items-center gap-4">

  <div id="system-dot"
       class="w-3 h-3 rounded-full bg-slate-400 animate-pulse"></div>

  <div>
    <div id="system-label"
         class="text-sm font-black tracking-widest uppercase text-slate-300">
      INITIALISATION
    </div>

    <div id="system-desc"
         class="text-[10px] text-slate-500 uppercase tracking-wider mt-1">
      Analyse en cours‚Ä¶
    </div>
  </div>
</div>
<!-- ALERTE CRITIQUE -->
<div id="critical-alert" class="hidden mb-6">
  <div class="relative overflow-hidden rounded-2xl p-8 border-2 border-red-500/60 bg-gradient-to-br from-red-500/10 to-red-500/5">
    <div class="absolute inset-0 bg-gradient-to-r from-red-500/10 via-red-500/5 to-transparent animate-pulse"></div>
    
    <div class="relative z-10 flex items-center justify-between">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse shadow-[0_0_12px_rgba(239,68,68,0.8)]"></div>
          <h2 class="text-lg font-black text-red-400 uppercase tracking-wider">ALERTE CRITIQUE</h2>
        </div>
        <p id="alert-message" class="text-2xl font-black text-slate-100 mb-1">
          ‚Äî DOSSIERS EN DANGER
        </p>
        <p id="alert-amount" class="text-xl font-bold text-red-300">
          0 ‚Ç¨ √Ä SAUVER AUJOURD'HUI
        </p>
      </div>
      
      <div class="flex gap-3">
        <button onclick="document.getElementById('war-room-section').scrollIntoView({behavior: 'smooth'})" 
          class="px-6 py-3 bg-red-500 text-black font-black text-sm rounded-lg hover:bg-red-400 transition-all uppercase tracking-wider">
          VOIR LA LISTE
        </button>
        <button id="alert-primary-action" onclick="handlePrimaryAction()"
          class="px-6 py-3 bg-white text-black font-black text-sm rounded-lg hover:bg-slate-200 transition-all uppercase tracking-wider">
          ACTION PRIORITAIRE
        </button>
      </div>
    </div>
  </div>
</div>


<!-- üß† COCKPIT WAR ROOM OPTIMIS√â -->
<section
  class="glass rounded-2xl p-6 border border-slate-700/40 space-y-6"
>
  <!-- WAR ROOM OPTIMIS√âE -->
<section id="war-room-section" class="glass rounded-2xl p-6 border border-slate-700/40 space-y-6 mb-8">
  
  <!-- STATS RAPIDES -->
  <div class="grid grid-cols-3 gap-4">
    <div class="glass p-4 rounded-xl border border-red-500/30">
      <div class="text-xs text-red-400 uppercase font-bold mb-1">üö® Risques critiques</div>
      <div id="ec-risk-count" class="text-3xl font-black text-red-400 mb-2">0</div>
      <div class="text-[9px] text-red-300 font-bold">
        <span id="ec-risk-ca">0 ‚Ç¨</span> en danger
      </div>
    </div>

    <div class="glass p-4 rounded-xl border border-emerald-500/30">
      <div class="text-xs text-emerald-400 uppercase font-bold mb-1">üü¢ Dossiers sains</div>
      <div id="ec-hot-count" class="text-3xl font-black text-emerald-400 mb-2">0</div>
      <div class="text-[9px] text-emerald-300 font-bold">
        <span id="ec-hot-ca">0 ‚Ç¨</span> s√©curis√©
      </div>
    </div>

    <div class="glass p-4 rounded-xl border border-cyan-500/30">
      <div class="text-xs text-cyan-300 uppercase font-bold mb-1">üßä Muets</div>
      <div id="ec-mute-count" class="text-3xl font-black text-cyan-300 mb-2">0</div>
      <div class="text-[9px] text-cyan-200 font-bold">
        <span id="ec-mute-ca">0 ‚Ç¨</span> silencieux
      </div>
    </div>
  </div>

  <!-- DOSSIERS √Ä TRAITER (max 5) -->
  <div>
    <h3 class="text-red-400 font-black text-sm mb-3 flex items-center gap-2">
      <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
      üö® √Ä TRAITER AUJOURD'HUI
    </h3>
    <div id="ec-action-zone" class="space-y-3 max-h-[500px] overflow-y-auto"></div>
  </div>

  <!-- DOSSIERS SECONDAIRES (repliable) -->
  <details class="group">
    <summary class="cursor-pointer text-slate-400 text-sm font-bold hover:text-slate-300 transition-colors">
      üìä VOIR TOUS LES DOSSIERS (<span id="all-count">0</span>)
    </summary>
    <div class="mt-4 grid grid-cols-2 gap-6">
      <div>
        <h4 class="text-emerald-400 font-black text-sm mb-2">üü¢ DOSSIERS SAINS</h4>
        <div id="ec-hot-zone" class="space-y-2 max-h-[300px] overflow-y-auto"></div>
      </div>
      <div>
        <h4 class="text-slate-300 font-black text-sm mb-2">üßä MUETS</h4>
        <div id="ec-stable-zone" class="space-y-2 max-h-[300px] overflow-y-auto"></div>
      </div>
    </div>
  </details>
</section>

  </div>

  <!-- WAR ROOM -->
  <div class="grid grid-cols-3 gap-6">
    <div class="relative glass rounded-2xl p-4 war-room-critical">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-red-400 font-black text-sm tracking-widest">
          üö® WAR ROOM ‚Äî RISQUE D'ANNULATION
        </h3>
        <span
          class="text-[10px] px-2 py-1 rounded-full bg-red-500/20 text-red-300 font-bold"
        >
          CRITIQUE
        </span>
      </div>

      <div
        id="ec-risk-zone"
        class="space-y-2 max-h-[420px] overflow-y-auto pr-1"
      ></div>
    </div>

    <div>
      <h3 class="text-emerald-400 font-black text-sm mb-2">
        üü¢ DOSSIERS SAINS
      </h3>
      <div
        id="ec-hot-zone-secondary"
        class="space-y-2 max-h-[420px] overflow-y-auto"
      ></div>
    </div>

    <div>
      <h3 class="text-slate-300 font-black text-sm mb-2">
        üü° √Ä SURVEILLER
      </h3>
      <div
        id="ec-stable-zone"
        class="space-y-2 max-h-[420px] overflow-y-auto"
      ></div>
    </div>
  </div>
</section>

<!-- PARTIE 3/5 : AXE A ‚Äî GESTION ADMINISTRATIVE OPTIMIS√âE -->

<!-- AXE A ‚Äî TITRE CLARIFI√â -->
<!-- GESTION ADMINISTRATIVE -->
<div class="mt-12 w-full">
  <div class="mb-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_12px_rgba(16,185,129,0.8)]"></div>
      <h2 class="text-base font-black uppercase tracking-[0.35em] text-emerald-400">
        üìã SUIVI ACOMPTES & ADMINISTRATIF
      </h2>
    </div>
    <div class="text-xs text-slate-400 font-bold">
      <span id="signed-total-count">0</span> dossiers sign√©s
    </div>
  </div>
  <!-- STATS FINANCI√àRES COMPACTES -->
  <div class="grid grid-cols-4 gap-4 mb-6">
    
    <!-- Cash s√©curis√© -->
    <div class="glass rounded-xl p-4 border border-emerald-500/20">
      <div class="text-[10px] text-emerald-400 uppercase font-black tracking-wider mb-2">
        üí∞ CASH S√âCURIS√â
      </div>
      <div class="text-2xl font-black text-emerald-400 mb-1" id="stat-ca-secured">0 ‚Ç¨</div>
      <div class="text-[9px] text-emerald-300 font-bold">
        <span id="stat-secured-count">0</span> acomptes re√ßus
      </div>
      <div class="h-1 bg-slate-800/50 rounded-full overflow-hidden mt-2">
        <div id="stat-secured-bar" class="h-full bg-emerald-500 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <!-- Cash √† risque -->
    <div class="glass rounded-xl p-4 border border-orange-500/20">
      <div class="text-[10px] text-orange-400 uppercase font-black tracking-wider mb-2">
        ‚ö†Ô∏è CASH √Ä RISQUE
      </div>
      <div class="text-2xl font-black text-orange-400 mb-1" id="stat-ca-at-risk">0 ‚Ç¨</div>
      <div class="text-[9px] text-orange-300 font-bold">
        <span id="stat-risk-count">0</span> en attente d'acompte
      </div>
      <div class="h-1 bg-slate-800/50 rounded-full overflow-hidden mt-2">
        <div id="stat-risk-bar" class="h-full bg-orange-500 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <!-- Retards -->
    <div class="glass rounded-xl p-4 border border-red-500/20 cursor-pointer hover:border-red-500/40 transition-all"
         onclick="scrollToLateDeposits()">
      <div class="text-[10px] text-red-400 uppercase font-black tracking-wider mb-2">
        üö® EN RETARD > 10J
      </div>
      <div class="text-2xl font-black text-red-400 mb-1" id="stat-late-count">0</div>
      <div class="text-[9px] text-red-300 font-bold overflow-hidden" style="max-height: 40px;">
        <div id="stat-late-names">Aucun retard</div>
      </div>
    </div>

    <!-- Prochaine √©ch√©ance -->
    <div class="glass rounded-xl p-4 border border-blue-500/20">
      <div class="text-[10px] text-blue-400 uppercase font-black tracking-wider mb-2">
        üìÖ PROCHAINE √âCH√âANCE
      </div>
      <div class="text-lg font-black text-blue-400 mb-1" id="stat-next-deadline-date">‚Äî</div>
      <div class="text-[9px] text-blue-300 font-bold">
        <div id="stat-next-deadline-client">Aucune √©ch√©ance proche</div>
      </div>
    </div>

  </div>

  <!-- TABLEAU DOSSIERS SIGN√âS (INCHANG√â) -->
  <!-- LISTE DOSSIERS SIGN√âS -->
  <div class="glass rounded-2xl overflow-hidden border border-slate-700/20">
    <div id="signed-list" class="flex flex-col gap-3 p-4"></div>
  </div>
</div>
  </div>
</div>
<!-- PARTIE 4/5 : AXE B + AXE C + BO√éTE NOIRE -->

<!-- ========================================== -->
<!-- AXE B ‚Äî PIPELINE ACTIF (SENT) -->
<!-- ========================================== -->

<!-- AXE B ‚Äî PIPELINE -->
<div class="mt-12">
  <div class="mb-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_12px_rgba(59,130,246,0.8)] animate-pulse"></div>
      <h2 class="text-base font-black uppercase tracking-[0.35em] text-blue-400">
        üî• PIPELINE ACTIF
      </h2>
    </div>
    <div class="text-xs text-slate-400 font-bold">
      <span id="filtered-count">0</span> r√©sultats
    </div>
  </div>

<!-- RECHERCHE & FILTRES -->
  <div class="mb-6">
    <div class="glass rounded-xl p-4 border border-slate-700/20">
      
      <!-- Ligne 1 : Recherche + boutons action -->
      <div class="flex gap-3 mb-3">
        <input id="search-input" type="text" placeholder="üîç Rechercher..."
          class="flex-1 bg-black/40 border border-slate-700 rounded-lg px-4 py-2 text-white text-sm placeholder-slate-500 focus:border-blue-500 focus:outline-none"
          oninput="applyFilters()" />
        
        <button onclick="toggleHideSignedInAxeB()" id="btn-hide-signed"
          class="px-4 py-2 bg-emerald-500/20 border border-emerald-500/50 text-emerald-400 rounded-lg font-bold text-xs hover:bg-emerald-500/30 transition-all uppercase">
          <span id="hide-signed-text">üëÅÔ∏è AFFICHER SIGN√âS</span>
        </button>
        
        <button onclick="resetFilters()"
          class="px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-400 font-bold text-xs hover:bg-slate-700 transition-all">
          ‚úï RESET
        </button>
      </div>

      <!-- Ligne 2 : Filtres rapides -->
      <div class="flex flex-wrap gap-2">
        <button onclick="toggleFilter('views', '3+')" id="filter-views-3"
          class="filter-chip px-3 py-1.5 bg-slate-800/60 border border-slate-700 rounded-lg text-[10px] font-bold text-slate-300 hover:bg-slate-700">
          üëÅÔ∏è VUES 3+
        </button>
        <button onclick="toggleFilter('views', '5+')" id="filter-views-5"
          class="filter-chip px-3 py-1.5 bg-slate-800/60 border border-slate-700 rounded-lg text-[10px] font-bold text-slate-300 hover:bg-slate-700">
          üëÅÔ∏è VUES 5+
        </button>
        <button onclick="toggleFilter('clicks', '1+')" id="filter-clicks-1"
          class="filter-chip px-3 py-1.5 bg-slate-800/60 border border-slate-700 rounded-lg text-[10px] font-bold text-slate-300 hover:bg-slate-700">
          üñ±Ô∏è CLICS 1+
        </button>
        <button onclick="toggleFilter('clicks', '3+')" id="filter-clicks-3"
          class="filter-chip px-3 py-1.5 bg-slate-800/60 border border-slate-700 rounded-lg text-[10px] font-bold text-slate-300 hover:bg-slate-700">
          üñ±Ô∏è CLICS 3+
        </button>
        <button onclick="toggleFilter('status', 'sent')" id="filter-status-sent"
          class="filter-chip px-3 py-1.5 bg-slate-800/60 border border-slate-700 rounded-lg text-[10px] font-bold text-blue-400 hover:bg-slate-700">
          üì§ SENT
        </button>
        <button onclick="toggleFilter('status', 'signed')" id="filter-status-signed"
          class="filter-chip px-3 py-1.5 bg-slate-800/60 border border-slate-700 rounded-lg text-[10px] font-bold text-emerald-400 hover:bg-slate-700">
          ‚úì SIGNED
        </button>
        <button onclick="toggleFilter('optout', 'true')" id="filter-optout"
          class="filter-chip px-3 py-1.5 bg-slate-800/60 border border-slate-700 rounded-lg text-[10px] font-bold text-red-400 hover:bg-slate-700">
          üö´ D√âSABONN√âS
        </button>
      </div>

    </div>
  </div>


<!-- TABLEAU PIPELINE -->
<div class="glass cockpit-block rounded-3xl overflow-hidden">
  <div
    class="absolute inset-0 bg-gradient-to-br from-blue-500/5 via-transparent to-emerald-500/5 pointer-events-none"
  ></div>
 <!-- AXE B ‚Äî PIPELINE (SANS TABLE) -->

<div class="grid grid-cols-[2.5fr_1.4fr_1fr_1fr_1.4fr] px-6 py-3 bg-black/70 text-slate-400 text-[10px] font-black uppercase tracking-[0.15em] border-b border-slate-700/50">
  <div>Dossier client</div>
  <div>S√©quence</div>
  <div class="text-center">Engagement</div>
  <div class="text-center">Statut</div>
  <div class="text-right">Actions</div>
</div>

<div id="pipeline-list" class="flex flex-col gap-3 mt-3"></div>

</div>


<!-- ========================================== -->
<!-- AXE C ‚Äî AUTOMATISATION EMAIL -->
<!-- ========================================== -->

<!-- AXE C ‚Äî EMAIL -->
<div class="mt-12">
  <div class="mb-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_12px_rgba(168,85,247,0.8)] animate-pulse"></div>
      <h2 class="text-base font-black uppercase tracking-[0.35em] text-purple-400">
        üì¨ AUTOMATISATION EMAIL
      </h2>
    </div>
    <div class="text-xs text-slate-400 font-bold">
      <span id="filtered-lead-count">0</span> leads
    </div>
  </div>

  <!-- STATS EMAIL -->
  <div class="grid grid-cols-3 gap-4 mb-6">
    <div class="glass rounded-xl p-4 border border-red-500/20">
      <div class="text-[10px] font-black text-red-400/70 uppercase mb-2 tracking-wider">
        D√âSABONN√âS TOTAL
      </div>
      <div class="text-3xl font-black text-red-400" id="stat-optout-total">0</div>
    </div>
    <div class="glass rounded-xl p-4 border border-orange-500/20">
      <div class="text-[10px] font-black text-orange-400/70 uppercase mb-2 tracking-wider">
        D√âSABONN√âS AUJOURD'HUI
      </div>
      <div class="text-3xl font-black text-orange-400" id="stat-optout-today">0</div>
    </div>
    <div class="glass rounded-xl p-4 border border-slate-700/20">
      <div class="text-[10px] font-black text-slate-400/70 uppercase mb-2 tracking-wider">
        TAUX D√âSABONNEMENT
      </div>
      <div class="text-3xl font-black text-slate-300" id="stat-optout-rate">0%</div>
    </div>
  </div>

  <!-- RECHERCHE LEADS -->
  <div class="mb-6">
    <div class="glass rounded-xl p-4 border border-slate-700/20">
      <div class="flex gap-3 mb-3">
        <input id="search-leads-input" type="text" placeholder="üîç Rechercher un lead..."
          class="flex-1 bg-black/40 border border-slate-700 rounded-lg px-4 py-2 text-white text-sm placeholder-slate-500 focus:border-purple-500 focus:outline-none"
          oninput="applyLeadsFilters()" />
        <button onclick="resetLeadsFilters()"
          class="px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-400 font-bold text-xs hover:bg-slate-700 transition-all">
          ‚úï RESET
        </button>
      </div>
      <div class="flex gap-2">
        <button onclick="toggleLeadFilter('today')" id="filter-lead-today"
          class="filter-chip px-3 py-1.5 bg-slate-800/60 border border-slate-700 rounded-lg text-[10px] font-bold text-orange-400 hover:bg-slate-700">
          üîî RELANCE AUJOURD'HUI
        </button>
        <button onclick="toggleLeadFilter('opted-out')" id="filter-lead-optout"
          class="filter-chip px-3 py-1.5 bg-slate-800/60 border border-slate-700 rounded-lg text-[10px] font-bold text-red-400 hover:bg-slate-700">
          üö´ D√âSABONN√âS
        </button>
      </div>
    </div>
  </div>

  <!-- INDICATEUR RELANCES -->
  <div id="email-today-indicator" class="mb-6 glass rounded-xl p-4 border border-orange-500/30">
    <div class="flex items-center gap-3">
      <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
      <span class="text-sm font-black uppercase tracking-wider text-orange-400">
        üîî <span id="email-today-count">0</span> RELANCE(S) PR√âVUE(S) AUJOURD'HUI
      </span>
    </div>
  </div>

  <div
    id="email-today-indicator"
    class="mb-6 text-xl font-black uppercase tracking-[0.35em] text-orange-400 flex items-center gap-3"
  >
    <span
      class="w-2 h-2 bg-orange-500 rounded-full animate-pulse shadow-[0_0_12px_rgba(249,115,22,0.8)]"
    ></span>
    üîî <span id="email-today-count">0</span> RELANCE(S) AUTOMATIQUE(S)
    PR√âVUE(S) AUJOURD'HUI
  </div>

  <!-- TABLEAU LEADS EMAIL -->
  <div class="glass rounded-3xl overflow-hidden">
    <table class="w-full text-left border-collapse">
      <thead
        class="bg-black/70 text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] border-b border-slate-700/50"
      >
        <tr>
          <th colspan="4" class="p-0">
            <div
              class="grid grid-cols-[30%_15%_20%_20%_15%] px-6 py-5 text-[18px] font-black uppercase tracking-[0.3em] text-slate-400"
            >
              <div class="text-left">LEAD</div>
              <div class="text-center">ENGAGEMENT</div>
              <div class="text-center">DERNIER EMAIL</div>
              <div class="text-center">PROCHAINE RELANCE</div>
              <div class="text-center">OPT-OUT</div>
            </div>
          </th>
        </tr>
      </thead>
      <tbody
        id="leads-email-body"
        class="divide-y divide-slate-800/20"
      ></tbody>
    </table>
  </div>
</div>
<!-- STATS GLOBALES (compact) -->
<div class="mt-12 glass rounded-2xl p-6 border border-slate-700/40">
  <h3 class="text-slate-400 text-xs font-black uppercase tracking-wider mb-4">üìä STATISTIQUES GLOBALES</h3>
  <div class="grid grid-cols-4 gap-4 text-center">
    <div>
      <div class="text-3xl font-black text-slate-300" id="stat-total">0</div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wider mt-1">Total dossiers</div>
    </div>
    <div>
      <div class="text-3xl font-black text-blue-400" id="stat-sent">0</div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wider mt-1">En cours (Sent)</div>
    </div>
    <div>
      <div class="text-3xl font-black text-emerald-400" id="stat-signed">0</div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wider mt-1">Sign√©s</div>
    </div>
    <div>
      <div class="text-3xl font-black text-orange-400" id="stat-queue">0</div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wider mt-1">Relances programm√©es</div>
    </div>
  </div>
</div>

<!-- ========================================== -->
<!-- üßæ BO√éTE NOIRE ‚Äî JOURNAL DES FOR√áAGES -->
<!-- ========================================== -->

<!-- BO√éTE NOIRE (repliable) -->
<div class="mt-12 mb-12">
  <details class="group">
    <summary class="cursor-pointer mb-4 flex items-center gap-3 hover:text-slate-300 transition-colors">
      <span class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></span>
      <h2 class="text-slate-400 text-xs font-black uppercase tracking-wider">
        üßæ JOURNAL DES FOR√áAGES (<span id="logs-count">0</span>)
      </h2>
    </summary>
    
    <div class="glass rounded-2xl overflow-hidden border border-slate-700/20">
      <div id="logs-container" class="max-h-[360px] overflow-y-auto divide-y divide-slate-800/20">
        <div class="p-8 text-center text-slate-600 text-xs uppercase tracking-widest italic">
          Chargement des archives...
        </div>
      </div>
    </div>
  </details>
</div>
  <div class="glass rounded-3xl overflow-hidden">
    <div
      id="logs-container-archive"
      class="max-h-[360px] overflow-y-auto divide-y divide-slate-800/20"
    >
      <div
        class="p-8 text-center text-slate-600 text-xs uppercase tracking-widest italic"
      >
        Chargement des archives...
      </div>
    </div>
  </div>
</div>

<!-- MODAL FOR√áAGE -->
<dialog id="override-modal" class="glass border border-slate-700 p-8 rounded-2xl text-white outline-none max-w-md">
  <div>
    <div class="flex items-center gap-3 mb-4">
      <div class="w-3 h-3 bg-orange-500 rounded-full animate-pulse"></div>
      <h3 class="text-xl font-black text-orange-400 uppercase">FOR√áAGE MANUEL</h3>
    </div>
    
    <p class="text-xs text-slate-400 mb-4 uppercase tracking-wider">
      Justifiez le d√©verrouillage :
    </p>
    
    <div class="flex flex-wrap gap-2 mb-4">
      <button onclick="setTemplate('Contact t√©l√©phonique confirm√©')"
        class="text-[10px] px-3 py-2 bg-slate-800 rounded-lg border border-slate-600 hover:bg-slate-700 uppercase font-bold tracking-wider transition-all">
        üìû TEL OK
      </button>
      <button onclick="setTemplate('Accord oral en attente')"
        class="text-[10px] px-3 py-2 bg-slate-800 rounded-lg border border-slate-600 hover:bg-slate-700 uppercase font-bold tracking-wider transition-all">
        ü§ù ACCORD ORAL
      </button>
      <button onclick="setTemplate('Erreur de tracking connue')"
        class="text-[10px] px-3 py-2 bg-slate-800 rounded-lg border border-slate-600 hover:bg-slate-700 uppercase font-bold tracking-wider transition-all">
        ‚öôÔ∏è BUG TRACK
      </button>
    </div>
    
    <textarea id="justification-text"
      class="w-full bg-black/60 border border-slate-700 rounded-xl p-4 text-sm text-white focus:border-orange-500 outline-none mb-4 focus:bg-black/80 transition-all"
      placeholder="Ex: Client eu au t√©l√©phone..."
      rows="3"></textarea>
    
    <div class="flex gap-3">
      <button onclick="document.getElementById('override-modal').close()"
        class="flex-1 px-4 py-3 rounded-xl bg-slate-800 font-bold text-xs uppercase tracking-wider hover:bg-slate-700 transition-all">
        ANNULER
      </button>
      <button id="confirm-override-btn"
        class="flex-1 px-4 py-3 rounded-xl bg-orange-500 text-black font-black text-xs uppercase tracking-wider hover:bg-orange-400 transition-all">
        CONFIRMER
      </button>
    </div>
  </div>
</dialog>
<script>
  
/* =========================
   üß† EDU COCKPIT (PLUG & PLAY)
========================= */

function computeEduMetrics(data) {
  const now = new Date();

  const signed = data.filter((d) => d.status === "signed");
  const sent = data.filter((d) => d.status === "sent");

  const riskyDeposits = signed.filter((s) => {
    if (s.deposit_paid) return false;
    if (s.study_data?.mode === "financement" && !s.deposit_amount)
      return false;
    const days = (now - new Date(s.signed_at || s.created_at)) / 86400000;
    return days > 10;
  });

  const veryHotLeads = sent.filter((s) => s.views >= 5);
  const coldSigned = signed.filter((s) => s.views < 2);

  const caSigned = signed.reduce(
    (t, s) => t + (s.study_data?.installCost || 0),
    0
  );
  const cashSecured = signed
    .filter((s) => s.deposit_paid)
    .reduce((t, s) => t + (s.deposit_amount || 0), 0);

  const riskScore = Math.min(
    100,
    riskyDeposits.length * 20 + coldSigned.length * 10
  );
  const cashScore = Math.min(100, (cashSecured / (caSigned || 1)) * 100);
  const salesScore = Math.min(100, veryHotLeads.length * 12);

  let mode = "ACC√âL√âRATION";
  if (riskScore > 60) mode = "URGENCE";
  else if (cashScore < 30) mode = "CHASSE CASH";
  else if (veryHotLeads.length > 6) mode = "CLOSING";

  return {
    signed,
    sent,
    riskyDeposits,
    veryHotLeads,
    coldSigned,
    caSigned,
    cashSecured,
    riskScore,
    cashScore,
    salesScore,
    mode,
  };
}


function updateSystemState(metrics) {
  const statusEl = document.getElementById("system-status-inline");
  if (!statusEl || !metrics) return;

  let icon = "üü¢";
  let text = "Syst√®me op√©rationnel";
  
  if (metrics.riskScore > 60) {
    icon = "üî¥";
    text = "Risque clients d√©tect√©";
  } else if (metrics.cashScore < 30) {
    icon = "üü†";
    text = "Pression cash";
  }
  
  statusEl.innerHTML = `${icon} ${text} ‚Ä¢ <span id="row-count-header">${fullData.length}</span> dossiers`;
}


function riskLabel(r) {
  if (r === "muet") return "üßä SILENCE ‚Äî client inactif";
  if (r === "agit√©") return "üî• RUMINATION ‚Äî risque d'annulation";
  if (r === "interesse") return "üü¢ INT√âR√äT ACTIF ‚Äî opportunit√©";
  return "‚ö™ STABLE ‚Äî surveillance";
}
function updateNextAction(metrics) {
  const title = document.getElementById("next-action-title");
  const desc = document.getElementById("next-action-desc");

  if (!title || !metrics) return;

  if (metrics.riskyDeposits.length > 0) {
    title.innerText = "S√©curiser acomptes";
    desc.innerText = metrics.riskyDeposits.length + " dossiers √† appeler aujourd‚Äôhui";
    return;
  }

  if (metrics.veryHotLeads.length > 0) {
    title.innerText = "Closer les leads chauds";
    desc.innerText = metrics.veryHotLeads.length + " opportunit√©s actives";
    return;
  }

  title.innerText = "Production / prospection";
  desc.innerText = "Aucune urgence d√©tect√©e";
}

/* =========================================================
   üß† EDU COCKPIT ‚Äî CLOSER MODE (UI) ‚Äî OPTIMIS√â
========================================================= */

function renderEduCockpitCloser(fullData, m) {
  const signed = fullData.filter((s) => s.status === "signed");

  const warRoom = signed.filter((s) => {
    if (!s.signed_at) return false;
    const days = (new Date() - new Date(s.signed_at)) / 86400000;
    return days <= 14;
  });

  const warRoomLabeled = warRoom.map((s) => {
    let risk = "stable";

    if (s.views === 0 && s.clicks === 0) risk = "muet";
    else if (s.views >= 6 && s.clicks === 0) risk = "agit√©";
    else if (s.clicks > 0) risk = "interesse";

    return { ...s, risk };
  });

  const riskZone = [];
  const hotZone = [];
  const stableZone = [];

  // ‚úÖ CALCUL DU CA PAR ZONE
  let riskCA = 0;
  let hotCA = 0;
  let muteCA = 0;
  let muteCount = 0;

  warRoomLabeled.forEach((s) => {
    const ca = s.study_data?.installCost || 0;

    if (s.risk === "muet" || s.risk === "agit√©") {
      riskZone.push(card(s));
      riskCA += ca;
      if (s.risk === "muet") {
        muteCA += ca;
        muteCount++;
      }
    } else if (s.risk === "interesse") {
      stableZone.push(card(s));
      hotCA += ca;
    } else {
      stableZone.push(card(s));
    }
  });

  // ‚úÖ RENDU UI
  const elRiskZone = document.getElementById("ec-risk-zone");
if (elRiskZone) {
  elRiskZone.innerHTML = riskZone.join("") || `<div class="text-slate-500 text-sm">Aucun risque d√©tect√©</div>`;
}

const elHotZone = document.getElementById("ec-hot-zone");
if (elHotZone) {
  elHotZone.innerHTML = hotZone.join("") || `<div class="text-slate-500 text-sm">Aucune opportunit√© chaude</div>`;
}

const elStableZone = document.getElementById("ec-stable-zone");
if (elStableZone) {
  elStableZone.innerHTML = stableZone.join("") || `<div class="text-slate-500 text-sm">Aucun dossier stable</div>`;
}

const elRiskCount = document.getElementById("ec-risk-count");
if (elRiskCount) elRiskCount.innerText = riskZone.length;

const elHotCount = document.getElementById("ec-hot-count");
if (elHotCount) elHotCount.innerText = hotZone.length;

const elMuteCount = document.getElementById("ec-mute-count");
if (elMuteCount) elMuteCount.innerText = muteCount;

const elRiskCA = document.getElementById("ec-risk-ca");
if (elRiskCA) elRiskCA.innerText = `${riskCA.toLocaleString("fr-FR")} ‚Ç¨`;

const elHotCA = document.getElementById("ec-hot-ca");
if (elHotCA) elHotCA.innerText = `${hotCA.toLocaleString("fr-FR")} ‚Ç¨`;

const elMuteCA = document.getElementById("ec-mute-ca");
if (elMuteCA) elMuteCA.innerText = `${muteCA.toLocaleString("fr-FR")} ‚Ç¨`;


  let priority = "Surveillance normale";
  if (riskZone.length > 0) priority = "S√©curiser les clients √† risque";
  else if (hotZone.length > 0) priority = "Closer les opportunit√©s actives";

  const priorityEl = document.getElementById("ec-priority");
if (priorityEl) {
  priorityEl.innerText = priority;
}

}

function card(s) {
  const badge =
    s.risk === "muet"
      ? "bg-cyan-500/20 text-cyan-300"
      : s.risk === "agit√©"
      ? "bg-red-500/20 text-red-300"
      : s.risk === "interesse"
      ? "bg-emerald-500/20 text-emerald-300"
      : "bg-slate-500/20 text-slate-300";

  const label =
    s.risk === "muet"
      ? "üßä Muet"
      : s.risk === "agit√©"
      ? "üî• Sur-engagement"
      : s.risk === "interesse"
      ? "üü¢ Dossier actif"
      : "‚ö™ Stable";

  return `
<div class="glass rounded-xl p-4 border border-slate-700/40 flex justify-between items-center">
  <div>
    <div class="font-bold text-slate-100">${s.name}</div>
    <div class="text-xs text-slate-400">
      ${s.views} vues ‚Ä¢ ${s.clicks} clics ‚Ä¢ sign√© il y a ${s.diffDays}j
    </div>
  </div>

  <div class="flex items-center gap-3">
    <span class="px-2 py-1 rounded-full text-[10px] font-bold ${badge}">
      ${label}
    </span>

    <a href="${FRONTEND_URL}/guest/${s.id}" target="_blank"
       class="px-3 py-1 text-xs rounded bg-white/10 hover:bg-white/20 transition">
       üìÇ
    </a>
  </div>
</div>`;
}

/* =========================
   CONSTANTES & VARIABLES
========================= */

const SUPABASE_URL = "https://ugwqfvwclwctzgtxcakp.supabase.co";
const SUPABASE_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnd3FmdndjbHdjdHpndHhjYWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNDg4OTgsImV4cCI6MjA4MTgyNDg5OH0.sx9z3p3svG5V6djfzUXtzdOwbUU3wjIVaAyIjRoFzaE";
const FRONTEND_URL = "https://nicolas-edf-solutions-solaires.vercel.app";
let supabaseClient;

let fullData = [];
let allLeadsData = [];
let logsData = [];
let isPriorityMode = false;
let hideSignedInAxeB = true; // ‚úÖ PAR D√âFAUT : masquer les sign√©s dans Axe B
let isZenMode = false;
let anomaliesDetected = [];
let settings = { view_threshold: 5, day_threshold: 3 };
let leadsToFollowup = 0;

let activeFilters = {
  search: "",
  views: null,
  clicks: null,
  status: null,
  optout: false,
};

let activeLeadFilters = {
  search: "",
  today: false,
  optedOut: false,
};

/* =========================
   FONCTIONS FILTRES
========================= */

function toggleFilter(type, value) {
  const btn = document.getElementById(
    `filter-${type}-${value.replace("+", "")}`
  );

  if (activeFilters[type] === value) {
    activeFilters[type] = null;
    btn.classList.remove("active");
  } else {
    if (type === "views") {
      document
        .querySelectorAll('[id^="filter-views"]')
        .forEach((b) => b.classList.remove("active"));
    } else if (type === "clicks") {
      document
        .querySelectorAll('[id^="filter-clicks"]')
        .forEach((b) => b.classList.remove("active"));
    } else if (type === "status") {
      document
        .querySelectorAll('[id^="filter-status"]')
        .forEach((b) => b.classList.remove("active"));
    } else if (type === "optout") {
      activeFilters.optout = !activeFilters.optout;
      btn.classList.toggle("active", activeFilters.optout);
      render();
      return;
    }

    activeFilters[type] = value;
    btn.classList.add("active");
  }

  render();
}

function applyFilters() {
  activeFilters.search = document
    .getElementById("search-input")
    .value.toLowerCase();
  render();
}

function resetFilters() {
  activeFilters = {
    search: "",
    views: null,
    clicks: null,
    status: null,
    optout: false,
  };
  document.getElementById("search-input").value = "";
  document
    .querySelectorAll(".filter-chip")
    .forEach((btn) => btn.classList.remove("active"));
  render();
}

function toggleLeadFilter(type) {
  let btnId = `filter-lead-${type}`;
  if (type === "opted-out") {
    btnId = "filter-lead-optout";
  }

  const btn = document.getElementById(btnId);

  if (!btn) {
    console.error("‚ùå Bouton introuvable:", btnId);
    return;
  }

  if (type === "today") {
    activeLeadFilters.today = !activeLeadFilters.today;
    btn.classList.toggle("active", activeLeadFilters.today);
  } else if (type === "opted-out") {
    activeLeadFilters.optedOut = !activeLeadFilters.optedOut;
    btn.classList.toggle("active", activeLeadFilters.optedOut);
  }

  renderEmailLeads();
}

function applyLeadsFilters() {
  activeLeadFilters.search = document
    .getElementById("search-leads-input")
    .value.toLowerCase();
  renderEmailLeads();
}

function resetLeadsFilters() {
  activeLeadFilters = {
    search: "",
    today: false,
    optedOut: false,
  };
  document.getElementById("search-leads-input").value = "";
  document
    .querySelectorAll("#filter-lead-today, #filter-lead-optout")
    .forEach((btn) => btn.classList.remove("active"));
  renderEmailLeads();
}

/* =========================
   FONCTIONS UTILITAIRES
========================= */

function getTimeSince(date) {
  const seconds = Math.floor((new Date() - new Date(date)) / 1000);
  let interval = seconds / 3600;
  if (interval > 24) return `ACTIF IL Y A ${Math.floor(interval / 24)}J`;
  if (interval >= 1) return `ACTIF IL Y A ${Math.floor(interval)}H`;
  return `ACTIF IL Y A ${Math.floor(seconds / 60)}MIN`;
}

function toggleZen() {
  isZenMode = !isZenMode;
  document.body.classList.toggle("mode-zen", isZenMode);
  document.getElementById("btn-zen").innerText = isZenMode
    ? "üëÅÔ∏è Mode Normal"
    : "üïäÔ∏è Mode Calme";
}

function setTemplate(t) {
  document.getElementById("justification-text").value = t;
}

function toggleRule(id) {
  const el = document.getElementById(`rule-${id}`);
  el.classList.toggle("hidden");
}

function scrollToLateDeposits() {
  const tbody = document.getElementById("signed-table-body");
  if (tbody) {
    tbody.scrollIntoView({ behavior: "smooth", block: "start" });
  }
}
function scrollToWarRoom() {
  const warRoom = document.getElementById('war-room-section');
  if (warRoom) {
    warRoom.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

// ‚úÖ NOUVELLE FONCTION : Toggle masquer/afficher sign√©s dans Axe B
function toggleHideSignedInAxeB() {
  hideSignedInAxeB = !hideSignedInAxeB;

  const btn = document.getElementById("btn-hide-signed");
  const text = document.getElementById("hide-signed-text");

  if (hideSignedInAxeB) {
    btn.classList.add(
      "bg-emerald-500/20",
      "border-emerald-500/50",
      "text-emerald-400"
    );
    btn.classList.remove(
      "bg-slate-800",
      "border-slate-700",
      "text-slate-400"
    );
    text.innerText = "üëÅÔ∏è AFFICHER SIGN√âS";
  } else {
    btn.classList.remove(
      "bg-emerald-500/20",
      "border-emerald-500/50",
      "text-emerald-400"
    );
    btn.classList.add(
      "bg-slate-800",
      "border-slate-700",
      "text-slate-400"
    );
    text.innerText = "üëÅÔ∏è MASQUER SIGN√âS";
  }

  render();
}

function togglePriority() {
  isPriorityMode = !isPriorityMode;
  document
    .getElementById("btn-priority")
    .classList.toggle("bg-orange-600", isPriorityMode);
  render();
}
// ========================================
// NOUVELLE LOGIQUE : ALERTE CRITIQUE
// ========================================

function updateCriticalAlert(metrics) {
  const alertBox = document.getElementById("critical-alert");
  const message = document.getElementById("alert-message");
  const amount = document.getElementById("alert-amount");
  const actionBtn = document.getElementById("alert-primary-action");
  
  // Calculer les dossiers critiques
  const critical = metrics.riskyDeposits.length;
  const criticalCA = metrics.riskyDeposits.reduce((sum, s) => 
    sum + (s.study_data?.installCost || 0), 0
  );
  
  if (critical === 0) {
    alertBox.classList.add("hidden");
    return;
  }
  
  alertBox.classList.remove("hidden");
  message.textContent = `${critical} DOSSIER${critical > 1 ? 'S' : ''} EN DANGER`;
  amount.textContent = `${criticalCA.toLocaleString("fr-FR")} ‚Ç¨ √Ä SAUVER AUJOURD'HUI`;
  
  // Action prioritaire
  const first = metrics.riskyDeposits[0];
  if (first) {
    actionBtn.textContent = `APPELER ${first.name.toUpperCase()}`;
    actionBtn.onclick = () => {
      window.open(`tel:${first.phone || ''}`, '_self');
      window.open(`${FRONTEND_URL}/guest/${first.id}`, '_blank');
    };
  }
}

function handlePrimaryAction() {
  const metrics = computeEduMetrics(fullData);
  if (metrics.riskyDeposits.length > 0) {
    const first = metrics.riskyDeposits[0];
    window.open(`${FRONTEND_URL}/guest/${first.id}`, '_blank');
  }
}

// ========================================
// REFONTE : WAR ROOM ACTION ZONE
// ========================================

function renderActionZone(metrics) {
  const container = document.getElementById("ec-action-zone");
  if (!container) return;
  
  // Prendre max 5 dossiers critiques
  const toShow = metrics.riskyDeposits.slice(0, 5);
  
  if (toShow.length === 0) {
    container.innerHTML = `
      <div class="text-center py-8 text-slate-500 italic">
        ‚úÖ Aucune action urgente ‚Äî Syst√®me stable
      </div>
    `;
    return;
  }
  
  container.innerHTML = toShow.map(s => {
    const ca = s.study_data?.installCost || 0;
    const daysSince = Math.floor((new Date() - new Date(s.signed_at || s.created_at)) / 86400000);
    
    let reason = "";
    let icon = "";
    
    if (!s.deposit_paid && daysSince > 10) {
      reason = `Acompte en retard : ${daysSince} jours`;
      icon = "üíÄ";
    } else if (s.views >= 6 && s.clicks === 0) {
      reason = `Sur-engagement critique (${s.views} vues, 0 clic)`;
      icon = "üî•";
    } else if (s.views < 2 && daysSince > 7) {
      reason = `Silence post-signature (${daysSince}j)`;
      icon = "üí§";
    }
    
    return `
      <div class="glass rounded-xl p-5 border-l-4 border-l-red-500 hover:border-l-red-400 transition-all">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-2">
              <span class="text-2xl">${icon}</span>
              <div>
                <div class="font-black text-lg text-slate-100">${s.name}</div>
                <div class="text-sm text-red-400 font-bold">${reason}</div>
              </div>
            </div>
            <div class="text-xs text-slate-400 mt-2">
              Risque : <span class="text-red-300 font-bold">${ca.toLocaleString("fr-FR")} ‚Ç¨</span>
              ‚Ä¢ Vues : ${s.views} ‚Ä¢ Clics : ${s.clicks}
            </div>
          </div>
          
          <div class="flex gap-2">
            <button onclick="window.open('tel:', '_self')" 
              class="px-4 py-2 bg-red-500 text-black font-black text-sm rounded-lg hover:bg-red-400 transition-all">
              üìû APPELER
            </button>
            <button onclick="window.open('${FRONTEND_URL}/guest/${s.id}', '_blank')"
              class="px-4 py-2 bg-slate-700 text-white font-bold text-sm rounded-lg hover:bg-slate-600 transition-all">
              üìÇ VOIR
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  document.getElementById("all-count").textContent = fullData.filter(s => s.status === "signed").length;
}
/* =========================
   üì° CHARGEMENT DONN√âES
========================= */

async function loadData() {
  try {
    console.log("üî• === D√âBUT loadData() ===");

    const { data: studies } = await supabaseClient
      .from("studies")
      .select("*, clients(*)");

    const { data: signedStudies } = await supabaseClient
      .from("studies")
      .select("*, clients(*)")
      .eq("status", "signed");

    let stats = [];
    const res = await supabaseClient
      .from("studies_activity_summary_v2")
      .select("*");

    if (res.error) {
      const res2 = await supabaseClient.from("email_stats").select("*");
      stats = res2.data || [];
    } else {
      stats = res.data || [];
    }

    window.safeStats = stats || [];

    const { data: logs } = await supabaseClient
      .from("decision_logs")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(20);

    logsData = logs || [];

    const { data: queueEmails } = await supabaseClient
      .from("email_queue")
      .select("study_id, email_type, status, sent_at, scheduled_for");

    window.queueEmails = queueEmails || [];

    window.antiAnnulationByStudy = {};
    queueEmails.forEach((e) => {
      if (!e.study_id || !e.email_type?.startsWith("anti_")) return;
      if (!window.antiAnnulationByStudy[e.study_id]) {
        window.antiAnnulationByStudy[e.study_id] = { sent: [], next: null };
      }
      if (e.status === "sent") {
        window.antiAnnulationByStudy[e.study_id].sent.push(e);
      }
      if (e.status === "pending") {
        const current = window.antiAnnulationByStudy[e.study_id].next;
        if (!current || new Date(e.scheduled_for) < new Date(current.scheduled_for)) {
          window.antiAnnulationByStudy[e.study_id].next = e;
        }
      }
    });

    window.postRefusByStudy = {};
    (queueEmails || [])
      .filter((q) => q.email_type?.startsWith("post_refus"))
      .forEach((q) => {
        if (!window.postRefusByStudy[q.study_id]) {
          window.postRefusByStudy[q.study_id] = { sent: [], next: null };
        }
        if (q.status === "sent") {
          window.postRefusByStudy[q.study_id].sent.push(q);
        }
        if (q.status === "pending") {
          const currentNext = window.postRefusByStudy[q.study_id].next;
          if (!currentNext || new Date(q.scheduled_for) < new Date(currentNext.scheduled_for)) {
            window.postRefusByStudy[q.study_id].next = q;
          }
        }
      });

    fullData = (studies || []).map((s) => {
      const st = (window.safeStats || []).find((item) => item.id === s.id) || {};
      const lastOpen = st.last_open_at || st.last_email_open || null;
const lastClick = st.last_click_at || null;

      const diffDays = (new Date() - new Date(s.created_at)) / 86400000;

      let views = 0;
      let clicks = 0;

      if (st.email_opens !== undefined) {
        views = st.email_opens || 0;
      } else if (st.views !== undefined) {
        views = st.views || 0;
      } else if (st.total_opens !== undefined) {
        views = st.total_opens || 0;
      }

      if (st.interactions !== undefined) {
        clicks = st.interactions || 0;
      } else if (st.clicks !== undefined) {
        clicks = st.clicks || 0;
      } else if (st.total_clicks !== undefined) {
        clicks = st.total_clicks || 0;
      }

      return {
        id: s.id,
        client_id: s.clients?.id || null,
        name: s.clients ? `${s.clients.first_name || ""} ${s.clients.last_name || ""}`.trim() : "Inconnu",
        email: s.clients?.email || "Pas d'email",
        status: s.status,
        created_at: s.created_at,
        signed_at: s.signed_at || null,
        study_data: s.study_data || null,
        deposit_amount: s.deposit_amount || 0,
        deposit_paid: s.deposit_paid || false,
        views: views,
        clicks: clicks,
        diffDays: Math.floor(diffDays),
        hasLog: logsData.some((l) => l.study_id === s.id),
        rib_sent: s.rib_sent || false,
        rib_sent_at: s.rib_sent_at || null,
        deposit_paid_at: s.deposit_paid_at || null,
        email_optout: s.clients?.email_optout || false,
        last_open: st.last_open || null,
        last_click: st.last_click || null,
        last_view: st.last_view || null,

  hasLog: logsData.some((l) => l.study_id === s.id),
  rib_sent: s.rib_sent || false,
  rib_sent_at: s.rib_sent_at || null,
  deposit_paid_at: s.deposit_paid_at || null,
  email_optout: s.clients?.email_optout || false,

      };
    });

    const metrics = computeEduMetrics(fullData);
    renderEduCockpitCloser(fullData, metrics);
    updateSystemState(metrics);
    updateNextAction(metrics);
    updateCriticalAlert(metrics);
    renderActionZone(metrics);
    document.getElementById("row-count-header").textContent = fullData.length;



    updateKPIs(queueEmails?.length || 0);
    detectAnomalies();

    loadSignedStudies();
    render();
    renderLogs();
  } catch (err) {
    console.error("‚ùå‚ùå‚ùå ERREUR CRITIQUE:", err);
    alert("ERREUR: " + err.message);
  }
}

/* =========================
   üí∞ STATS FINANCI√àRES OPTIMIS√âES
========================= */

function updateFinancialStats(studies) {
  const now = new Date();
  
  const secured = studies.filter((s) => s.deposit_paid);
  const cashSecured = secured.reduce(
    (sum, s) => sum + (s.study_data?.installCost || 0),
    0
  );

  const atRisk = studies.filter((s) => {
    if (s.deposit_paid) return false;
    const mode = s.study_data?.mode || "";
    const apport = s.study_data?.cashApport || 0;
    return mode === "cash" || (mode === "financement" && apport > 0);
  });
  const cashAtRisk = atRisk.reduce(
    (sum, s) => sum + (s.study_data?.installCost || 0),
    0
  );

  const late = studies.filter((s) => {
    if (s.deposit_paid) return false;
    const mode = s.study_data?.mode || "";
    const apport = s.study_data?.cashApport || 0;
    const acompteRequis = mode === "cash" || (mode === "financement" && apport > 0);
    if (!acompteRequis) return false;
    
    const signedDate = new Date(s.signed_at);
    const daysSince = Math.floor((now - signedDate) / (1000 * 60 * 60 * 24));
    return daysSince > 10;
  });

  const lateNames = late.map(s => s.name).join(", ") || "Aucun retard";

  const upcoming = atRisk
    .filter(s => s.signed_at)
    .map(s => ({
      name: s.name,
      date: new Date(s.signed_at),
      days: Math.floor((now - new Date(s.signed_at)) / (1000 * 60 * 60 * 24))
    }))
    .sort((a, b) => a.days - b.days)[0];

  const nextDeadlineDate = upcoming 
    ? new Date(upcoming.date.getTime() + 10 * 24 * 60 * 60 * 1000).toLocaleDateString("fr-FR")
    : "‚Äî";
  const nextDeadlineClient = upcoming ? upcoming.name : "Aucune √©ch√©ance proche";

  const elSecured = document.getElementById("stat-ca-secured");
  const elSecuredCount = document.getElementById("stat-secured-count");
  const elSecuredBar = document.getElementById("stat-secured-bar");
  const elRisk = document.getElementById("stat-ca-at-risk");
  const elRiskCount = document.getElementById("stat-risk-count");
  const elRiskBar = document.getElementById("stat-risk-bar");
  const elLateCount = document.getElementById("stat-late-count");
  const elLateNames = document.getElementById("stat-late-names");
  const elDeadlineDate = document.getElementById("stat-next-deadline-date");
  const elDeadlineClient = document.getElementById("stat-next-deadline-client");

  if (elSecured) elSecured.innerText = cashSecured.toLocaleString("fr-FR") + " ‚Ç¨";
  if (elSecuredCount) elSecuredCount.innerText = secured.length;
  if (elSecuredBar) elSecuredBar.style.width = Math.min(100, (secured.length / (studies.length || 1)) * 100) + "%";

  if (elRisk) elRisk.innerText = cashAtRisk.toLocaleString("fr-FR") + " ‚Ç¨";
  if (elRiskCount) elRiskCount.innerText = atRisk.length;
  if (elRiskBar) elRiskBar.style.width = Math.min(100, (atRisk.length / (studies.length || 1)) * 100) + "%";

  if (elLateCount) elLateCount.innerText = late.length;
  if (elLateNames) elLateNames.innerText = lateNames;

  if (elDeadlineDate) elDeadlineDate.innerText = nextDeadlineDate;
  if (elDeadlineClient) elDeadlineClient.innerText = nextDeadlineClient;

  const caTotal = studies.reduce(
    (sum, s) => sum + (s.study_data?.installCost || 0),
    0
  );
  const tauxConversion = studies.length > 0
    ? ((secured.length / studies.length) * 100).toFixed(0)
    : 0;

  const elTotal = document.getElementById("stat-ca-total");
  const elAcompte = document.getElementById("stat-ca-acompte");
  const elAttente = document.getElementById("stat-ca-attente");
  const elTaux = document.getElementById("stat-taux-acompte");

  if (elTotal) elTotal.innerText = caTotal.toLocaleString("fr-FR") + " ‚Ç¨";
  if (elAcompte) elAcompte.innerText = cashSecured.toLocaleString("fr-FR") + " ‚Ç¨";
  if (elAttente) elAttente.innerText = cashAtRisk.toLocaleString("fr-FR") + " ‚Ç¨";
  if (elTaux) elTaux.innerText = tauxConversion + "%";
  // DANS updateFinancialStats(), AJOUTER √Ä LA FIN :
document.getElementById("signed-total-count").textContent = studies.length;
}

/* =========================
   üéØ AUTRES FONCTIONS CRITIQUES
========================= */

function updateKPIs(queue) {
  const elTotal = document.getElementById("stat-total");
  const elSent = document.getElementById("stat-sent");
  const elSigned = document.getElementById("stat-signed");
  const elQueue = document.getElementById("stat-queue");
  const elHeader = document.getElementById("row-count-header");
  
  if (elTotal) elTotal.innerText = fullData.length;
  if (elSent) elSent.innerText = fullData.filter((s) => s.status === "sent").length;
  if (elSigned) elSigned.innerText = fullData.filter((s) => s.status === "signed").length;
  if (elQueue) elQueue.innerText = queue;
  if (elHeader) elHeader.innerText = fullData.length;
}

function detectAnomalies() {
  const anomalies = [];
  
  fullData.forEach((s) => {
    if (s.status === "sent" && s.views > settings.view_threshold && s.clicks === 0) {
      anomalies.push({
        id: s.id,
        name: s.name,
        type: "INT√âR√äT STAGNANT",
      });
    }
    if (s.status === "signed" && s.diffDays > settings.day_threshold && s.views < 2) {
      anomalies.push({
        id: s.id,
        name: s.name,
        type: "SILENCE POST-SIGNATURE",
      });
    }
  });

  anomaliesDetected = anomalies.map((a) => a.id);
  
  // Plus besoin d'afficher les badges (remplac√© par l'alerte critique)
  // On garde juste le tracking des IDs pour le mode priorit√©
}

async function updateStatus(id, newStatus) {
  const { error } = await supabaseClient
    .from("studies")
    .update({ status: newStatus })
    .eq("id", id);
  if (!error) loadData();
}

async function forceAction(id, name, newStatus) {
  const modal = document.getElementById("override-modal");
  const text = document.getElementById("justification-text");
  modal.showModal();
  document.getElementById("confirm-override-btn").onclick = async () => {
    const justification = text.value.trim();
    if (!justification) return alert("Justification obligatoire.");
    await supabaseClient.from("decision_logs").insert({
      study_id: id,
      client_name: name,
      action_performed: `FORCED_TO_${newStatus.toUpperCase()}`,
      justification: justification,
    });
    await updateStatus(id, newStatus);
    text.value = "";
    modal.close();
  };
}

function forceSign(studyId, clientName) {
  const modal = document.getElementById("override-modal");
  const text = document.getElementById("justification-text");
  modal.showModal();
  document.getElementById("confirm-override-btn").onclick = async () => {
    const justification = text.value.trim();
    if (!justification) return alert("Justification obligatoire.");
    await signStudySafe(studyId, clientName, true, justification);
    text.value = "";
    modal.close();
  };
}

async function cancelStudySafe(studyId, clientName) {
  if (!confirm("Confirmer l'annulation compl√®te de ce dossier ?")) return;
  await supabaseClient.from("studies").update({ status: "cancelled" }).eq("id", studyId);
  await supabaseClient.from("email_queue").update({ status: "cancelled" }).eq("study_id", studyId).in("status", ["pending", "scheduled"]);
  await supabaseClient.from("decision_logs").insert({
    study_id: studyId,
    client_name: clientName || "Inconnu",
    action_performed: "CANCELLED",
    justification: "Annulation depuis dashboard",
  });
  alert("Dossier annul√©. Emails stopp√©s.");
  loadData();
}

async function signStudySafe(studyId, clientName, forced = false, justification = null) {
  if (!forced && !confirm("Confirmer : dossier SIGN√â ?")) return;
  const { data, error } = await supabaseClient
    .from("studies")
    .update({ status: "signed" })
    .eq("id", studyId)
    .neq("status", "signed")
    .select()
    .single();
  if (error || !data) {
    alert("Impossible de signer : d√©j√† sign√© ou erreur.");
    return;
  }
  await supabaseClient.from("decision_logs").insert({
    study_id: studyId,
    client_name: clientName,
    action_performed: forced ? "FORCED_TO_SIGNED" : "SIGNED",
    justification: forced ? justification : "Signature depuis dashboard",
  });
  alert("Dossier sign√©. Automatisations d√©clench√©es.");
  loadData();
}

async function deleteLeadPermanently(clientId, email, clientName) {
  if (!confirm(`‚ö†Ô∏è SUPPRESSION D√âFINITIVE\n\nVoulez-vous vraiment supprimer d√©finitivement :\n\n${clientName}\n${email}\n\nCette action est IRR√âVERSIBLE !`)) return;
  const confirmText = prompt(`Pour confirmer, tapez le nom : ${clientName}`);
  if (confirmText !== clientName) {
    alert("Annul√©");
    return;
  }
  await supabaseClient.from("studies").delete().eq("client_id", clientId);
  await supabaseClient.from("email_queue").delete().eq("client_id", clientId);
  await supabaseClient.from("email_leads").delete().eq("client_id", clientId);
  await supabaseClient.from("clients").delete().eq("id", clientId);
  await supabaseClient.from("decision_logs").insert({
    action_performed: "LEAD_DELETED_PERMANENTLY",
    client_name: clientName,
    justification: `Suppression d√©finitive ${email}`,
  });
  alert("‚úÖ Lead supprim√© d√©finitivement");
  loadData();
  loadEmailLeads();
}

function renderLogs() {
  const container = document.getElementById("logs-container");
  const countEl = document.getElementById("logs-count");

  if (countEl) countEl.textContent = logsData.length;
  
  if (!container) return;
  
  if (logsData.length === 0) {
    container.innerHTML = `
      <div class="p-12 text-center text-slate-600 text-xs uppercase tracking-widest italic">
        Aucune archive de for√ßage...
      </div>
    `;
    return;
  }
  
  container.innerHTML = logsData.map((l) => {
    const date = new Date(l.created_at);
    const timeAgo = getTimeAgo(date);
    
    return `
      <div class="p-5 flex justify-between items-center hover:bg-white/[0.02] transition-all">
        <div class="flex flex-col flex-1">
          <div class="flex items-center gap-3 mb-1">
            <span class="text-[9px] text-orange-400 font-black uppercase tracking-wider px-2 py-1 bg-orange-500/10 rounded">
              ${l.action_performed}
            </span>
            <span class="text-sm font-bold text-slate-200">${l.client_name}</span>
          </div>
          <div class="text-xs text-slate-400 italic mt-1">"${l.justification}"</div>
        </div>
        <div class="text-[9px] text-slate-600 uppercase font-bold tracking-wider text-right">
          ${timeAgo}
        </div>
      </div>
    `;
  }).join("");
}

function getTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  
  if (seconds < 60) return "√Ä l'instant";
  if (seconds < 3600) return `Il y a ${Math.floor(seconds / 60)}min`;
  if (seconds < 86400) return `Il y a ${Math.floor(seconds / 3600)}h`;
  if (seconds < 604800) return `Il y a ${Math.floor(seconds / 86400)}j`;
  
  return date.toLocaleDateString("fr-FR");
}

async function loadSignedStudies() {
  const { data: signedStudies } = await supabaseClient
    .from("studies")
.select(`
  id,
  study_data,
  signed_at,
  deposit_paid,
  deposit_paid_at,
  deposit_amount,
  rib_sent,
  rib_sent_at,
  client_id,
  clients ( first_name, last_name, email, phone )
`)

    .eq("status", "signed")
    .order("signed_at", { ascending: false });

  const { data: stats } = await supabaseClient.from("studies_activity_summary_v2").select("*");

  const mergedData = (signedStudies || []).map((s) => {
  const st = (stats || []).find((item) => item.id === s.id) || {};

  const views = st.email_opens ?? st.views ?? st.total_opens ?? 0;
  const clicks = st.interactions ?? st.clicks ?? st.total_clicks ?? 0;

  return {
    id: s.id,
    client_id: s.client_id,
    client_name: s.clients
      ? `${s.clients.first_name || ""} ${s.clients.last_name || ""}`.trim()
      : "Inconnu",
    client_email: s.clients?.email || "Pas d'email",
    phone: s.clients?.phone || null,
    study_data: s.study_data,
    signed_at: s.signed_at,
    deposit_paid: s.deposit_paid,
    deposit_paid_at: s.deposit_paid_at,
    deposit_amount: s.deposit_amount,
    rib_sent: s.rib_sent,
    rib_sent_at: s.rib_sent_at,
    views,
    clicks,
    last_open: st.last_open || st.last_open_at || st.last_email_open || null,
    last_click: st.last_click || st.last_click_at || null
  };
});

  renderSignedStudies(mergedData);
  updateFinancialStats(signedStudies || []);
}
function renderSignedStudies(studies) {
  const container = document.getElementById("signed-list");
  if (!container) return;

  if (!studies || !studies.length) {
    container.innerHTML = `
      <div class="p-12 text-center text-slate-500 text-sm italic">
        Aucun dossier sign√©.
      </div>`;
    return;
  }

  const today = new Date();

  container.innerHTML = studies.map((s) => {
    const signedDate = new Date(s.signed_at);
    const daysSinceSigned = Math.floor((today - signedDate) / 86400000);
    const ca = s.study_data?.installCost || 0;

    let alerts = [];
    let cardClass = "glass border border-slate-700/40 hover:border-slate-600";
    
    const mode = s.study_data?.mode || "";
    const apport = s.study_data?.cashApport || 0;
    const acompteRequis = mode === "cash" || (mode === "financement" && apport > 0);

    if (daysSinceSigned > 15 && !s.deposit_paid && acompteRequis) {
      alerts.push("üíÄ RISQUE CRITIQUE");
      cardClass = "glass border-2 border-red-500/60 bg-red-500/5";
    } else if (!s.deposit_paid && daysSinceSigned > 10 && acompteRequis) {
      alerts.push("üö® ACOMPTE > 10J");
      cardClass = "glass border-2 border-orange-500/60 bg-orange-500/5";
    }

    const acompteStatus = s.deposit_paid
      ? `<span class="px-4 py-2 bg-emerald-500/20 border border-emerald-500 text-emerald-400 text-sm font-bold rounded-lg">‚úì RE√áU</span>`
      : s.rib_sent
      ? `<span class="px-4 py-2 bg-orange-500/20 border border-orange-500 text-orange-400 text-sm font-bold rounded-lg">‚è≥ RIB ENVOY√â</span>`
      : `<span class="text-slate-600 text-sm italic">En attente</span>`;

    return `
<div class="${cardClass} rounded-xl p-8 transition-all duration-300">
  <div class="grid grid-cols-[2fr_1.2fr_1fr_1fr_1fr_1.3fr] gap-6 items-center">

    <!-- CLIENT -->
    <div class="flex items-center gap-4 min-w-0">
      <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500/30 to-emerald-500/30 flex items-center justify-center border border-blue-500/30 shrink-0">
        <span class="text-3xl">üë§</span>
      </div>
      <div class="min-w-0">
        <div class="flex items-center gap-2 mb-2 flex-wrap">
          <span class="font-bold text-slate-100 text-lg">${s.client_name}</span>
          ${window.postRefusByStudy?.[s.id] 
            ? `<span class="px-3 py-1.5 rounded bg-red-500/20 border border-red-500/40 text-[11px] text-red-400 font-black">POST-REFUS</span>`
            : ""}
        </div>
        <div class="text-base text-slate-400 truncate">${s.client_email || ""}</div>
      </div>
    </div>

    <!-- SEQUENCES -->
    <div class="flex flex-col gap-2">
      ${window.antiAnnulationByStudy?.[s.id] ? (() => {
        const flow = window.antiAnnulationByStudy[s.id];
        const lastSent = flow.sent.length > 0 
          ? flow.sent[flow.sent.length - 1]
          : null;
        const nextEmail = flow.next;
        
        return `
          <div class="px-4 py-2.5 rounded-lg bg-emerald-500/10 border border-emerald-500/30">
            <div class="text-emerald-400 font-black text-[13px] mb-2">üõ° ANTI-ANNULATION</div>
            ${lastSent ? `
              <div class="text-[11px] text-slate-400">
                Dernier : ${lastSent.email_type.replace('anti_', '').replace(/_/g, ' ')} 
                (${new Date(lastSent.sent_at).toLocaleDateString('fr-FR')})
              </div>
            ` : '<div class="text-[11px] text-slate-500 italic">Aucun envoi</div>'}
            ${nextEmail ? `
              <div class="text-[11px] text-orange-400 font-bold mt-1.5">
                Prochain : ${nextEmail.email_type.replace('anti_', '').replace(/_/g, ' ')} 
                ‚Üí ${new Date(nextEmail.scheduled_for).toLocaleDateString('fr-FR')}
              </div>
            ` : '<div class="text-[11px] text-slate-500">S√©quence termin√©e</div>'}
          </div>
        `;
      })() : ""}
      
      ${window.emailFlowByClient?.[s.client_id] ? (() => {
        const flow = window.emailFlowByClient[s.client_id];
        return `
          <div class="px-4 py-2.5 rounded-lg bg-blue-500/10 border border-blue-500/30">
            <div class="text-blue-400 font-black text-[12px]">üì¨ EMAIL STEP ${flow.step}</div>
            ${flow.next ? `
              <div class="text-[11px] text-orange-400 font-bold mt-1.5">
                ‚Üí ${new Date(flow.next).toLocaleDateString('fr-FR')}
              </div>
            ` : '<div class="text-[11px] text-slate-500">Aucun prochain</div>'}
          </div>
        `;
      })() : ""}
      
      ${!window.antiAnnulationByStudy?.[s.id] && !window.emailFlowByClient?.[s.client_id]
        ? `<span class="text-[12px] text-slate-500 italic">Aucune s√©quence</span>`
        : ""}
    </div>

    <!-- CA -->
    <div class="text-center">
      <div class="text-4xl font-black text-emerald-400">${ca.toLocaleString("fr-FR")} ‚Ç¨</div>
    </div>

    <!-- ENGAGEMENT -->
<div class="flex flex-col items-center gap-2">

  <div class="flex justify-center gap-6">
    <div class="text-center">
      <div class="text-3xl font-black text-slate-300">${s.views || 0}</div>
      <div class="text-xs text-slate-500 font-bold mt-1.5">VUES</div>
    </div>

    <div class="text-center">
      <div class="text-3xl font-black text-slate-300">${s.clicks || 0}</div>
      <div class="text-xs text-slate-500 font-bold mt-1.5">CLICS</div>
    </div>
  </div>

  <div class="text-[11px] text-slate-500 font-bold mt-1">
    ${
      s.last_click
        ? `Dernier clic : ${new Date(s.last_click).toLocaleDateString("fr-FR")}`
        : s.last_open
        ? `Derni√®re ouverture : ${new Date(s.last_open).toLocaleDateString("fr-FR")}`
        : "Aucune activit√© email"
    }
  </div>

</div>


    <!-- ACOMPTE -->
    <div class="text-center">
      ${acompteStatus}
    </div>

    <!-- SIGNATURE + ACTIONS -->
    <div class="flex flex-col gap-3">
      <div class="text-center">
        <div class="text-lg font-bold text-slate-300">${signedDate.toLocaleDateString("fr-FR")}</div>
        <div class="text-base text-slate-400 mt-1.5">il y a ${daysSinceSigned}j</div>
        ${alerts.length > 0 ? `<div class="text-base font-bold text-orange-400 mt-2">${alerts.join(" ")}</div>` : ""}
      </div>

      ${!s.deposit_paid && acompteRequis ? `
        <button onclick="markDepositPaid('${s.id}')"
          class="px-6 py-3 text-sm font-black rounded-lg bg-emerald-500 hover:bg-emerald-400 text-black shadow-lg shadow-emerald-500/20 transition-all">
          ‚úì VALIDER ACOMPTE
        </button>
      ` : ""}
    </div>

  </div>
</div>`;
  }).join("");
}

async function markDepositPaid(studyId) {
  if (!confirm("Confirmer la r√©ception de l'acompte ?")) return;
  
  const { error } = await supabaseClient
    .from("studies")
    .update({ 
      deposit_paid: true,
      deposit_paid_at: new Date().toISOString()
    })
    .eq("id", studyId);
    
  if (error) {
    alert("‚ùå Erreur : " + error.message);
    return;
  }
  
  await supabaseClient.from("decision_logs").insert({
    study_id: studyId,
    action_performed: "DEPOSIT_PAID_CONFIRMED",
    justification: "Acompte valid√© depuis dashboard"
  });
  
  alert("‚úÖ Acompte valid√© !");
  loadSignedStudies();
  loadData();
}

async function markRibSent(studyId) {
  if (!confirm("Confirmer l'envoi du RIB au client ?")) return;
  
  const { error } = await supabaseClient
    .from("studies")
    .update({ 
      rib_sent: true,
      rib_sent_at: new Date().toISOString()
    })
    .eq("id", studyId);
    
  if (error) {
    alert("‚ùå Erreur : " + error.message);
    return;
  }
  
  await supabaseClient.from("decision_logs").insert({
    study_id: studyId,
    action_performed: "RIB_SENT_CONFIRMED",
    justification: "RIB marqu√© comme envoy√© depuis dashboard"
  });
  
  alert("‚úÖ RIB marqu√© comme envoy√© !");
  loadSignedStudies();
  loadData();
}

async function setOptOut(email) {
if (!confirm("Confirmer l'exclusion de ce lead ?")) return;
const { data } = await supabaseClient.from("clients").update({ email_optout: true }).eq("email", email).select();
if (!data || data.length === 0) {
alert("‚ùå ERREUR : Aucun client trouv√© avec cet email");
return;
}
await supabaseClient.from("email_queue").update({ status: "cancelled" }).eq("client_id", data[0].id).in("status", ["pending", "scheduled"]);
await supabaseClient.from("decision_logs").insert({
client_name: data[0].first_name + " " + data[0].last_name,
action_performed: "EMAIL_OPTOUT",
justification: "D√©sabonnement depuis dashboard",
});
alert("‚úÖ Client d√©sabonn√© avec succ√®s !");
loadEmailLeads();
loadData();
}
function updateUnsubscribeStats() {
const totalOptedOut = allLeadsData.filter((l) => l.opted_out).length;
const total = allLeadsData.length;
const rate = total > 0 ? ((totalOptedOut / total) * 100).toFixed(1) : 0;
document.getElementById("stat-optout-total").innerText = totalOptedOut;
document.getElementById("stat-optout-today").innerText = 0;
document.getElementById("stat-optout-rate").innerText = rate + "%";
}
</script>
<script>
/* =========================
         üéØ RENDER() ‚Äî TABLEAU PRINCIPAL (AXE B)
      ========================= */

      function render() {
  const container = document.getElementById("pipeline-list");
  if (!container) return;

  let list = isPriorityMode
    ? fullData.filter(
        (s) =>
          anomaliesDetected.includes(s.id) || s.views >= 3 || s.clicks > 0
      )
    : fullData;

  if (hideSignedInAxeB) {
    list = list.filter((s) => s.status !== "signed");
  }

  list = list.filter((s) => {
    if (activeFilters.search) {
      const searchLower = activeFilters.search;
      const matchName = s.name.toLowerCase().includes(searchLower);
      const matchEmail = s.email.toLowerCase().includes(searchLower);
      if (!matchName && !matchEmail) return false;
    }

    if (activeFilters.views) {
      const threshold = parseInt(activeFilters.views);
      if (s.views < threshold) return false;
    }

    if (activeFilters.clicks) {
      const threshold = parseInt(activeFilters.clicks);
      if (s.clicks < threshold) return false;
    }

    if (activeFilters.status && s.status !== activeFilters.status) {
      return false;
    }

    if (activeFilters.optout && !s.email_optout) {
      return false;
    }

    return true;
  });

  document.getElementById("filtered-count").innerText = list.length;

  container.innerHTML = list
    .map((s) => {
      const hasAlert = anomaliesDetected.includes(s.id);
      const safeName = s.name.replace(/'/g, "\\'");
      const isOptedOut = s.email_optout || false;
      const isCancelled = s.status === "cancelled";
      const isInactive = isOptedOut || isCancelled;

      let tempLabel = "FROID";
      let tempClass = "bg-slate-500/20 text-slate-300 border-slate-500";

      if (s.status === "signed") {
        tempLabel = "SIGN√â";
        tempClass = "bg-emerald-500/20 text-emerald-300 border-emerald-500";
      } else if (s.clicks > 0) {
        tempLabel = "CHAUD";
        tempClass = "bg-orange-500/20 text-orange-300 border-orange-500";
      } else if (s.views >= 2) {
        tempLabel = "TI√àDE";
        tempClass = "bg-blue-500/20 text-blue-300 border-blue-500";
      }

      let cardClass = "glass border border-slate-700/40 hover:border-slate-600";
      
      if (isInactive) {
        cardClass = "glass border border-slate-800/40 opacity-50";
      } else if (s.status === "signed") {
        cardClass = "glass border-2 border-emerald-500/60 bg-emerald-500/5";
      } else if (hasAlert) {
        cardClass = "glass border-2 border-red-500/60 bg-red-500/5";
      }

      const onChangeStatus = hasAlert
        ? `forceAction('${s.id}', '${safeName}', this.value)`
        : `updateStatus('${s.id}', this.value)`;

      const onClickSigned = hasAlert
        ? `forceSign('${s.id}', '${safeName}')`
        : `signStudySafe('${s.id}', '${safeName}')`;

      return `
<div class="${cardClass} rounded-xl p-6 transition-all duration-300 cursor-pointer"
     onclick="window.open('${FRONTEND_URL}/guest/${s.id}', '_blank')">
  
  <div class="grid grid-cols-[2fr_1.2fr_1fr_1fr_1.3fr] gap-6 items-center">

    <!-- CLIENT -->
    <div class="flex items-center gap-4 min-w-0">
      <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500/30 to-purple-500/30 flex items-center justify-center border border-blue-500/30 shrink-0">
        <span class="text-3xl">üë§</span>
      </div>
      <div class="min-w-0">
        <div class="flex items-center gap-2 mb-2 flex-wrap">
          <span class="font-bold text-slate-100 text-lg ${isInactive ? 'line-through text-slate-600' : ''}">${s.name}</span>
          <span class="px-3 py-1.5 rounded-full text-[11px] font-black border ${tempClass}">${tempLabel}</span>
          ${isOptedOut ? '<span class="px-2.5 py-1.5 bg-red-500 text-white text-[11px] font-black rounded">D√âSABONN√â</span>' : ''}
          ${isCancelled ? '<span class="px-2.5 py-1.5 bg-slate-600 text-white text-[11px] font-black rounded">ANNUL√â</span>' : ''}
        </div>
        <div class="text-base text-slate-400 truncate">${s.email}</div>
        <div class="text-[11px] text-slate-600 uppercase tracking-wider font-bold mt-1.5">
          ${getTimeSince(s.created_at)}
        </div>
      </div>
    </div>

    <!-- S√âQUENCE -->
    <div class="flex flex-col gap-2">
      ${window.postRefusByStudy?.[s.id] ? (() => {
        const flow = window.postRefusByStudy[s.id];
        return `
          <div class="px-4 py-2.5 rounded-lg border border-red-500/30 bg-red-500/10">
            <div class="text-red-400 font-black text-[12px]">‚úñ POST-REFUS ${flow.sent.length}/4</div>
            <div class="text-[11px] text-orange-400 font-bold mt-1">
              ‚Üí ${flow.next ? new Date(flow.next.scheduled_for).toLocaleDateString('fr-FR') : 'termin√©'}
            </div>
          </div>
        `;
      })() : ''}
      
      ${window.emailFlowByClient?.[s.client_id] ? `
        <div class="px-4 py-2.5 rounded-lg border border-blue-500/30 bg-blue-500/10">
          <div class="text-blue-400 font-black text-[12px]">üì¨ STEP ${window.emailFlowByClient[s.client_id].step}</div>
          <div class="text-[11px] text-orange-400 font-bold mt-1">
            ‚Üí ${window.emailFlowByClient[s.client_id].next 
              ? new Date(window.emailFlowByClient[s.client_id].next).toLocaleDateString('fr-FR')
              : 'aucun'}
          </div>
        </div>
      ` : ''}
      
      ${!window.postRefusByStudy?.[s.id] && !window.emailFlowByClient?.[s.client_id]
        ? '<span class="text-[12px] text-slate-500 italic">Aucune s√©quence</span>'
        : ''}
    </div>

    <!-- ENGAGEMENT -->
<div class="flex flex-col items-center gap-2">

  <div class="flex justify-center gap-8">
    <div class="text-center">
      <div class="text-3xl font-black ${s.views >= 3 ? 'text-orange-400' : 'text-slate-400'}">${s.views}</div>
      <div class="text-xs text-slate-500 font-bold mt-1.5">VUES</div>
    </div>

    <div class="text-center">
      <div class="text-3xl font-black ${s.clicks > 0 ? 'text-purple-400' : 'text-slate-400'}">${s.clicks}</div>
      <div class="text-xs text-slate-500 font-bold mt-1.5">CLICS</div>
    </div>
  </div>

  <div class="text-[11px] text-slate-500 font-bold mt-1">
    ${
      s.last_click
        ? `Dernier clic : ${new Date(s.last_click).toLocaleDateString("fr-FR")}`
        : s.last_open
        ? `Derni√®re ouverture : ${new Date(s.last_open).toLocaleDateString("fr-FR")}`
        : "Aucune activit√© email"
    }
  </div>

</div>


    <!-- STATUT -->
    <div class="flex justify-center" onclick="event.stopPropagation();">
      <select onchange="${onChangeStatus}"
        class="px-5 py-2.5 rounded-xl border font-black uppercase text-[11px] tracking-wider ${
          s.status === "signed"
            ? "border-emerald-500/50 text-emerald-400 bg-emerald-500/10"
            : s.status === "sent"
            ? "border-blue-500/50 text-blue-400 bg-blue-500/10"
            : "border-slate-600/50 text-slate-400 bg-slate-800/50"
        }">
        <option value="sent" ${s.status === "sent" ? "selected" : ""}>SENT</option>
        <option value="draft" ${s.status === "draft" ? "selected" : ""}>DRAFT</option>
        <option value="signed" ${s.status === "signed" ? "selected" : ""}>SIGNED</option>
        <option value="cancelled" ${s.status === "cancelled" ? "selected" : ""}>CANCELLED</option>
      </select>
    </div>

    <!-- ACTIONS -->
    <div class="flex items-center justify-end gap-2" onclick="event.stopPropagation();">
      <button
        ${isInactive ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}
        onclick="${isInactive ? '' : onClickSigned}"
        class="px-5 py-2.5 ${hasAlert && !isInactive
          ? 'bg-orange-500 text-black border border-orange-400'
          : 'bg-emerald-500 text-black border border-emerald-400'
        } rounded-lg font-bold text-sm uppercase tracking-wide hover:scale-105 transition-all">
        ${hasAlert && !isInactive ? '‚ö†Ô∏è FORCER' : '‚úì SIGN√â'}
      </button>

      <button onclick="updateStatus('${s.id}', 'draft')"
        class="w-11 h-11 flex items-center justify-center bg-slate-900 text-blue-400 border border-blue-500/40 rounded-lg hover:bg-blue-500 hover:text-white transition-all text-xl">
        üìù
      </button>

      <button onclick="cancelStudySafe('${s.id}', '${safeName}')"
        class="w-11 h-11 flex items-center justify-center bg-slate-900 text-red-400 border border-red-500/40 rounded-lg hover:bg-red-500 hover:text-white transition-all text-xl">
        ‚úï
      </button>

      ${isInactive ? `
        <button onclick="deleteLeadPermanently('${s.client_id}', '${s.email.replace(/'/g, "\\'")}', '${safeName}')"
          class="w-11 h-11 flex items-center justify-center bg-slate-900 text-red-600 border-2 border-red-600 rounded-lg hover:bg-red-600 hover:text-white transition-all text-xl">
          üóëÔ∏è
        </button>
      ` : ''}
    </div>

  </div>
</div>`;
    })
    .join("");
}
function updateAxeCStats(leads, queueEmails) {
  const today = new Date().toISOString().slice(0, 10);

  const optedOut = leads.filter(l => l.email_optout);
  const optedOutToday = optedOut.filter(l => 
    l.updated_at && l.updated_at.startsWith(today)
  );

  const total = leads.length || 1;

  document.getElementById("stat-optout-total").innerText = optedOut.length;
  document.getElementById("stat-optout-today").innerText = optedOutToday.length;
  document.getElementById("stat-optout-rate").innerText =
    Math.round((optedOut.length / total) * 100) + "%";

  const todayEmails = (queueEmails || []).filter(e =>
    e.status === "pending" &&
    e.scheduled_for &&
    e.scheduled_for.startsWith(today)
  );

  document.getElementById("email-today-count").innerText = todayEmails.length;
}

async function loadEmailLeads() {
  try {
    // 1Ô∏è‚É£ Charger les leads emails
    const { data, error } = await supabaseClient
      .from("email_leads")
      .select(
        "id, client_id, created_at, last_email_sent_at, next_email_scheduled_at, email_step, total_opens, total_clicks, last_opened_at, last_clicked_at, clients!inner(id, first_name, last_name, email, email_optout)"
      )
      .order("next_email_scheduled_at", { ascending: true });

    if (error) {
      console.error("‚ùå Erreur chargement leads:", error);
      return;
    }

    // 2Ô∏è‚É£ Charger les studies pour faire le lien client_id -> study_id
    const clientIds = data.map(l => l.client_id).filter(Boolean);
    
    const { data: studies } = await supabaseClient
      .from("studies")
      .select("id, client_id")
      .in("client_id", clientIds);

    console.log("üìö Studies trouv√©es:", studies?.length || 0);

    // 3Ô∏è‚É£ Cr√©er l'index client_id -> study_id
    const studyIdByClientId = {};
    (studies || []).forEach(s => {
      if (s.client_id) {
        studyIdByClientId[s.client_id] = s.id;
      }
    });

    const studyIds = Object.values(studyIdByClientId).filter(Boolean);

    // 4Ô∏è‚É£ Charger les DERNIERS √©v√©nements d'ouverture depuis tracking_events
    let lastOpenByStudyId = {};
    let lastClickByStudyId = {};

    if (studyIds.length > 0) {
      // Ouvertures
      const { data: openEvents } = await supabaseClient
        .from("tracking_events")
        .select("study_id, created_at")
        .in("study_id", studyIds)
        .eq("event_type", "email_open")
        .order("created_at", { ascending: false });

      (openEvents || []).forEach(event => {
        if (!lastOpenByStudyId[event.study_id]) {
          lastOpenByStudyId[event.study_id] = event.created_at;
        }
      });

      // Clics
      const { data: clickEvents } = await supabaseClient
        .from("tracking_events")
        .select("study_id, created_at")
        .in("study_id", studyIds)
        .eq("event_type", "email_click")
        .order("created_at", { ascending: false });

      (clickEvents || []).forEach(event => {
        if (!lastClickByStudyId[event.study_id]) {
          lastClickByStudyId[event.study_id] = event.created_at;
        }
      });

      console.log("üìä Ouvertures trouv√©es:", Object.keys(lastOpenByStudyId).length);
      console.log("üìä Clics trouv√©s:", Object.keys(lastClickByStudyId).length);
    }

    // 5Ô∏è‚É£ Mapper avec fusion
    allLeadsData = (data || []).map((l) => {
      const studyId = studyIdByClientId[l.client_id];
      
      // Priorit√© : email_leads > tracking_events
      const lastOpen = l.last_opened_at || (studyId ? lastOpenByStudyId[studyId] : null) || null;
      const lastClick = l.last_clicked_at || (studyId ? lastClickByStudyId[studyId] : null) || null;
      
      return {
        id: l.id,
        client_id: l.client_id,
        created_at: l.created_at,
        name: l.clients
          ? `${l.clients.first_name || ""} ${l.clients.last_name || ""}`.trim()
          : "Inconnu",
        email: l.clients?.email || "Pas d'email",
        last_email_sent: l.last_email_sent_at || null,
        next_email_date: l.next_email_scheduled_at || null,
        email_sequence_step: l.email_step || 0,
        opted_out: l.clients?.email_optout || false,
        total_opens: l.total_opens || 0,
        total_clicks: l.total_clicks || 0,
        last_open: lastOpen,
        last_click: lastClick,
      };
    });

    console.log("‚úÖ EMAIL LEADS fusionn√©s:", allLeadsData.length);
    const withActivity = allLeadsData.filter(l => l.last_open || l.last_click);
    console.log("üìß Leads avec dates d'activit√©:", withActivity.length);
    if (withActivity.length > 0) {
      console.log("üìß Exemples:", withActivity.slice(0, 3));
    }

    updateAxeCStats(allLeadsData, window.queueEmails);
    renderEmailLeads();
    updateUnsubscribeStats();

    leadsToFollowup = (allLeadsData || []).filter((l) => {
      if (l.opted_out) return false;
      if (!l.last_email_sent) return true;

      const now = new Date();
      const created = new Date(l.created_at);
      const lastSent = new Date(l.last_email_sent);

      const daysSinceCreation = (now - created) / (1000 * 60 * 60 * 24);
      const daysSinceLastEmail = (now - lastSent) / (1000 * 60 * 60 * 24);

      if (daysSinceCreation > 120) return false;
      if (daysSinceCreation <= 60 && daysSinceLastEmail >= 3) return true;
      if (daysSinceCreation > 60 && daysSinceLastEmail >= 7) return true;

      return false;
    }).length;

    console.log("üìä Leads √† relancer calcul√©s:", leadsToFollowup);

    window.emailFlowByClient = {};
    allLeadsData.forEach((l) => {
      window.emailFlowByClient[l.client_id] = {
        step: l.email_sequence_step,
        last: l.last_email_sent,
        next: l.next_email_date,
        opens: l.total_opens,
        clicks: l.total_clicks,
        opted_out: l.opted_out,
      };
    });

    console.log("üì¨ EMAIL FLOW INDEX:", Object.keys(window.emailFlowByClient).length, "clients");

  } catch (err) {
    console.error("‚ùå ERREUR CRITIQUE loadEmailLeads:", err);
  }
}
    function renderEmailLeads() {
  const container = document.getElementById("leads-email-body");
  if (!container) return;

  const today = new Date().toISOString().split("T")[0];

  let list = [...allLeadsData];

  list = list.filter((l) => {
    if (activeLeadFilters.search) {
      const searchLower = activeLeadFilters.search;
      const matchName = l.name.toLowerCase().includes(searchLower);
      const matchEmail = l.email.toLowerCase().includes(searchLower);
      if (!matchName && !matchEmail) return false;
    }

    if (activeLeadFilters.today) {
      const nextDate = l.next_email_date?.split("T")[0];
      if (nextDate !== today || l.opted_out) return false;
    }

    if (activeLeadFilters.optedOut && !l.opted_out) {
      return false;
    }

    return true;
  });

  document.getElementById("filtered-lead-count").innerText = list.length;

  const todayCount = allLeadsData.filter(
    (l) => l.next_email_date?.split("T")[0] === today && !l.opted_out
  ).length;
  document.getElementById("email-today-count").innerText = todayCount;

  container.innerHTML = list
    .map((l) => {
      const nextDate = l.next_email_date?.split("T")[0];
      const isToday = nextDate === today;
      const lastSent = l.last_email_sent
        ? new Date(l.last_email_sent).toLocaleDateString("fr-FR")
        : "Jamais";

      const getNextFollowup = () => {
        if (!l.last_email_sent) return "Imm√©diat";

        const created = new Date(l.created_at);
        const lastSentDate = new Date(l.last_email_sent);
        const now = new Date();
        const daysSinceCreation = Math.floor(
          (now - created) / (1000 * 60 * 60 * 24)
        );
        const daysSinceLastEmail = Math.floor(
          (now - lastSentDate) / (1000 * 60 * 60 * 24)
        );

        if (daysSinceCreation > 120) return "Termin√©";

        if (daysSinceCreation <= 60) {
          if (daysSinceLastEmail >= 3) return "D√ª";
          const next = new Date(lastSentDate);
          next.setDate(next.getDate() + 3);
          return next.toLocaleDateString("fr-FR");
        }

        if (daysSinceLastEmail >= 7) return "D√ª";
        const next = new Date(lastSentDate);
        next.setDate(next.getDate() + 7);
        return next.toLocaleDateString("fr-FR");
      };

      const nextSend = getNextFollowup();
      const isOptedOut = l.opted_out;

      let cardClass = "glass border border-slate-700/40 hover:border-slate-600";
      if (isOptedOut) {
        cardClass = "glass border border-slate-800/40 opacity-50";
      } else if (isToday) {
        cardClass = "glass border-2 border-orange-500/60 bg-orange-500/5";
      }

      return `
<div class="${cardClass} rounded-xl p-6 pr-8 transition-all duration-300">
  <div class="grid grid-cols-[30%_15%_20%_20%_15%] gap-6 items-center pr-6">

    <!-- LEAD -->
    <div class="flex items-center gap-4 min-w-0">
      <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-500/30 to-pink-500/30 flex items-center justify-center border border-purple-500/30 shrink-0">
        <span class="text-3xl">üìß</span>
      </div>
      <div class="min-w-0">
        <div class="flex items-center gap-2 mb-2 flex-wrap">
          <span class="font-bold text-slate-100 text-lg ${isOptedOut ? 'line-through text-slate-600' : ''}">${l.name}</span>
          ${isOptedOut ? '<span class="px-2.5 py-1.5 bg-red-500 text-white text-[11px] font-black rounded">D√âSABONN√â</span>' : ''}
        </div>
        <div class="text-base text-slate-400 truncate">${l.email}</div>
        <div class="text-[11px] text-slate-600 uppercase tracking-wider font-bold mt-1.5">
          √âTAPE ${l.email_sequence_step}
        </div>
      </div>
    </div>

    <!-- ENGAGEMENT -->
<div class="flex flex-col items-center gap-2">

  <div class="flex justify-center gap-8">
    <div class="text-center">
      <div class="text-3xl font-black ${l.total_opens > 0 ? 'text-blue-400' : 'text-slate-400'}">${l.total_opens}</div>
      <div class="text-xs text-slate-500 font-bold mt-1.5">üëÅÔ∏è VUES</div>
    </div>

    <div class="text-center">
      <div class="text-3xl font-black ${l.total_clicks > 0 ? 'text-green-400' : 'text-slate-400'}">${l.total_clicks}</div>
      <div class="text-xs text-slate-500 font-bold mt-1.5">üñ±Ô∏è CLICS</div>
    </div>
  </div>

  <div class="text-[11px] text-slate-500 font-bold mt-1">
    ${
      l.last_click
        ? `üñ±Ô∏è Dernier clic : ${new Date(l.last_click).toLocaleDateString("fr-FR")}`
        : l.last_open
        ? `üëÅÔ∏è Derni√®re ouverture : ${new Date(l.last_open).toLocaleDateString("fr-FR")}`
        : l.last_email_sent
        ? `üìß Email envoy√© le ${new Date(l.last_email_sent).toLocaleDateString("fr-FR")}`
        : "Jamais contact√©"
    }
  </div>

</div>


    <!-- DERNIER EMAIL -->
    <div class="text-center">
      <div class="text-base font-bold text-slate-300">${lastSent}</div>
    </div>

    <!-- PROCHAINE RELANCE -->
    <div class="text-center">
      <div class="text-base font-bold ${isToday ? 'text-orange-400' : 'text-slate-300'}">${nextSend}</div>
      ${isToday ? '<div class="text-[11px] text-orange-400 uppercase font-black tracking-wider mt-2">üîî AUJOURD\'HUI</div>' : ''}
    </div>

    <!-- ACTIONS -->
    <div class="flex justify-center items-center">
      ${isOptedOut ? `
        <div class="flex flex-col gap-2" style="width: 140px;">
          <button disabled
            class="w-full px-3 py-2 text-[10px] font-black uppercase tracking-wider bg-red-500/20 border border-red-500/50 text-red-400 rounded-lg cursor-not-allowed">
            D√âSABONN√â
          </button>
          <button onclick="deleteLeadPermanently('${l.client_id}', '${l.email.replace(/'/g, "\\'")}', '${l.name.replace(/'/g, "\\'")}')"
            class="w-full px-3 py-2 bg-red-600/20 border border-red-600/60 text-red-400 font-black rounded-lg hover:bg-red-600/30 transition-all uppercase text-[10px] tracking-wider">
            üóëÔ∏è SUPPR
          </button>
        </div>
      ` : `
        <button onclick="setOptOut('${l.email.replace(/'/g, "\\'")}')"
          style="width: 140px;"
          class="px-3 py-2.5 text-[11px] font-black uppercase tracking-wider bg-slate-800 border border-slate-600 rounded-lg hover:bg-red-500 hover:text-white hover:border-red-500 transition-all">
          STOP EMAILS
        </button>
      `}
    </div>

  </div>
</div>`;
    })
    .join("");
}

      /* =========================
         üìä INITIALISATION AU CHARGEMENT
      ========================= */

      document.addEventListener("DOMContentLoaded", () => {
        console.log("üì± DOM charg√©");

        const waitForSupabase = setInterval(() => {
          if (window.supabaseReady && typeof supabase !== "undefined") {
            clearInterval(waitForSupabase);
            console.log("üöÄ Initialisation dashboard...");

            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log("‚úÖ supabaseClient cr√©√©:", supabaseClient);

            loadData();
            loadEmailLeads();
            loadSignedStudies();
            
            setInterval(loadData, 60000);
            setInterval(loadEmailLeads, 60000);
            setInterval(loadSignedStudies, 60000);
          } else {
            console.log(
              "‚è≥ Attente Supabase... (typeof supabase: " +
                typeof supabase +
                ")"
            );
          }
        }, 100);
      });
</script>
  </body>
</html>