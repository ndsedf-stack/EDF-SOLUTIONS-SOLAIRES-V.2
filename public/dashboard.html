<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>AUTOPILOTE SOLAIRE - Nicolas Di Stefano</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
        background: linear-gradient(
          135deg,
          #0a0a1a 0%,
          #050510 50%,
          #0a0a1a 100%
        );
        color: white;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        transition: all 0.4s ease;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(59, 130, 246, 0.03) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(16, 185, 129, 0.03) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: 0;
      }

      .content-wrapper {
        position: relative;
        z-index: 1;
      }

      .glass {
        background: rgba(15, 17, 26, 0.85);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .anomaly-card {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.08) 0%,
          rgba(239, 68, 68, 0.02) 100%
        );
        border: 1px solid rgba(239, 68, 68, 0.25);
      }

      .stable-indicator {
        animation: pulse-glow 3s ease-in-out infinite;
      }

      @keyframes pulse-glow {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 40px rgba(16, 185, 129, 0.5);
        }
      }

      body.mode-zen .anomaly-card {
        border-color: rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.02);
      }
      body.mode-zen .text-red-500,
      body.mode-zen .text-orange-400,
      body.mode-zen .text-orange-500 {
        color: #94a3b8 !important;
      }
      body.mode-zen .bg-red-500,
      body.mode-zen .bg-orange-500,
      body.mode-zen .bg-emerald-500 {
        background-color: #475569 !important;
        color: white !important;
      }
      body.mode-zen .border-emerald-500,
      body.mode-zen .border-red-500 {
        border-color: #334155 !important;
      }

      select {
        background: transparent;
        border: none;
        color: inherit;
        cursor: pointer;
        appearance: none;
        text-align: center;
        outline: none;
      }

      .tooltip {
        position: relative;
        display: inline-block;
      }
      .tooltip .tooltiptext {
        visibility: hidden;
        width: 140px;
        background-color: rgba(0, 0, 0, 0.95);
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 8px;
        position: absolute;
        z-index: 10;
        bottom: 125%;
        left: 50%;
        margin-left: -70px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 10px;
        font-weight: 700;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      dialog::backdrop {
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
      }
      dialog[open] {
        display: flex;
        flex-direction: column;
      }

      .rule-box {
        background: rgba(0, 0, 0, 0.5);
        border-radius: 8px;
        padding: 12px;
        margin-top: 10px;
        font-family: "Courier New", monospace;
        font-size: 11px;
        color: #94a3b8;
        border: 1px solid rgba(255, 255, 255, 0.08);
        text-align: left;
      }

      .stat-card {
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent,
          currentColor,
          transparent
        );
        opacity: 0;
        transition: opacity 0.4s;
      }

      .stat-card:hover::before {
        opacity: 0.5;
      }

      .stat-card:hover {
        transform: translateY(-4px);
      }

      tbody tr {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      tbody tr:hover {
        background: rgba(59, 130, 246, 0.03) !important;
        transform: translateX(4px);
      }

      .action-button {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .action-button:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .nuclear-glow {
        position: relative;
      }

      .nuclear-glow::after {
        content: "";
        position: absolute;
        inset: -10px;
        background: radial-gradient(
          circle,
          rgba(16, 185, 129, 0.1) 0%,
          transparent 70%
        );
        z-index: -1;
        animation: nuclear-pulse 2s ease-in-out infinite;
      }

      @keyframes nuclear-pulse {
        0%,
        100% {
          opacity: 0.3;
        }
        50% {
          opacity: 0.6;
        }
      }
    </style>
  </head>
  <body class="p-8">
    <div class="content-wrapper">
      <div class="max-w-7xl mx-auto">
        <div class="mb-12 flex justify-between items-start">
          <div class="relative">
            <h1
              class="text-5xl font-[700] tracking-tight uppercase text-slate-100"
              style="letter-spacing: 0.05em"
            >
              AUTOPILOTE SOLAIRE
            </h1>
            <div
              id="system-status"
              class="mt-2 text-[10px] font-medium text-slate-500 uppercase tracking-[0.3em] flex items-center gap-2"
            ></div>
          </div>
          <div class="flex gap-3">
            <button
              onclick="toggleZen()"
              id="btn-zen"
              class="px-4 py-2 rounded-lg border border-slate-700 bg-slate-900/50 text-slate-400 font-medium uppercase text-[9px] tracking-wider hover:bg-slate-800 hover:border-slate-600 transition-all"
            >
              üïäÔ∏è MODE CALME
            </button>
            <button
              onclick="togglePriority()"
              id="btn-priority"
              class="px-5 py-2 rounded-lg border border-slate-700 bg-slate-900/50 text-slate-300 font-semibold hover:bg-slate-800 hover:border-slate-600 transition-all uppercase text-[9px] tracking-wider"
            >
              ‚ö†Ô∏è PRIORIT√â
            </button>
            <div
              class="px-4 py-2 bg-slate-800/60 border border-slate-700 rounded-lg flex items-center"
            >
              <span
                class="text-[10px] font-semibold uppercase text-slate-300 tracking-wider"
                ><span id="row-count">0</span> DOSSIERS</span
              >
            </div>
          </div>
        </div>

        <div id="anomaly-zone" class="mb-14 hidden">
          <h2
            class="text-red-400 text-[11px] font-black uppercase tracking-[0.35em] mb-6 flex items-center gap-3"
          >
            <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
            üö® √âTUDES √Ä SURVEILLER (RISQUES D√âTECT√âS)
          </h2>
          <div
            id="anomaly-list"
            class="grid grid-cols-1 md:grid-cols-3 gap-5"
          ></div>
        </div>

        <div id="calm-zone" class="mb-14 hidden">
          <div class="grid grid-cols-12 gap-4">
            <!-- COLONNE GAUCHE: INSTRUMENTS -->
            <div class="col-span-3 space-y-4">
              <!-- JAUGE 1: DOSSIERS TOTAUX -->
              <div
                class="bg-slate-900/80 border border-slate-700/50 rounded-lg p-5"
              >
                <div
                  class="text-[9px] text-slate-500 uppercase font-semibold tracking-wider mb-3"
                >
                  DOSSIERS TOTAUX
                </div>
                <div
                  class="relative w-full h-2 bg-slate-800 rounded-full overflow-hidden mb-2"
                >
                  <div
                    class="absolute inset-0 bg-gradient-to-r from-slate-600 to-slate-500"
                    style="width: 100%"
                  ></div>
                </div>
                <div class="text-3xl font-bold text-slate-200" id="calm-total">
                  0
                </div>
              </div>

              <!-- JAUGE 2: R√àGLES ACTIVES -->
              <div
                class="bg-slate-900/80 border border-slate-700/50 rounded-lg p-5"
              >
                <div
                  class="text-[9px] text-slate-500 uppercase font-semibold tracking-wider mb-3"
                >
                  R√àGLES ACTIVES
                </div>
                <div class="flex items-center gap-2 mb-2">
                  <div class="w-3 h-3 rounded-sm bg-slate-600"></div>
                  <div class="w-3 h-3 rounded-sm bg-slate-600"></div>
                  <div class="w-3 h-3 rounded-sm bg-slate-800"></div>
                  <div class="w-3 h-3 rounded-sm bg-slate-800"></div>
                  <div class="w-3 h-3 rounded-sm bg-slate-800"></div>
                </div>
                <div class="text-3xl font-bold text-slate-200">2</div>
              </div>

              <!-- HORLOGE SYST√àME -->
              <div
                class="bg-slate-900/80 border border-slate-700/50 rounded-lg p-5"
              >
                <div
                  class="text-[9px] text-slate-500 uppercase font-semibold tracking-wider mb-2"
                >
                  DERNI√àRE V√âRIF.
                </div>
                <div
                  class="text-xl font-mono font-bold text-slate-300"
                  id="last-check"
                >
                  --:--
                </div>
              </div>
            </div>

            <!-- COLONNE DROITE: STATUS PRINCIPAL -->
            <div class="col-span-9">
              <div
                class="bg-slate-900/80 border border-slate-700/50 rounded-lg p-8 h-full"
              >
                <!-- HEADER -->
                <div
                  class="flex items-center justify-between mb-8 pb-6 border-b border-slate-800"
                >
                  <div class="flex items-center gap-4">
                    <div
                      class="relative w-12 h-12 rounded-full border-2 border-slate-700 flex items-center justify-center"
                    >
                      <div class="w-6 h-6 rounded-full bg-slate-600"></div>
                      <div
                        class="absolute inset-0 rounded-full border-2 border-slate-600 animate-ping opacity-20"
                      ></div>
                    </div>
                    <div>
                      <div
                        class="text-2xl font-bold text-slate-200 uppercase tracking-wide"
                      >
                        SYST√àME NOMINAL
                      </div>
                      <div
                        class="text-xs text-slate-500 uppercase tracking-wider font-medium mt-1"
                      >
                        Tous les syst√®mes op√©rationnels
                      </div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div
                      class="text-xs text-slate-600 uppercase font-semibold tracking-wider"
                    >
                      STATUS
                    </div>
                    <div
                      class="text-sm text-slate-400 font-mono mt-1"
                      id="system-info-calm"
                    >
                      0 ANOMALIE / 0 URGENCE
                    </div>
                  </div>
                </div>

                <!-- GRILLE DE MESURES -->
                <div class="grid grid-cols-4 gap-6">
                  <!-- MESURE 1 -->
                  <div class="space-y-2">
                    <div
                      class="text-[9px] text-slate-600 uppercase font-semibold tracking-wide"
                    >
                      DOSSIERS SENT
                    </div>
                    <div class="h-1 bg-slate-800 rounded-full overflow-hidden">
                      <div class="h-full bg-slate-600" style="width: 0%"></div>
                    </div>
                    <div class="text-2xl font-bold text-slate-300 font-mono">
                      0
                    </div>
                  </div>

                  <!-- MESURE 2 -->
                  <div class="space-y-2">
                    <div
                      class="text-[9px] text-slate-600 uppercase font-semibold tracking-wide"
                    >
                      DOSSIERS SIGNED
                    </div>
                    <div class="h-1 bg-slate-800 rounded-full overflow-hidden">
                      <div class="h-full bg-slate-600" style="width: 0%"></div>
                    </div>
                    <div class="text-2xl font-bold text-slate-300 font-mono">
                      0
                    </div>
                  </div>

                  <!-- MESURE 3 -->
                  <div class="space-y-2">
                    <div
                      class="text-[9px] text-slate-600 uppercase font-semibold tracking-wide"
                    >
                      ANOMALIES
                    </div>
                    <div class="h-1 bg-slate-800 rounded-full overflow-hidden">
                      <div class="h-full bg-slate-600" style="width: 0%"></div>
                    </div>
                    <div class="text-2xl font-bold text-slate-300 font-mono">
                      0
                    </div>
                  </div>

                  <!-- MESURE 4 -->
                  <div class="space-y-2">
                    <div
                      class="text-[9px] text-slate-600 uppercase font-semibold tracking-wide"
                    >
                      FILE ATTENTE
                    </div>
                    <div class="h-1 bg-slate-800 rounded-full overflow-hidden">
                      <div class="h-full bg-slate-600" style="width: 0%"></div>
                    </div>
                    <div class="text-2xl font-bold text-slate-300 font-mono">
                      0
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
          <div class="stat-card glass rounded-2xl p-8 relative">
            <div
              class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-[0.3em]"
            >
              DOSSIERS TOTAUX
            </div>
            <div class="text-6xl font-black tracking-tight" id="stat-total">
              0
            </div>
          </div>
          <div
            class="stat-card glass rounded-2xl p-8 relative border-blue-500/20 text-blue-400"
          >
            <div
              class="text-[10px] font-black text-blue-400/70 uppercase mb-4 tracking-[0.3em]"
            >
              EN COURS (SENT)
            </div>
            <div
              class="text-6xl font-black text-blue-400 tracking-tight"
              id="stat-sent"
            >
              0
            </div>
          </div>
          <div
            class="stat-card glass rounded-2xl p-8 relative border-emerald-500/20 text-emerald-400"
          >
            <div
              class="text-[10px] font-black text-emerald-400/70 uppercase mb-4 tracking-[0.3em]"
            >
              SIGN√âS (NET)
            </div>
            <div
              class="text-6xl font-black text-emerald-400 tracking-tight"
              id="stat-signed"
            >
              0
            </div>
          </div>
          <div
            class="stat-card glass rounded-2xl p-8 relative border-orange-500/20 text-orange-400"
          >
            <div
              class="text-[10px] font-black text-orange-400/70 uppercase mb-4 tracking-[0.3em]"
            >
              FILE ATTENTE
            </div>
            <div
              class="text-6xl font-black text-orange-400 tracking-tight"
              id="stat-queue"
            >
              0
            </div>
          </div>
        </div>

        <div class="glass rounded-3xl overflow-hidden shadow-2xl relative">
          <div
            class="absolute inset-0 bg-gradient-to-br from-blue-500/5 via-transparent to-emerald-500/5 pointer-events-none"
          ></div>
          <table class="w-full text-left border-collapse relative">
            <thead
              class="bg-black/70 text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] border-b border-slate-700/50"
            >
              <tr>
                <th class="p-7 font-black w-[25%]">DOSSIER CLIENT</th>
                <th class="p-7 text-center font-black w-[15%]">ENGAGEMENT</th>
                <th class="p-7 text-center font-black w-[12%]">
                  STATUT ACTUEL
                </th>
                <th class="p-7 text-right font-black w-[48%]">
                  ACTIONS RAPIDES
                </th>
              </tr>
            </thead>
            <tbody id="table-body" class="divide-y divide-slate-800/20"></tbody>
          </table>
        </div>

        <div class="mt-20">
          <h2
            class="text-slate-400 text-[11px] font-black uppercase tracking-[0.35em] mb-8 flex items-center gap-3"
          >
            <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
            üìß SUIVI AUTOPILOTE LEADS EMAIL
          </h2>
          <div
            id="email-today-indicator"
            class="mb-5 text-[11px] font-black uppercase tracking-widest text-orange-400 hidden flex items-center gap-2"
          >
            <span
              class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"
            ></span>
            üîî <span id="email-today-count">0</span> RELANCE(S) AUTOMATIQUE(S)
            PR√âVUE(S) AUJOURD'HUI
          </div>
          <div class="glass rounded-3xl overflow-hidden">
            <table class="w-full text-left border-collapse">
              <thead
                class="bg-black/70 text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] border-b border-slate-700/50"
              >
                <tr>
                  <th colspan="4" class="p-0">
                    <div
                      class="grid grid-cols-[1fr_180px_200px_140px] px-6 py-5 text-[10px] font-black uppercase tracking-[0.3em] text-slate-400"
                    >
                      <div class="text-left">LEAD</div>
                      <div class="text-center">DERNIER EMAIL</div>
                      <div class="text-center">PROCHAINE RELANCE</div>
                      <div class="text-center">OPT-OUT</div>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody
                id="leads-email-body"
                class="divide-y divide-slate-800/20"
              ></tbody>
            </table>
          </div>
        </div>

        <div class="mt-20 mb-12">
          <h2
            class="text-slate-400 text-[11px] font-black uppercase tracking-[0.35em] mb-8 flex items-center gap-3"
          >
            <span
              class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"
            ></span>
            JOURNAL DES FOR√áAGES (BO√éTE NOIRE)
          </h2>
          <div class="glass rounded-3xl overflow-hidden">
            <div
              id="logs-container"
              class="max-h-[360px] overflow-y-auto divide-y divide-slate-800/20"
            >
              <div
                class="p-8 text-center text-slate-600 text-xs uppercase tracking-widest italic"
              >
                Chargement des archives...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <dialog
      id="override-modal"
      class="glass border border-slate-700 p-10 rounded-3xl text-white outline-none"
    >
      <div class="max-w-md">
        <h3 class="text-2xl font-black text-orange-400 uppercase mb-3">
          ‚ö†Ô∏è FOR√áAGE MANUEL
        </h3>
        <p class="text-[11px] text-slate-400 mb-5 uppercase tracking-widest">
          Une anomalie bloque cette action. Justifiez le d√©verrouillage :
        </p>
        <div class="flex flex-wrap gap-3 mb-5">
          <button
            onclick="setTemplate('Contact t√©l√©phonique confirm√©')"
            class="text-[9px] px-3 py-2 bg-slate-800 rounded-lg border border-slate-600 hover:bg-slate-700 uppercase font-bold tracking-wider transition-all"
          >
            üìû TEL OK
          </button>
          <button
            onclick="setTemplate('Accord oral en attente')"
            class="text-[9px] px-3 py-2 bg-slate-800 rounded-lg border border-slate-600 hover:bg-slate-700 uppercase font-bold tracking-wider transition-all"
          >
            ü§ù ACCORD ORAL
          </button>
          <button
            onclick="setTemplate('Erreur de tracking connue')"
            class="text-[9px] px-3 py-2 bg-slate-800 rounded-lg border border-slate-600 hover:bg-slate-700 uppercase font-bold tracking-wider transition-all"
          >
            ‚öôÔ∏è BUG TRACK
          </button>
        </div>
        <textarea
          id="justification-text"
          class="w-full bg-black/60 border border-slate-700 rounded-xl p-5 text-sm text-white focus:border-orange-500 outline-none mb-6 focus:bg-black/80 transition-all"
          placeholder="Ex: Client eu au t√©l√©phone..."
          rows="4"
        ></textarea>
        <div class="flex gap-4">
          <button
            onclick="document.getElementById('override-modal').close()"
            class="flex-1 px-5 py-4 rounded-xl bg-slate-800 font-bold text-[10px] uppercase tracking-widest hover:bg-slate-700 transition-all"
          >
            Annuler
          </button>
          <button
            id="confirm-override-btn"
            class="flex-1 px-5 py-4 rounded-xl bg-orange-500 text-black font-black text-[10px] uppercase tracking-widest hover:scale-105 transition-all action-button"
          >
            Confirmer & Loguer
          </button>
        </div>
      </div>
    </dialog>

    <script>
      const SUPABASE_URL = "https://ugwqfvwclwctzgtxcakp.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnd3FmdndjbHdjdHpndHhjYWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNDg4OTgsImV4cCI6MjA4MTgyNDg5OH0.sx9z3p3svG5V6djfzUXtzdOwbUU3wjIVaAyIjRoFzaE";
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      let fullData = [];
      let logsData = [];
      let isPriorityMode = false;
      let isZenMode = false;
      let anomaliesDetected = [];
      let settings = { view_threshold: 5, day_threshold: 3 };

      function getTimeSince(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        let interval = seconds / 3600;
        if (interval > 24) return `ACTIF IL Y A ${Math.floor(interval / 24)}J`;
        if (interval >= 1) return `ACTIF IL Y A ${Math.floor(interval)}H`;
        return `ACTIF IL Y A ${Math.floor(seconds / 60)}MIN`;
      }

      function toggleZen() {
        isZenMode = !isZenMode;
        document.body.classList.toggle("mode-zen", isZenMode);
        document.getElementById("btn-zen").innerText = isZenMode
          ? "üëÅÔ∏è Mode Normal"
          : "üïäÔ∏è Mode Calme";
      }

      function setTemplate(t) {
        document.getElementById("justification-text").value = t;
      }

      function toggleRule(id) {
        const el = document.getElementById(`rule-${id}`);
        el.classList.toggle("hidden");
      }

      async function loadSettings() {
        try {
          const { data } = await supabaseClient
            .from("system_settings")
            .select("key, value_int");
          if (data) data.forEach((s) => (settings[s.key] = s.value_int));
        } catch (e) {
          console.warn("Settings error");
        }
      }

      async function loadData() {
        await loadSettings();
        try {
          const [
            { data: studies },
            { data: stats },
            { count: queueCount },
            { data: logs },
          ] = await Promise.all([
            supabaseClient
              .from("studies")
              .select(
                "id, status, created_at, deposit_paid, deposit_paid_at, clients(first_name, last_name, email)"
              )
              .neq("status", "cancelled") // ‚¨ÖÔ∏è MASQUE LES ANNUL√âS
              .order("created_at", { ascending: false })
              .limit(1000),

            supabaseClient
              .from("studies_activity_summary")
              .select("*")
              .limit(1000),
            supabaseClient
              .from("email_queue")
              .select("*", { count: "exact", head: true })
              .eq("status", "pending"),
            supabaseClient
              .from("decision_logs")
              .select("*")
              .order("created_at", { ascending: false })
              .limit(20),
          ]);

          logsData = logs || [];
          fullData = (studies || []).map((s) => {
            const st = (stats || []).find((item) => item.id === s.id) || {};
            const diffDays =
              (new Date() - new Date(s.created_at)) / (1000 * 60 * 60 * 24);
            return {
              id: s.id,
              name: s.clients
                ? `${s.clients.first_name || ""} ${
                    s.clients.last_name || ""
                  }`.trim()
                : "Inconnu",
              email: s.clients?.email || "Pas d'email",
              status: s.status,
              created_at: s.created_at,
              views: st.email_opens || 0,
              clicks: st.interactions || 0,
              diffDays: Math.floor(diffDays),
              hasLog: logsData.some((l) => l.study_id === s.id),
              deposit_paid: s.deposit_paid || false,
              deposit_paid_at: s.deposit_paid_at || null,
            };
          });

          const { data: j0Emails } = await supabaseClient
            .from("email_queue")
            .select("study_id, email_type, sent_at")
            .in("email_type", [
              "anti_j0_cash_deposit_request",
              "anti_j0_financement_deposit_request",
            ])
            .eq("status", "sent");

          fullData = fullData.map((s) => {
            const j0 = j0Emails?.find((e) => e.study_id === s.id);
            return {
              ...s,
              rib_sent_at: j0?.sent_at || null,
            };
          });

          updateKPIs(queueCount || 0);
          detectAnomalies();
          render();
          renderLogs();
        } catch (err) {
          console.error(err);
        }
      }

      function renderLogs() {
        const container = document.getElementById("logs-container");
        if (logsData.length === 0) {
          container.innerHTML = `<div class="p-12 text-center text-slate-600 text-[11px] uppercase tracking-widest italic">Aucune archive de for√ßage...</div>`;
          return;
        }
        container.innerHTML = logsData
          .map(
            (l) => `
                        <div class="p-6 flex justify-between items-center hover:bg-white/[0.02] transition-all duration-300">
                            <div class="flex flex-col">
                                <span class="text-[9px] text-orange-400 font-black uppercase tracking-[0.2em] mb-1">${
                                  l.action_performed
                                }</span>
                                <span class="text-base font-bold text-slate-200">${
                                  l.client_name
                                }</span>
                            </div>
                            <div class="max-w-[50%] text-right">
                                <div class="text-[11px] text-slate-400 italic mb-1">"${
                                  l.justification
                                }"</div>
                                <div class="text-[9px] text-slate-600 uppercase font-bold tracking-wider">${new Date(
                                  l.created_at
                                ).toLocaleString()}</div>
                            </div>
                        </div>`
          )
          .join("");
      }

      function detectAnomalies() {
        const anomalies = [];
        fullData.forEach((s) => {
          if (
            s.status === "sent" &&
            s.views > settings.view_threshold &&
            s.clicks === 0
          ) {
            anomalies.push({
              id: s.id,
              name: s.name,
              type: "INT√âR√äT STAGNANT",
              desc: `Vue ${s.views} fois sans clic.`,
              rule: `R√®gle : SI statut=SENT ET vues>${settings.view_threshold} ET clics=0`,
              obs: `Donn√©es observ√©es : Vues=${s.views}, Clics=0`,
            });
          }
          if (
            s.status === "signed" &&
            s.diffDays > settings.day_threshold &&
            s.views < 2
          ) {
            anomalies.push({
              id: s.id,
              name: s.name,
              type: "SILENCE POST-SIGNATURE",
              desc: `Aucune lecture depuis ${s.diffDays}j.`,
              rule: `R√®gle : SI statut=SIGNED ET jours>${settings.day_threshold} ET vues<2`,
              obs: `Donn√©es observ√©es : Jours=${s.diffDays}, Vues=${s.views}`,
            });
          }
        });

        anomaliesDetected = anomalies.map((a) => a.id);
        const anomalyZone = document.getElementById("anomaly-zone");
        const calmZone = document.getElementById("calm-zone");
        const calmMessage = document.getElementById("system-info-calm");
        const calmTotal = document.getElementById("calm-total");
        const lastCheck = document.getElementById("last-check");

        if (anomalies.length > 0) {
          anomalyZone.classList.remove("hidden");
          calmZone.classList.add("hidden");
          document.getElementById("anomaly-list").innerHTML = anomalies
            .map(
              (a) => `
                        <div class="anomaly-card p-6 rounded-2xl border-l-4 border-l-red-500 hover:border-l-red-400 transition-all duration-300">
                            <div class="text-[10px] font-black text-red-400 mb-2 tracking-[0.2em]">${a.type}</div>
                            <div class="text-xl font-bold mb-2">${a.name}</div>
                            <div class="text-[11px] text-slate-500 italic mb-3">${a.desc}</div>
                            <button onclick="toggleRule('${a.id}')" class="text-[10px] text-blue-400 hover:text-blue-300 hover:underline uppercase tracking-tighter font-bold transition-colors">Pourquoi ce dossier est signal√© ?</button>
                            <div id="rule-${a.id}" class="hidden rule-box">
                                <div>${a.rule}</div>
                                <div class="mt-2">${a.obs}</div>
                            </div>
                        </div>`
            )
            .join("");
        } else {
          anomalyZone.classList.add("hidden");
          calmZone.classList.remove("hidden");
          calmMessage.innerHTML = `Aujourd'hui : 0 anomalie, 0 urgence`;
          if (calmTotal) calmTotal.innerText = fullData.length;
          if (lastCheck)
            lastCheck.innerText = new Date().toLocaleTimeString("fr-FR", {
              hour: "2-digit",
              minute: "2-digit",
            });
        }
      }

      function updateKPIs(queue) {
        document.getElementById("stat-total").innerText = fullData.length;
        document.getElementById("stat-sent").innerText = fullData.filter(
          (s) => s.status === "sent"
        ).length;
        document.getElementById("stat-signed").innerText = fullData.filter(
          (s) => s.status === "signed"
        ).length;
        document.getElementById("stat-queue").innerText = queue;
        document.getElementById("row-count").innerText = fullData.length;
      }

      async function updateStatus(id, newStatus) {
        const { error } = await supabaseClient
          .from("studies")
          .update({ status: newStatus })
          .eq("id", id);
        if (!error) loadData();
      }

      async function forceAction(id, name, newStatus) {
        const modal = document.getElementById("override-modal");
        const text = document.getElementById("justification-text");
        modal.showModal();
        document.getElementById("confirm-override-btn").onclick = async () => {
          const justification = text.value.trim();
          if (!justification) return alert("Justification obligatoire.");
          const { error: logError } = await supabaseClient
            .from("decision_logs")
            .insert({
              study_id: id,
              client_name: name,
              action_performed: `FORCED_TO_${newStatus.toUpperCase()}`,
              justification: justification,
            });
          if (logError) return alert("Erreur log.");
          await updateStatus(id, newStatus);
          text.value = "";
          modal.close();
        };
      }

      function forceSign(studyId, clientName) {
        const modal = document.getElementById("override-modal");
        const text = document.getElementById("justification-text");
        modal.showModal();

        document.getElementById("confirm-override-btn").onclick = async () => {
          const justification = text.value.trim();
          if (!justification) return alert("Justification obligatoire.");

          await signStudySafe(studyId, clientName, true, justification);

          text.value = "";
          modal.close();
        };
      }

      async function cancelStudySafe(studyId, clientName) {
        console.log("CANCEL CLICK", { studyId, clientName });

        if (!confirm("Confirmer l'annulation compl√®te de ce dossier ?")) return;

        // 1. Annule l'√©tude
        const { error: e1 } = await supabaseClient
          .from("studies")
          .update({ status: "cancelled" })
          .eq("id", studyId);

        if (e1) {
          alert("Erreur annulation study");
          return;
        }

        // 2. Stoppe tous les emails li√©s
        const { error: e2 } = await supabaseClient
          .from("email_queue")
          .update({ status: "cancelled" })
          .eq("study_id", studyId)
          .in("status", ["pending", "scheduled"]);

        if (e2) {
          alert("Erreur arr√™t emails");
          return;
        }

        // 3. Log de s√©curit√©
        await supabaseClient.from("decision_logs").insert({
          study_id: studyId,
          client_name: clientName || "Inconnu",
          action_performed: "CANCELLED",
          justification: "Annulation depuis dashboard",
        });

        alert("Dossier annul√©. Emails stopp√©s.");
        loadData();
      }
      async function signStudySafe(
        studyId,
        clientName,
        forced = false,
        justification = null
      ) {
        console.log("SIGN CLICK", studyId);

        if (!forced) {
          if (!confirm("Confirmer : dossier SIGN√â ?")) return;
        }

        const { data, error } = await supabaseClient
          .from("studies")
          .update({ status: "signed" })
          .eq("id", studyId)
          .neq("status", "signed")
          .select()
          .single();

        console.log("SIGN RESULT", { data, error });

        if (error || !data) {
          alert("Impossible de signer : d√©j√† sign√© ou erreur.");
          return;
        }

        await supabaseClient.from("decision_logs").insert({
          study_id: studyId,
          client_name: clientName,
          action_performed: forced ? "FORCED_TO_SIGNED" : "SIGNED",
          justification: forced ? justification : "Signature depuis dashboard",
        });

        alert("Dossier sign√©. Automatisations d√©clench√©es.");
        loadData();
      }

      function togglePriority() {
        isPriorityMode = !isPriorityMode;
        document
          .getElementById("btn-priority")
          .classList.toggle("bg-orange-600", isPriorityMode);
        render();
      }

      function render() {
        const tbody = document.getElementById("table-body");

        let list = isPriorityMode
          ? fullData.filter(
              (s) =>
                anomaliesDetected.includes(s.id) || s.views >= 3 || s.clicks > 0
            )
          : fullData;

        tbody.innerHTML = list
          .map((s) => {
            const hasAlert = anomaliesDetected.includes(s.id);
            const safeName = s.name.replace(/'/g, "\\'");

            const statusClass =
              s.status === "signed"
                ? "border-emerald-500/50 text-emerald-400 bg-emerald-500/10"
                : s.status === "sent"
                ? "border-blue-500/50 text-blue-400 bg-blue-500/10"
                : "border-slate-600/50 text-slate-400";

            const onChangeStatus = hasAlert
              ? "forceAction('" +
                s.id +
                "', '" +
                s.name.replace(/'/g, "\\'") +
                "', this.value)"
              : "updateStatus('" + s.id + "', this.value)";

            const onClickSigned = hasAlert
              ? "forceSign('" +
                s.id +
                "', '" +
                s.name.replace(/'/g, "\\'") +
                "')"
              : "signStudySafe('" +
                s.id +
                "', '" +
                s.name.replace(/'/g, "\\'") +
                "')";

            return `
<tr class="transition-all duration-300 group ${hasAlert ? "bg-red-500/5" : ""}">


   <td class="p-7" onclick="window.open('${window.location.origin}/guest/${
              s.id
            }', '_blank')" style="cursor: pointer;">
    <div class="flex items-center gap-3">
      <div class="text-xl font-bold text-slate-100 group-hover:text-blue-400 transition-colors">
        ${s.name}
      </div>
      ${
        s.hasLog
          ? '<span class="tooltip"><span class="text-orange-400 text-sm cursor-help">üìù</span><span class="tooltiptext">Ce dossier a √©t√© forc√© manuellement (voir logs bas de page)</span></span>'
          : ""
      }
    </div>
    <div class="text-xs text-slate-500 font-medium mt-1">${s.email}</div>
    <div class="text-[9px] text-slate-600 font-bold mt-2 uppercase tracking-[0.2em]">
      ${getTimeSince(s.created_at)}
    </div>
  </td>

  <td class="p-7 text-center">
    <div class="flex justify-center gap-14 font-black">
      <div class="relative group/stat">
        <div class="absolute -inset-3 bg-gradient-to-r ${
          s.views >= 3
            ? "from-orange-500/15 to-orange-500/5"
            : "from-slate-500/10 to-transparent"
        } rounded-xl opacity-0 group-hover/stat:opacity-100 transition-all duration-300"></div>
        <div class="relative">
          <div class="text-3xl ${
            s.views >= 3 ? "text-orange-400" : "text-slate-400"
          } tracking-tight">${s.views}</div>
          <div class="text-[9px] text-slate-500 uppercase tracking-[0.2em] font-bold mt-1">VUES</div>
        </div>
      </div>

      <div class="w-px bg-gradient-to-b from-transparent via-slate-700/50 to-transparent"></div>

      <div class="relative group/stat">
        <div class="absolute -inset-3 bg-gradient-to-r ${
          s.clicks > 0
            ? "from-purple-500/15 to-purple-500/5"
            : "from-slate-500/10 to-transparent"
        } rounded-xl opacity-0 group-hover/stat:opacity-100 transition-all duration-300"></div>
        <div class="relative">
          <div class="text-3xl ${
            s.clicks > 0 ? "text-purple-400" : "text-slate-400"
          } tracking-tight">${s.clicks}</div>
          <div class="text-[9px] text-slate-500 uppercase tracking-[0.2em] font-bold mt-1">CLICS</div>
        </div>
      </div>
    </div>
  </td>

  <td class="p-7 text-center">
    <div class="inline-block px-5 py-2 rounded-xl border font-black uppercase text-[10px] tracking-[0.2em] ${statusClass}">
      <select onchange="event.stopPropagation(); ${onChangeStatus}">
        <option value="sent" ${
          s.status === "sent" ? "selected" : ""
        }>SENT</option>
        <option value="draft" ${
          s.status === "draft" ? "selected" : ""
        }>DRAFT</option>
        <option value="signed" ${
          s.status === "signed" ? "selected" : ""
        }>SIGNED</option>
        <option value="cancelled" ${
          s.status === "cancelled" ? "selected" : ""
        }>CANCELLED</option>
      </select>
    </div>
  </td>

  <td class="p-5">
    <div class="flex items-center justify-between gap-4">
      
      <!-- PARTIE GAUCHE: INFO COMPACT -->
      <div class="flex items-center gap-6">
        
        <!-- RIB -->
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-800/40 border border-slate-700/30 min-w-[140px]">
          <span class="text-base">üìÑ</span>
          <div>
            <div class="text-[8px] text-slate-600 uppercase font-bold tracking-wide">RIB</div>
            <div class="${
              s.rib_sent_at ? "text-emerald-400 font-bold" : "text-slate-600"
            } text-xs">
              ${
                s.rib_sent_at
                  ? new Date(s.rib_sent_at).toLocaleDateString("fr-FR", {
                      day: "2-digit",
                      month: "2-digit",
                    })
                  : "‚Äî"
              }
            </div>
          </div>
        </div>

        <!-- ACOMPTE -->
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg ${
          s.deposit_paid
            ? "bg-emerald-500/10 border border-emerald-500/30"
            : "bg-slate-800/40 border border-slate-700/30"
        } min-w-[140px]">
          <span class="text-base">${s.deposit_paid ? "‚úì" : "üí∂"}</span>
          <div>
            <div class="text-[8px] ${
              s.deposit_paid ? "text-emerald-400" : "text-slate-600"
            } uppercase font-bold tracking-wide">ACOMPTE</div>
            ${
              s.deposit_paid
                ? `<div class="text-emerald-400 font-bold text-xs">
                    ${new Date(s.deposit_paid_at).toLocaleDateString("fr-FR", {
                      day: "2-digit",
                      month: "2-digit",
                    })}
                  </div>`
                : `<div class="text-slate-600 text-xs font-medium">En attente</div>`
            }
          </div>
          ${
            !s.deposit_paid
              ? `<button 
     onclick="event.stopPropagation(); markDepositPaid('${s.id}')"
     class="ml-auto px-2 py-1 rounded bg-emerald-500 text-black font-bold text-[9px] hover:scale-105 transition-all">
     ‚úì
   </button>`
              : ""
          }
        </div>
        
      </div>

      <!-- PARTIE DROITE: ACTIONS -->
      <div class="flex items-center gap-2">
        
        <!-- BOUTON SIGN√â -->
<div class="tooltip">
  <button
    onclick="event.stopPropagation(); ${onClickSigned}"
    class="action-button px-6 py-2 ${
      hasAlert
        ? "bg-orange-500 text-black border border-orange-400 animate-pulse"
        : "bg-emerald-500 text-black border border-emerald-400"
    } rounded-lg font-bold text-xs uppercase tracking-wide shadow-md hover:scale-105 transition-all"
  >
    ${hasAlert ? "‚ö†Ô∏è FORCER" : "‚úì SIGN√â"}
  </button>
  <span class="tooltiptext">
    ${hasAlert ? "‚ö†Ô∏è Anomalie d√©tect√©e" : "Marquer comme sign√©"}
  </span>
</div>

      <!-- BOUTON DRAFT -->
<div class="tooltip">
  <button
    onclick="event.stopPropagation(); updateStatus('${s.id}', 'draft')"
    class="action-button w-10 h-10 flex items-center justify-center bg-slate-900 text-blue-400 border border-blue-500/40 rounded-lg hover:bg-blue-500 hover:text-white transition-all text-base"
  >
    üìù
  </button>
  <span class="tooltiptext">Remettre en brouillon</span>
</div>

      <!-- BOUTON ANNULER -->
<div class="tooltip">
  <button
    onclick="event.stopPropagation(); cancelStudySafe('${s.id}', '${safeName}')"
    class="action-button w-10 h-10 flex items-center justify-center bg-slate-900 text-red-400 border border-red-500/40 rounded-lg hover:bg-red-500 hover:text-white transition-all text-lg font-bold"
  >
    ‚úï
  </button>
  <span class="tooltiptext">Annuler le dossier</span>
</div>


        
      </div>
    </div>
  </td>

</tr>`;
          })
          .join("");
      }

      function daysAgo(date) {
        const d = Math.floor(
          (new Date() - new Date(date)) / (1000 * 60 * 60 * 24)
        );
        return d <= 0 ? "Aujourd'hui" : `Il y a ${d}j`;
      }

      function nextFollowUp(lead) {
        const now = new Date();
        const created = new Date(lead.created_at);
        const last = lead.last_email_sent_at
          ? new Date(lead.last_email_sent_at)
          : created;

        const daysSinceCreation = (now - created) / (1000 * 60 * 60 * 24);
        const daysSinceLast = (now - last) / (1000 * 60 * 60 * 24);

        if (daysSinceCreation > 120) return "Termin√©";

        if (daysSinceCreation <= 60) {
          return daysSinceLast >= 7
            ? "Aujourd'hui"
            : `Dans ${Math.ceil(7 - daysSinceLast)}j`;
        }

        return daysSinceLast >= 14
          ? "Aujourd'hui"
          : `Dans ${Math.ceil(14 - daysSinceLast)}j`;
      }

      async function loadEmailLeads() {
        const { data: leads } = await supabaseClient
          .from("email_leads")
          .select(
            `
        id,
        created_at,
        last_email_sent_at,
        email_step,
        clients (
          id,
          email,
          first_name,
          last_name,
          email_optout
        )
              `
          )
          .order("created_at", { ascending: false })
          .limit(200);

        const tbody = document.getElementById("leads-email-body");
        if (!tbody || !leads) return;

        const todayCount = leads.filter((l) => {
          const c = l.clients;
          if (!c) return false;
          return nextFollowUp(l) === "Aujourd'hui" && !c.email_optout;
        }).length;

        const indicator = document.getElementById("email-today-indicator");
        const countEl = document.getElementById("email-today-count");

        if (todayCount > 0) {
          countEl.innerText = todayCount;
          indicator.classList.remove("hidden");
        } else {
          indicator.classList.add("hidden");
        }

        tbody.innerHTML = leads
          .map((l) => {
            const c = l.clients;
            if (!c) return "";
            const safeEmail = (c.email || "").replace(/'/g, "\\'");
            return `
                  <tr class="hover:bg-white/[0.02] transition-all duration-300">
                    <td class="p-5">
                      <div class="font-bold text-slate-200 text-base">
                        ${c.first_name || ""} ${c.last_name || ""}
                      </div>
                      <div class="text-xs text-slate-500 mt-1">${c.email}</div>
                    </td>

                    <td class="p-5 text-center text-xs text-slate-400 font-medium">
                      ${
                        l.last_email_sent_at
                          ? daysAgo(l.last_email_sent_at)
                          : "Jamais"
                      }
                    </td>

                    <td class="p-5 text-center">
                      ${
                        nextFollowUp(l) === "Aujourd'hui"
                          ? `<span class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-[0.2em] bg-orange-500/20 text-orange-400 animate-pulse border border-orange-500/30">üîî AUJOURD'HUI</span>`
                          : `<span class="text-xs font-bold text-slate-400">${nextFollowUp(
                              l
                            )}</span>`
                      }
                    </td>

                    <td class="p-5 text-center">
  ${
    c.email_optout
      ? `<span class="text-red-400 text-xs font-black uppercase tracking-wider">OUI</span>`
      : `<button 
           onclick="setOptOut('${safeEmail}')"
           class="action-button px-4 py-1.5 text-[9px] font-black uppercase tracking-wider bg-slate-800 border border-slate-600 rounded-lg hover:bg-red-500 hover:text-white hover:border-red-500 transition-all">
           STOP EMAILS
         </button>`
  }
</td>

                  </tr>
                `;
          })
          .join("");
      }

      async function setOptOut(email) {
        if (!confirm("Confirmer l'exclusion de ce lead ?")) return;
        await supabaseClient
          .from("clients")
          .update({ email_optout: true })
          .eq("email", email);
        loadEmailLeads();
      }

      async function markDepositPaid(studyId) {
        if (!confirm("Confirmer la r√©ception de l'acompte (1500 ‚Ç¨) ?")) return;

        // 1. Update study
        const { data, error } = await supabaseClient
          .from("studies")
          .update({
            deposit_paid: true,
            deposit_paid_at: new Date().toISOString(),
          })
          .eq("id", studyId)
          .eq("deposit_paid", false) // anti double d√©clenchement
          .select()
          .single();

        if (error || !data) {
          alert("Erreur ou acompte d√©j√† valid√©.");
          return;
        }

        // 2. Log
        await supabaseClient.from("decision_logs").insert({
          study_id: studyId,
          action_performed: "DEPOSIT_PAID",
          justification: "Validation acompte depuis dashboard",
        });

        alert("Acompte confirm√©. Automatisations d√©clench√©es.");
        loadData();
      }

      loadData();
      loadEmailLeads();
      setInterval(loadData, 60000);
      setInterval(loadEmailLeads, 60000);
    </script>
  </body>
</html>
