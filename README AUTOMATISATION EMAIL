# ‚ö° Automatisation Solaire ‚Äî Nicolas Di Stefano

**EDF Solutions Solaires**

üìÖ Derni√®re mise √† jour : **3 janvier 2026**  
üóÇÔ∏è Projet Supabase : `ugwqfvwclwctzgtxcakp`  
üöÄ Statut : **100 % OP√âRATIONNEL ‚Äî AUTOPILOTE STABLE**

---

## üß† Philosophie du syst√®me

AJOUTE CE CHAPITRE

## üß© Principes d‚ÄôArchitecture (√Ä NE PAS VIOLER)

Ce syst√®me repose sur des r√®gles **non n√©gociables** :

### 1. Aucune d√©cision m√©tier dans l‚ÄôEdge

- L‚ÄôEdge **envoie**
- PostgreSQL **d√©cide**
- Aucun calcul de timing ou de retry c√¥t√© Edge

### 2. Aucun email envoy√© hors `email_queue`

- Toute tentative de bypass est consid√©r√©e comme une erreur
- La queue est la **source de v√©rit√©**

### 3. S√©paration stricte des responsabilit√©s

- PostgreSQL : orchestration, statuts, retries
- Edge Functions : rendu + transport
- Resend : livraison uniquement

### 4. Aucun d√©clenchement bas√© sur le tracking

- Le tracking est **informatif**
- Jamais d√©cisionnel

‚öôÔ∏è 3Ô∏è‚É£ NOUVELLE SECTION PIPELINE (CRITIQUE)

üëâ APR√àS ## üèóÔ∏è Architecture g√©n√©rale

‚ûï AJOUTE

## ‚öôÔ∏è Pipeline Email ‚Äî Flow R√©el de Production

√âV√âNEMENT M√âTIER
‚Üì
INSERT dans email_queue (status = 'pending')
‚Üì
pg_cron
‚Üì
process_one_email_via_edge()
‚Üì
Edge Function send_email_from_queue
‚Üì
email_templates
‚Üì
Resend

### Points cl√©s :

- Un seul email trait√© par ex√©cution (lock `SKIP LOCKED`)
- Aucun double envoi possible
- Le syst√®me est **idempotent**

üîÅ 4Ô∏è‚É£ SECTION RETRY INTELLIGENT

üëâ APR√àS la description de email_queue

‚ûï AJOUTE

## üîÅ Retry Intelligent (Syst√®me Auto-R√©parant)

Les erreurs d‚Äôenvoi ne d√©clenchent **jamais** de boucle infinie.

### R√®gles :

- Maximum **3 tentatives**
- D√©lais progressifs :
  - tentative 1 ‚Üí +5 minutes
  - tentative 2 ‚Üí +30 minutes
  - tentative 3 ‚Üí +2 heures
- Au-del√† ‚Üí `failed` d√©finitif (intervention humaine)

### Fonction SQL officielle

`````sql
CREATE OR REPLACE FUNCTION retry_email(p_email_id uuid)
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
  UPDATE email_queue
  SET
    attempts = attempts + 1,
    status = CASE
      WHEN attempts + 1 >= 3 THEN 'failed'
      ELSE 'pending'
    END,
    scheduled_for = CASE
      WHEN attempts + 1 = 1 THEN now() + interval '5 minutes'
      WHEN attempts + 1 = 2 THEN now() + interval '30 minutes'
      WHEN attempts + 1 = 3 THEN now() + interval '2 hours'
      ELSE scheduled_for
    END,
    last_error = COALESCE(last_error, 'retry scheduled')
  WHERE id = p_email_id;
END;
$$;


üëâ Cette fonction est appel√©e automatiquement par l‚ÄôEdge en cas d‚Äô√©chec.


---

# üßπ 5Ô∏è‚É£ SECTION S√âCURIT√â ANTI-BLOCAGE
üëâ **APR√àS** la partie CRON / Maintenance

### ‚ûï AJOUTE

```md
## üßπ S√©curit√© Anti-Blocage (`processing`)

Un email bloqu√© en `processing` est consid√©r√© comme **d√©faillant**.

### R√®gle :
- Un email ne peut pas rester en `processing` > 15 minutes

### Nettoyage automatique recommand√©

```sql
UPDATE email_queue
SET
  status = 'error',
  last_error = 'auto-reset: stuck in processing'
WHERE status = 'processing'
  AND created_at < now() - interval '15 minutes';


üëâ Cette requ√™te peut √™tre ex√©cut√©e via pg_cron.


---

# üß† 6Ô∏è‚É£ SECTION RESPONSABILIT√âS (CL√â AUDIT)
üëâ **√Ä LA FIN**, juste avant la conclusion

### ‚ûï AJOUTE

```md
## üß† Responsabilit√©s ‚Äî Lecture Audit

| Composant | Responsabilit√© |
|---------|----------------|
| PostgreSQL | D√©cide quoi / quand / retry |
| Edge Functions | Rend et envoie |
| Resend | Transporte |
| Tracking | Observe uniquement |
| Humain | D√©cide en dernier recours |

üëâ Toute violation de cette s√©paration est une **r√©gression architecturale**

Ce projet **n‚Äôest pas un outil marketing**.
C‚Äôest un **syst√®me de s√©curisation d√©cisionnelle** con√ßu pour :

- le **POST-REFUS** (client non sign√©)
- l‚Äô**ANTI-ANNULATION** (client sign√©)

üéØ Objectif unique : **CLOSING NET**

> Signer **ET** √©viter l‚Äôannulation J+7.

Aucune pression, aucune manipulation, aucune relance agressive.
Approche institutionnelle EDF, adapt√©e CSP+.

---

## üèóÔ∏è Architecture g√©n√©rale

### üîê Sch√©mas Supabase actifs

- `public`
- `cron`
- `net`
- `auth`
- `extensions`

---

### üóÑÔ∏è Tables critiques

#### `public.clients`

- Base prospects
- D√©doublonnage par email
- Source de v√©rit√© client

#### `public.studies`

- √âtudes techniques & financi√®res
- Statuts :
  - `draft`
  - `sent` (non sign√©)
  - `signed` (sign√©)
- Relation client via `client_id (UUID)`

#### `public.email_queue`

- File d‚Äôattente emails automatiques
- Champs cl√©s :
  - `email_type`
  - `scheduled_for`
  - `status`
  - `payload` (**non-null, contrainte volontaire**)

#### `public.tracking_events`

- Logs comportementaux :
  - `email_open`
  - `email_click`
  - `view_study`
- Utilis√©s uniquement via vues de synth√®se

---

### üîé Vues de pilotage (lecture seule)

#### `studies_activity_summary`

- Synth√®se comportementale par √©tude
- Ouvertures, interactions, derni√®re activit√©

#### `studies_to_watch`

- Vue de **surveillance intelligente**
- Peut √™tre vide (√©tat normal)
- Ne d√©clenche aucune action automatique

---

## üåê Services tiers

- **Supabase**

  - Base de donn√©es
  - Triggers
  - Cron jobs

- **Resend**

  - Envoi des emails
  - Domaine : `nicolas-distefano-edf.fr`

- **Vercel**
  - Dashboard
  - API emails
  - API tracking
  - Endpoint cron s√©curis√©

---

## üõ†Ô∏è Historique technique ‚Äî 3 janvier 2026

### A. Client de test (UPSERT)

````sql
INSERT INTO clients (...)
ON CONFLICT (email) DO UPDATE;

# üìã Documentation du Syst√®me de Gestion Client et Email Automatis√©

## üéØ Vue d'ensemble

Ce syst√®me est une plateforme de gestion de clients avec automatisation des emails, con√ßue sur **Supabase (PostgreSQL)** avec des fonctionnalit√©s de suivi et d'analyse.

### Fonctionnalit√©s principales
- ‚úÖ Gestion des clients et de leurs informations
- ‚úÖ Syst√®me d'envoi d'emails automatis√© avec file d'attente
- ‚úÖ Suivi des √©tudes (studies) par client
- ‚úÖ Logs et historique complet des emails
- ‚úÖ Syst√®me de tracking des √©v√©nements
- ‚úÖ Contrats sign√©s √©lectroniquement
- ‚úÖ Alertes et notifications

---

## üìä Architecture de la Base de Donn√©es

### Tables Principales

#### 1. **`clients`** - Gestion des Clients
Stocke les informations de base des clients.

**Colonnes principales :**
- `id` (uuid) - Identifiant unique
- `email` (text) - Email du client
- `phone` (text) - T√©l√©phone
- `first_name` (text) - Pr√©nom
- `last_name` (text) - Nom de famille
- `city` (text) - Ville
- `email_optout` (boolean) - Opt-out des emails
- `created_at` / `updated_at` - Horodatage

**Exemple :**
```sql
SELECT * FROM clients WHERE first_name = 'TOURNAY';
`````

---

#### 2. **`studies`** - √âtudes par Client

Chaque client peut avoir plusieurs √©tudes associ√©es.

**Colonnes principales :**

- `id` (uuid) - Identifiant unique de l'√©tude
- `client_id` (uuid) - R√©f√©rence au client
- `client_name` (text) - Nom du client (d√©normalis√©)
- `client_email` (text) - Email du client (d√©normalis√©)
- `expires_at` (timestamp) - Date d'expiration de l'√©tude
- `created_at` / `updated_at`

**Relations :**

- Un client ‚Üí plusieurs √©tudes (1:N)

**Exemple :**

```sql
-- Voir toutes les √©tudes d'un client
SELECT * FROM studies WHERE client_id = 'xxx-xxx-xxx';
```

---

#### 3. **`email_queue`** - File d'Attente d'Emails

G√®re l'envoi asynchrone des emails.

**Colonnes principales :**

- `id` (uuid) - Identifiant unique
- `client_id` (uuid) - Client destinataire
- `study_id` (uuid) - √âtude concern√©e
- `email_type` (text) - Type d'email (ex: `anti_j0_cash_deposit_request`)
- `status` (text) - Statut : `pending`, `sent`, `failed`
- `scheduled_for` (timestamp) - Date d'envoi pr√©vue
- `sent_at` (timestamp) - Date d'envoi r√©el
- `metadata` (jsonb) - Donn√©es suppl√©mentaires
- `payload` (jsonb) - Contenu de l'email
- `attempts` (integer) - Nombre de tentatives
- `last_error` (text) - Derni√®re erreur rencontr√©e
- `external_id` / `resend_id` - IDs externes

**Workflow :**

1. Un email est cr√©√© avec `status = 'pending'`
2. Un CRON job ou trigger le traite
3. Le statut passe √† `sent` ou `failed`
4. Un log est cr√©√© dans `email_logs`

**Exemple :**

```sql
-- Emails en attente
SELECT * FROM email_queue WHERE status = 'pending';

-- Emails envoy√©s aujourd'hui
SELECT * FROM email_queue
WHERE status = 'sent'
AND sent_at::date = CURRENT_DATE;
```

---

#### 4. **`email_logs`** - Historique des Emails

Logs de tous les emails envoy√©s (succ√®s et √©checs).

**Colonnes principales :**

- `id` (uuid)
- `client_id` (uuid)
- `client_email` (text) - Email du destinataire
- `status_code` (text) - Code de r√©ponse
- `response_body` (text) - R√©ponse du serveur
- `error_message` (text) - Message d'erreur
- `success` (boolean) - Succ√®s/√©chec
- `created_at`

**Exemple :**

```sql
-- Emails √©chou√©s
SELECT * FROM email_logs WHERE success = false;

-- Stats d'envoi
SELECT
  success,
  COUNT(*) as count
FROM email_logs
GROUP BY success;
```

---

#### 5. **`email_leads`** - Leads Email

Gestion des prospects et leads.

**Colonnes principales :**

- `id` (uuid)
- `client_id` (uuid)
- `source` (text) - Source du lead
- `email_step` (text) - √âtape dans le funnel
- `last_email_sent_at` (timestamp)
- `created_at` / `updated_at`

---

#### 6. **`tracking_events`** - √âv√©nements de Tracking

Suivi des actions et √©v√©nements li√©s aux √©tudes.

**Colonnes principales :**

- `id` (uuid)
- `study_id` (uuid) - √âtude concern√©e
- `event_type` (text) - Type d'√©v√©nement
- `metadata` (jsonb) - D√©tails de l'√©v√©nement
- `created_at`

**Exemple :**

```sql
-- √âv√©nements d'une √©tude
SELECT * FROM tracking_events
WHERE study_id = 'xxx-xxx-xxx'
ORDER BY created_at DESC;
```

---

#### 7. **`signed_contracts`** - Contrats Sign√©s

Gestion des contrats √©lectroniques sign√©s.

**Colonnes principales :**

- `id` (uuid)
- `client_id` (uuid)
- `created_at` / `updated_at`

---

#### 8. **`decision_logs`** - Logs de D√©cisions

Historique des d√©cisions prises par le syst√®me.

**Colonnes principales :**

- `id` (uuid)
- `client_id` (uuid)
- `created_at`

---

#### 9. **`email_templates`** - Templates d'Email

Templates r√©utilisables pour les emails.

**Exemple de types d'emails :**

- `anti_j0_cash_deposit_request` - Demande de d√©p√¥t anti-J0 cash
- Autres types selon configuration

---

#### 10. **`app_config`** - Configuration de l'Application

Param√®tres globaux de l'application.

---

#### 11. **`system_settings`** - Param√®tres Syst√®me

Configuration syst√®me et pr√©f√©rences.

---

### Vues (Views)

#### **`alerts_to_call`** - Vue des Alertes

Vue g√©n√©r√©e automatiquement regroupant les alertes n√©cessitant une action.

**Note :** Cette vue utilise `GROUP BY` et n'est pas directement modifiable.

---

#### **`studies_activity_summary`** et **`studies_activity_summary_v2`**

Vues de synth√®se de l'activit√© des √©tudes.

---

#### **`studies_to_watch`**

Vue des √©tudes n√©cessitant une surveillance.

---

## ‚öôÔ∏è Fonctionnalit√©s Automatis√©es

### 1. **Syst√®me d'Envoi d'Emails**

Le syst√®me utilise une architecture de file d'attente :

```
Client ‚Üí √âtude cr√©√©e ‚Üí Email ajout√© √† email_queue
‚Üí CRON/Trigger traite la queue ‚Üí Email envoy√©
‚Üí Log cr√©√© dans email_logs
```

**Types d'emails automatiques :**

- Demandes de d√©p√¥t
- Confirmations
- Rappels
- Notifications

### 2. **CRON Jobs**

Le syst√®me utilise `pg_cron` pour l'ex√©cution de t√¢ches planifi√©es :

- Traitement de la file d'attente d'emails
- Nettoyage des donn√©es expir√©es
- G√©n√©ration de rapports

**Voir les CRON jobs :**

```sql
SELECT * FROM cron.job;
```

### 3. **Triggers PostgreSQL**

Des triggers automatisent certaines actions :

- Cr√©ation automatique de logs
- Mise √† jour de timestamps
- Validation de donn√©es

### 4. **Fonctions PostgreSQL**

Fonctions personnalis√©es pour la logique m√©tier (sauvegard√©es dans `backup_all_functions_20260105`).

---

## üîí S√©curit√© et Permissions

### Row Level Security (RLS)

Supabase utilise RLS pour s√©curiser l'acc√®s aux donn√©es. Les policies d√©finissent qui peut voir/modifier quelles donn√©es.

**Voir les policies :**

```sql
SELECT * FROM pg_policies WHERE schemaname = 'public';
```

---

## üóÇÔ∏è Gestion des Backups

### Tables de Backup Existantes

Le syst√®me maintient des backups r√©guliers :

- `backup_clients_20260105`
- `backup_email_queue_20260105`
- `backup_email_logs_20260105`
- `backup_studies_20260105`
- `backup_all_functions_20260105`
- `backup_all_triggers_20260105`
- `backup_cron_jobs_20260105`
- etc.

### Cr√©er un Backup Manuel

```sql
-- Backup d'une table
CREATE TABLE backup_clients_YYYYMMDD AS
SELECT * FROM clients;

-- Backup des fonctions
CREATE TABLE backup_functions_YYYYMMDD AS
SELECT
    n.nspname as schema_name,
    p.proname as function_name,
    pg_get_functiondef(p.oid) as function_definition,
    now() as backup_date
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public';
```

### Restaurer depuis un Backup

```sql
-- Restaurer les donn√©es d'une table
INSERT INTO clients
SELECT * FROM backup_clients_20260105
WHERE id NOT IN (SELECT id FROM clients);
```

---

## üßπ Maintenance et Nettoyage

### Supprimer les Donn√©es de Test

**ATTENTION :** Ces commandes suppriment d√©finitivement des donn√©es !

```sql
-- 1. Identifier les clients de test
SELECT * FROM clients
WHERE LOWER(first_name) LIKE '%test%'
   OR LOWER(email) LIKE '%@example.com%';

-- 2. Supprimer les clients de test
DELETE FROM clients
WHERE LOWER(first_name) LIKE '%test%'
   OR LOWER(email) LIKE '%@example.com%';

-- 3. Nettoyer les donn√©es orphelines
DELETE FROM studies WHERE client_id NOT IN (SELECT id FROM clients);
DELETE FROM email_queue WHERE client_id NOT IN (SELECT id FROM clients);
DELETE FROM email_logs WHERE client_id NOT IN (SELECT id FROM clients);
DELETE FROM tracking_events WHERE study_id NOT IN (SELECT id FROM studies);
```

### Nettoyage Automatique

```sql
-- Supprimer les logs de plus de 90 jours
DELETE FROM email_logs
WHERE created_at < NOW() - INTERVAL '90 days';

-- Supprimer les emails √©chou√©s anciens
DELETE FROM email_queue
WHERE status = 'failed'
AND created_at < NOW() - INTERVAL '30 days';
```

---

## üìà Requ√™tes Utiles

### Statistiques Clients

```sql
-- Nombre total de clients
SELECT COUNT(*) as total_clients FROM clients;

-- Clients par ville
SELECT city, COUNT(*) as count
FROM clients
GROUP BY city
ORDER BY count DESC;

-- Clients ayant opt-out des emails
SELECT COUNT(*) FROM clients WHERE email_optout = true;
```

### Statistiques Emails

```sql
-- Emails envoy√©s aujourd'hui
SELECT COUNT(*) FROM email_queue
WHERE status = 'sent'
AND sent_at::date = CURRENT_DATE;

-- Taux de succ√®s des emails (derniers 7 jours)
SELECT
  ROUND(100.0 * SUM(CASE WHEN success THEN 1 ELSE 0 END) / COUNT(*), 2) as success_rate_percent
FROM email_logs
WHERE created_at > NOW() - INTERVAL '7 days';

-- Emails en attente par type
SELECT email_type, COUNT(*) as count
FROM email_queue
WHERE status = 'pending'
GROUP BY email_type;
```

### Analyse des √âtudes

```sql
-- √âtudes actives (non expir√©es)
SELECT COUNT(*) FROM studies
WHERE expires_at > NOW();

-- √âtudes par client
SELECT
  client_name,
  COUNT(*) as study_count
FROM studies
GROUP BY client_name
ORDER BY study_count DESC;

-- √âtudes arrivant √† expiration (prochains 7 jours)
SELECT * FROM studies
WHERE expires_at BETWEEN NOW() AND NOW() + INTERVAL '7 days'
ORDER BY expires_at;
```

---

## üöÄ D√©ploiement et Configuration

### Variables d'Environnement

Le syst√®me n√©cessite probablement :

- `SUPABASE_URL` - URL du projet Supabase
- `SUPABASE_ANON_KEY` - Cl√© publique
- `SUPABASE_SERVICE_KEY` - Cl√© service (backend)
- `EMAIL_PROVIDER_API_KEY` - Cl√© API du service d'email (Resend, SendGrid, etc.)

### Edge Functions

Les Edge Functions Supabase g√®rent la logique c√¥t√© serveur :

- Traitement des webhooks
- Envoi d'emails via API externe
- Validation de donn√©es
- Int√©grations tierces

---

## üîß D√©pannage

### Probl√®me : Emails non envoy√©s

```sql
-- V√©rifier les emails en erreur
SELECT * FROM email_queue
WHERE status = 'failed'
ORDER BY created_at DESC
LIMIT 10;

-- R√©essayer un email √©chou√©
UPDATE email_queue
SET status = 'pending', attempts = 0, last_error = NULL
WHERE id = 'xxx-xxx-xxx';
```

### Probl√®me : Donn√©es orphelines

```sql
-- Trouver les √©tudes sans client
SELECT * FROM studies
WHERE client_id NOT IN (SELECT id FROM clients);

-- Nettoyer
DELETE FROM studies
WHERE client_id NOT IN (SELECT id FROM clients);
```

### Probl√®me : CRON jobs ne s'ex√©cutent pas

```sql
-- V√©rifier les CRON jobs actifs
SELECT * FROM cron.job WHERE active = true;

-- Voir l'historique d'ex√©cution
SELECT * FROM cron.job_run_details
ORDER BY start_time DESC
LIMIT 20;
```

---

## üìù Conventions de Nommage

### Tables

- Pluriel en anglais : `clients`, `studies`, `emails`
- Snake_case : `email_logs`, `tracking_events`

### Colonnes

- Snake_case : `first_name`, `created_at`
- IDs : `id` (uuid) pour la cl√© primaire, `xxx_id` pour les cl√©s √©trang√®res

### Types d'Emails

- Format descriptif : `anti_j0_cash_deposit_request`
- Snake_case

---

## ‚ö†Ô∏è Bonnes Pratiques

### 1. **Toujours faire un backup avant modification**

```sql
CREATE TABLE backup_tablename_YYYYMMDD AS SELECT * FROM tablename;
```

### 2. **Tester les requ√™tes DELETE avec SELECT d'abord**

```sql
-- D'abord tester avec SELECT
SELECT * FROM clients WHERE condition;

-- Puis supprimer
DELETE FROM clients WHERE condition;
```

### 3. **Utiliser des transactions pour les modifications multiples**

```sql
BEGIN;
  DELETE FROM email_logs WHERE client_id = 'xxx';
  DELETE FROM email_queue WHERE client_id = 'xxx';
  DELETE FROM clients WHERE id = 'xxx';
COMMIT; -- ou ROLLBACK en cas d'erreur
```

### 4. **Surveiller les performances**

```sql
-- Voir les requ√™tes lentes
SELECT * FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 10;
```

---

## üìö Ressources

### Documentation Officielle

- [Supabase Documentation](https://supabase.com/docs)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [pg_cron Documentation](https://github.com/citusdata/pg_cron)

### Support

- Dashboard Supabase : `https://supabase.com/dashboard/project/ugwqfvwclwctzgtxcakp`
- SQL Editor : Pour ex√©cuter des requ√™tes
- Table Editor : Pour voir et modifier les donn√©es manuellement

---

## üéì Glossaire

- **UUID** : Identifiant unique universel (ex: `ea997cfd-3786-428b-8936-b577b5dbf08b`)
- **JSONB** : Format JSON binaire dans PostgreSQL
- **RLS** : Row Level Security - S√©curit√© au niveau des lignes
- **CRON** : T√¢ches planifi√©es
- **Trigger** : Fonction automatique d√©clench√©e par un √©v√©nement
- **View** : Vue virtuelle g√©n√©r√©e √† partir de requ√™tes
- **Edge Function** : Fonction serverless h√©berg√©e sur Supabase

---

## ‚úÖ Checklist de Maintenance Mensuelle

- [ ] V√©rifier les CRON jobs actifs
- [ ] Nettoyer les logs de plus de 90 jours
- [ ] V√©rifier les √©tudes expir√©es
- [ ] Cr√©er un backup complet
- [ ] Analyser le taux de succ√®s des emails
- [ ] V√©rifier les donn√©es orphelines
- [ ] Optimiser les index si n√©cessaire
- [ ] V√©rifier l'espace disque utilis√©

---

**Derni√®re mise √† jour :** 5 janvier 2026  
**Version :** 1.0  
**Projet Supabase :** `ugwqfvwclwctzgtxcakp`
